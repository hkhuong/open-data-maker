<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Open-data-maker</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.10.2/application.js' type='text/javascript'></script>    
    <link href='./assets/0.10.2/application.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="./assets/0.10.2/favicon_yellow.png" />
    <link rel="icon" type="image/png" href="./assets/0.10.2/favicon.png" />
  </head>
  
  <body>
    <div id="loading">
      <img src="./assets/0.10.2/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" style="display:none;">
      <div class="timestamp">Generated <abbr class="timeago" title="2019-10-03T12:56:13-04:00">2019-10-03T12:56:13-04:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent"><span class="yellow">89.69%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         404.72
       </span>
    </span> hits/line)
  </h2>
  <a name="AllFiles"></a>
  <div>
    <b>56</b> files in total.
    <b>2979</b> relevant lines. 
    <span class="green"><b>2672</b> lines covered</span> and
    <span class="red"><b>307</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#217160f71464c2231be1834b19874dc98d24a854" class="src_link" title="app/app.rb">app/app.rb</a></td>
        <td class="red strong">66.67 %</td>
        <td>31</td>
        <td>15</td>
        <td>10</td>
        <td>5</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9b25d4544a048dc56c46c25126b334fd3f308f2c" class="src_link" title="config/apps.rb">config/apps.rb</a></td>
        <td class="red strong">77.78 %</td>
        <td>45</td>
        <td>9</td>
        <td>7</td>
        <td>2</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#942d5963de2974950fba96ddf043f5cfc149e6b5" class="src_link" title="config/boot.rb">config/boot.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>39</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a9aad107cc617450341bb36182415761ea037432" class="src_link" title="config/env.rb">config/env.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>16</td>
        <td>9</td>
        <td>9</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#431a7d01459ac1fa209d485930607e7230c5d502" class="src_link" title="lib/data_magic.rb">lib/data_magic.rb</a></td>
        <td class="red strong">69.91 %</td>
        <td>471</td>
        <td>226</td>
        <td>158</td>
        <td>68</td>
        <td>67.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d7ff520cf2596cb16c3737abee7448050dfdc32c" class="src_link" title="lib/data_magic/category.rb">lib/data_magic/category.rb</a></td>
        <td class="red strong">22.22 %</td>
        <td>12</td>
        <td>9</td>
        <td>2</td>
        <td>7</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d1862391aca8f7acf6ecdbdb30a9f9b947d83d0b" class="src_link" title="lib/data_magic/config.rb">lib/data_magic/config.rb</a></td>
        <td class="yellow strong">88.45 %</td>
        <td>515</td>
        <td>277</td>
        <td>245</td>
        <td>32</td>
        <td>515.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#034378574ccca7de81c52d7ae68570adc87d6397" class="src_link" title="lib/data_magic/error_checker.rb">lib/data_magic/error_checker.rb</a></td>
        <td class="green strong">97.06 %</td>
        <td>144</td>
        <td>68</td>
        <td>66</td>
        <td>2</td>
        <td>30.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#caea3bc38c4dd443d3ced1d24303f948e415b0c7" class="src_link" title="lib/data_magic/example.rb">lib/data_magic/example.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>16</td>
        <td>11</td>
        <td>11</td>
        <td>0</td>
        <td>1.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c0fc89e1152c97276029748de56be148d1d5a742" class="src_link" title="lib/data_magic/index.rb">lib/data_magic/index.rb</a></td>
        <td class="green strong">95.19 %</td>
        <td>159</td>
        <td>104</td>
        <td>99</td>
        <td>5</td>
        <td>59.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#35b717c1edcd06b1b47636b28feb351606b5ca2e" class="src_link" title="lib/data_magic/index/builder_data.rb">lib/data_magic/index/builder_data.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>25</td>
        <td>14</td>
        <td>14</td>
        <td>0</td>
        <td>760.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9bc50df13874dc21f61f78dde20c8f9ca1a3933f" class="src_link" title="lib/data_magic/index/document.rb">lib/data_magic/index/document.rb</a></td>
        <td class="green strong">90.48 %</td>
        <td>39</td>
        <td>21</td>
        <td>19</td>
        <td>2</td>
        <td>809.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#70145ea163116afe5cb1f77589249bcd9e96e8aa" class="src_link" title="lib/data_magic/index/document_builder.rb">lib/data_magic/index/document_builder.rb</a></td>
        <td class="green strong">92.24 %</td>
        <td>205</td>
        <td>116</td>
        <td>107</td>
        <td>9</td>
        <td>4660.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7324573adfc5afa786d1c06a1aa58d5b4a1b61a7" class="src_link" title="lib/data_magic/index/event_logger.rb">lib/data_magic/index/event_logger.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>28</td>
        <td>14</td>
        <td>14</td>
        <td>0</td>
        <td>241.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#40e43bd22105715bf5fe1a52844f9bf309b1a771" class="src_link" title="lib/data_magic/index/importer.rb">lib/data_magic/index/importer.rb</a></td>
        <td class="red strong">69.3 %</td>
        <td>204</td>
        <td>114</td>
        <td>79</td>
        <td>35</td>
        <td>352.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d65375660cca9580f56d900f548b196047c386f9" class="src_link" title="lib/data_magic/index/output.rb">lib/data_magic/index/output.rb</a></td>
        <td class="red strong">70.59 %</td>
        <td>62</td>
        <td>34</td>
        <td>24</td>
        <td>10</td>
        <td>240.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#accbf4558c410d11472a43f2cfbf22781eb248ea" class="src_link" title="lib/data_magic/index/repository.rb">lib/data_magic/index/repository.rb</a></td>
        <td class="red strong">50.88 %</td>
        <td>124</td>
        <td>57</td>
        <td>29</td>
        <td>28</td>
        <td>335.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ba94503355ea8a8fea823fcfcabb083e5fd9bd4c" class="src_link" title="lib/data_magic/index/row_bulk_importer.rb">lib/data_magic/index/row_bulk_importer.rb</a></td>
        <td class="red strong">45.24 %</td>
        <td>73</td>
        <td>42</td>
        <td>19</td>
        <td>23</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f8eb249d34fbdd010dcf185b342f1f11ba9549a4" class="src_link" title="lib/data_magic/index/row_importer.rb">lib/data_magic/index/row_importer.rb</a></td>
        <td class="green strong">92.86 %</td>
        <td>73</td>
        <td>42</td>
        <td>39</td>
        <td>3</td>
        <td>1288.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3b7d0645eeb54fd542a7fb2154071259e27f7084" class="src_link" title="lib/data_magic/index/row_map.rb">lib/data_magic/index/row_map.rb</a></td>
        <td class="green strong">93.33 %</td>
        <td>28</td>
        <td>15</td>
        <td>14</td>
        <td>1</td>
        <td>122.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#138028bf9adf29470920d1e39c2b03dc5afebb4e" class="src_link" title="lib/data_magic/index/super_client.rb">lib/data_magic/index/super_client.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>46</td>
        <td>24</td>
        <td>24</td>
        <td>0</td>
        <td>499.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#675f8943c06ee5538f405cb43bf80ea0c8f67c0e" class="src_link" title="lib/data_magic/query_builder.rb">lib/data_magic/query_builder.rb</a></td>
        <td class="red strong">63.27 %</td>
        <td>410</td>
        <td>196</td>
        <td>124</td>
        <td>72</td>
        <td>28.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#77bff3ab847a1af317d3fc9f18af280e003a446e" class="src_link" title="lib/expression/eval.rb">lib/expression/eval.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>17</td>
        <td>8</td>
        <td>8</td>
        <td>0</td>
        <td>11.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b52dd238c5d4a115d3c782c56aba486e4d18a9af" class="src_link" title="lib/expression/expression.rb">lib/expression/expression.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>25</td>
        <td>17</td>
        <td>17</td>
        <td>0</td>
        <td>6.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2ec554d225e49cff5c98675bd7b6faee22e36c62" class="src_link" title="lib/expression/parser.rb">lib/expression/parser.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>47</td>
        <td>16</td>
        <td>16</td>
        <td>0</td>
        <td>15.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0587cf3e9eac301ec534f180c2adfeda0edd584f" class="src_link" title="lib/expression/variables.rb">lib/expression/variables.rb</a></td>
        <td class="yellow strong">88.89 %</td>
        <td>17</td>
        <td>9</td>
        <td>8</td>
        <td>1</td>
        <td>4.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7bf6bf19af5d715f246e7831a915ff4deb9799cf" class="src_link" title="lib/nested_hash.rb">lib/nested_hash.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>66</td>
        <td>38</td>
        <td>38</td>
        <td>0</td>
        <td>4107.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#12a6b7059b0a5598c3d8de085332d57991ca14bd" class="src_link" title="lib/sass_initializer.rb">lib/sass_initializer.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>11</td>
        <td>6</td>
        <td>6</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#fe2c681fa39056b6dd6a76894f79079ffca79a53" class="src_link" title="lib/zipcode/zipcode.rb">lib/zipcode/zipcode.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>37</td>
        <td>19</td>
        <td>19</td>
        <td>0</td>
        <td>8802.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#583c416ab17440806c5ebf0c7edbff50b09e2feb" class="src_link" title="spec/fixtures/data.rb">spec/fixtures/data.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>34</td>
        <td>8</td>
        <td>8</td>
        <td>0</td>
        <td>1.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c42f66a681c48505c7e50e316688260dd06da79d" class="src_link" title="spec/lib/data_magic/config_field_types_spec.rb">spec/lib/data_magic/config_field_types_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>88</td>
        <td>34</td>
        <td>34</td>
        <td>0</td>
        <td>1.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d51bf473ab31d58e71e962bc8c987475de65f251" class="src_link" title="spec/lib/data_magic/config_spec.rb">spec/lib/data_magic/config_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>186</td>
        <td>90</td>
        <td>90</td>
        <td>0</td>
        <td>1.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#96bf5c8908f7fe8f297fdc325ad2a70a97b8bba4" class="src_link" title="spec/lib/data_magic/create_index_spec.rb">spec/lib/data_magic/create_index_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>62</td>
        <td>36</td>
        <td>36</td>
        <td>0</td>
        <td>1.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1cf1f36cd0aa8727df731fff8c6c8cdf4e4cd9fd" class="src_link" title="spec/lib/data_magic/error_checker_spec.rb">spec/lib/data_magic/error_checker_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>343</td>
        <td>145</td>
        <td>145</td>
        <td>0</td>
        <td>2.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ca8f658de1ed4cbb60e7dccd841652694e37bacd" class="src_link" title="spec/lib/data_magic/example_spec.rb">spec/lib/data_magic/example_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>28</td>
        <td>15</td>
        <td>15</td>
        <td>0</td>
        <td>1.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d232bb8f62a2e00e09f9324db3d895d9c92c3072" class="src_link" title="spec/lib/data_magic/import_csv_spec.rb">spec/lib/data_magic/import_csv_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>31</td>
        <td>17</td>
        <td>17</td>
        <td>0</td>
        <td>1.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e7415348c27d36dbc608a7841bdd3f2356b64dd9" class="src_link" title="spec/lib/data_magic/import_with_delta_file_spec.rb">spec/lib/data_magic/import_with_delta_file_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>76</td>
        <td>48</td>
        <td>48</td>
        <td>0</td>
        <td>3.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3f77fe3eff45c463a743c173a867dbaad6c3b5c3" class="src_link" title="spec/lib/data_magic/import_with_dictionary_spec.rb">spec/lib/data_magic/import_with_dictionary_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>214</td>
        <td>123</td>
        <td>123</td>
        <td>0</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5fff33c30704d50a8417dea210eba5f9b58f4c9c" class="src_link" title="spec/lib/data_magic/import_with_nested_files_spec.rb">spec/lib/data_magic/import_with_nested_files_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>65</td>
        <td>43</td>
        <td>43</td>
        <td>0</td>
        <td>2.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#57de3292e638f0c2081836c231c27c2480573f90" class="src_link" title="spec/lib/data_magic/import_without_data_yaml_spec.rb">spec/lib/data_magic/import_without_data_yaml_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>81</td>
        <td>34</td>
        <td>34</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#eb4c367899f225d615de147bac4192ae09c830b6" class="src_link" title="spec/lib/data_magic/index/document_builder_spec.rb">spec/lib/data_magic/index/document_builder_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>337</td>
        <td>177</td>
        <td>177</td>
        <td>0</td>
        <td>2.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2fa7f97e46e2f79f242b8ed8d565af54f969a202" class="src_link" title="spec/lib/data_magic/index/document_spec.rb">spec/lib/data_magic/index/document_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>70</td>
        <td>37</td>
        <td>37</td>
        <td>0</td>
        <td>1.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f0fc33dfe802bb35ff687f50cc9ae181ef002297" class="src_link" title="spec/lib/data_magic/index/event_logger_spec.rb">spec/lib/data_magic/index/event_logger_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>40</td>
        <td>25</td>
        <td>25</td>
        <td>0</td>
        <td>1.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c897101e5d90cdd1bbb2e71668d002476b9adc2a" class="src_link" title="spec/lib/data_magic/index/importer_spec.rb">spec/lib/data_magic/index/importer_spec.rb</a></td>
        <td class="yellow strong">86.67 %</td>
        <td>26</td>
        <td>15</td>
        <td>13</td>
        <td>2</td>
        <td>0.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1965cfdcba8558120fbe2c8e98816481b76c05ed" class="src_link" title="spec/lib/data_magic/index/repository_spec.rb">spec/lib/data_magic/index/repository_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>85</td>
        <td>44</td>
        <td>44</td>
        <td>0</td>
        <td>1.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#81b8a5b5a27d7dec7688b43dd4b7fbba0f64328d" class="src_link" title="spec/lib/data_magic/name_type_spec.rb">spec/lib/data_magic/name_type_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>42</td>
        <td>25</td>
        <td>25</td>
        <td>0</td>
        <td>1.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cbb5157f074f3dbfbe053bb664eeed92603ae518" class="src_link" title="spec/lib/data_magic/query_builder_spec.rb">spec/lib/data_magic/query_builder_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>230</td>
        <td>123</td>
        <td>123</td>
        <td>0</td>
        <td>5.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7f57aa44ce5e0a5161da83002f3bc841cc162f87" class="src_link" title="spec/lib/data_magic/search_name_spec.rb">spec/lib/data_magic/search_name_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>132</td>
        <td>76</td>
        <td>76</td>
        <td>0</td>
        <td>3.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ec59512575be415b9557a0a2edd07c90eace8194" class="src_link" title="spec/lib/data_magic/search_spec.rb">spec/lib/data_magic/search_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>300</td>
        <td>181</td>
        <td>181</td>
        <td>0</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9a2af29fc7ecc6b7cc1103c8fd5a206317049547" class="src_link" title="spec/lib/data_magic_spec.rb">spec/lib/data_magic_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>29</td>
        <td>14</td>
        <td>14</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a20fab4f62864089502396cef26d4dbeae03e175" class="src_link" title="spec/lib/expression/eval_spec.rb">spec/lib/expression/eval_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>49</td>
        <td>20</td>
        <td>20</td>
        <td>0</td>
        <td>1.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bac0faaf696059efcc5db4def53696ba509044dc" class="src_link" title="spec/lib/expression/parser_spec.rb">spec/lib/expression/parser_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>50</td>
        <td>19</td>
        <td>19</td>
        <td>0</td>
        <td>1.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4d2e47f79f36647cf03c56ffd1ff8d6ade65ae18" class="src_link" title="spec/lib/expression/variables_spec.rb">spec/lib/expression/variables_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>18</td>
        <td>11</td>
        <td>11</td>
        <td>0</td>
        <td>1.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#fb15b53c804ff9c793ff43bf6053e35ec1f833b4" class="src_link" title="spec/lib/expression_spec.rb">spec/lib/expression_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>58</td>
        <td>38</td>
        <td>38</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d01aed90f68fb150de92ef19e4ff4c654089e26f" class="src_link" title="spec/lib/nested_hash_spec.rb">spec/lib/nested_hash_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>62</td>
        <td>34</td>
        <td>34</td>
        <td>0</td>
        <td>1.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#538c359bded5e883c1e33bcac0d099d02800ad1c" class="src_link" title="spec/lib/zipcode_spec.rb">spec/lib/zipcode_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>21</td>
        <td>13</td>
        <td>13</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
    </tbody>
  </table>
</div>


        
      </div>
    
      <div id="footer">
        Generated by <a href="http://github.com/colszowka/simplecov">simplecov</a> v0.17.1 
        and simplecov-html v0.10.2<br/>
        using RSpec
      </div>
    
      <div class="source_files">
      
        <div class="source_table" id="217160f71464c2231be1834b19874dc98d24a854">
  <div class="header">
    <h3>app/app.rb</h3>
    <h4><span class="red">66.67 %</span> covered</h4>
    <div>
      <b>15</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module OpenDataMaker</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  class App &lt; Padrino::Application</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    register SassInitializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    register Padrino::Helpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    # This app is stateless and session cookies prevent caching of API responses</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    disable :sessions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    # This app has no sensitive bits and csrf protection requires sessions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    disable :protect_from_csrf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    if ENV[&#39;DATA_AUTH&#39;] and not ENV[&#39;DATA_AUTH&#39;].empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      auth = ENV[&#39;DATA_AUTH&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      authorized_user, authorized_pass = auth.split(&#39;,&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      use Rack::Auth::Basic, &quot;Restricted Area&quot; do |username, password|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        username == authorized_user and password == authorized_pass</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    ## app setup</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    if ENV[&#39;RACK_ENV&#39;] == &#39;test&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      DataMagic.init(load_now: false)   # don&#39;t index data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9b25d4544a048dc56c46c25126b334fd3f308f2c">
  <div class="header">
    <h3>config/apps.rb</h3>
    <h4><span class="red">77.78 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># This file mounts each app in the Padrino project to a specified sub-uri.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># You can mount additional applications using any of these commands below:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#   Padrino.mount(&#39;blog&#39;).to(&#39;/blog&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#   Padrino.mount(&#39;blog&#39;, :app_class =&gt; &#39;BlogApp&#39;).to(&#39;/blog&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#   Padrino.mount(&#39;blog&#39;, :app_file =&gt;  &#39;path/to/blog/app.rb&#39;).to(&#39;/blog&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"># You can also map apps to a specified host:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">#   Padrino.mount(&#39;Admin&#39;).host(&#39;admin.example.org&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">#   Padrino.mount(&#39;WebSite&#39;).host(/.*\.?example.org/)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#   Padrino.mount(&#39;Foo&#39;).to(&#39;/foo&#39;).host(&#39;bar.example.org&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"># Note 1: Mounted apps (by default) should be placed into the project root at &#39;/app_name&#39;.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"># Note 2: If you use the host matching remember to respect the order of the rules.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"># By default, this file mounts the primary app which was generated with this project.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"># However, the mounted app can be modified as needed:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">#   Padrino.mount(&#39;AppName&#39;, :app_file =&gt; &#39;path/to/file&#39;, :app_class =&gt; &#39;BlogApp&#39;).to(&#39;/&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"># Setup global project settings for your apps. These settings are inherited by every subapp. You can</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"># override these settings in the subapps as needed.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">Padrino.configure_apps do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  # enable :sessions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  set :session_secret, &#39;ffb8bfc2d71e2ad938950169de2757ab7b73b1cd5fbf91b4b912ae493dc5b70f&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  set :protection, :except =&gt; :path_traversal</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  set :protect_from_csrf, true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  set :allow_origin, :any</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"># If needed, mount the app that does indexing</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">if ENV[&#39;INDEX_APP&#39;] == &quot;enable&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">  puts &quot;mounting index app&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">  Padrino.mount(&#39;OpenDataMaker::IndexApp&#39;, :app_file =&gt; Padrino.root(&#39;app/index_app.rb&#39;)).to(&#39;/index&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"># Mounts the core application for this project</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">Padrino.mount(&#39;OpenDataMaker::App&#39;, :app_file =&gt; Padrino.root(&#39;app/app.rb&#39;)).to(&#39;/&#39;)</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="942d5963de2974950fba96ddf043f5cfc149e6b5">
  <div class="header">
    <h3>config/boot.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;env.rb&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># ## Enable devel logging</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"># Padrino::Logger::Config[:development][:log_level]  = :devel</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"># Padrino::Logger::Config[:development][:log_static] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"># ## Configure your I18n</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"># I18n.default_locale = :en</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"># I18n.enforce_available_locales = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"># ## Configure your HTML5 data helpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"># Padrino::Helpers::TagHelpers::DATA_ATTRIBUTES.push(:dialog)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"># text_field :foo, :dialog =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"># Generates: &lt;input type=&quot;text&quot; data-dialog=&quot;true&quot; name=&quot;foo&quot; /&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"># ## Add helpers to mailer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"># Mail::Message.class_eval do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">#   include Padrino::Helpers::NumberHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">#   include Padrino::Helpers::TranslationHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"># end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"># Add your before (RE)load hooks here</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">Padrino.before_load do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"># Add your after (RE)load hooks here</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">Padrino.after_load do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">Padrino.load!</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a9aad107cc617450341bb36182415761ea037432">
  <div class="header">
    <h3>config/env.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># define core environment that we need in tests and for the app</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Defines our constants</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">ENV[&#39;RACK_ENV&#39;] ||= &#39;development&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">RACK_ENV          = ENV[&#39;RACK_ENV&#39;] unless defined?(RACK_ENV)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">PADRINO_ROOT      = File.expand_path(&#39;../..&#39;, __FILE__) unless defined?(PADRINO_ROOT)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"># Load our dependencies</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;rubygems&#39; unless defined?(Gem)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;bundler/setup&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;newrelic_rpm&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">Bundler.require(:default, RACK_ENV)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"># do this early so we can log during startup</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;./lib/data_magic/config.rb&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">DataMagic::Config.logger=Logger.new(STDOUT) if ENV[&#39;VCAP_APPLICATION&#39;]    # Cloud Foundry</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="431a7d01459ac1fa209d485930607e7230c5d502">
  <div class="header">
    <h3>lib/data_magic.rb</h3>
    <h4><span class="red">69.91 %</span> covered</h4>
    <div>
      <b>226</b> relevant lines. 
      <span class="green"><b>158</b> lines covered</span> and
      <span class="red"><b>68</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;typhoeus&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;typhoeus/adapters/faraday&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;elasticsearch&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;safe_yaml&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;stretchy&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;hashie&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;./lib/nested_hash&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;aws-sdk&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;uri&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;cf-app-utils&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;logger&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;set&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;data_magic/config&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;data_magic/index&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;data_magic/query_builder&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;data_magic/error_checker&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;zipcode/zipcode&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">SafeYAML::OPTIONS[:default_mode] = :safe</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">class IndifferentHash &lt; Hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  include Hashie::Extensions::MergeInitializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  include Hashie::Extensions::IndifferentAccess</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">module DataMagic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  class &lt;&lt; self</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :config</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    def logger</code>
        </li>
      
        <li class="covered" data-hits="1632" data-linenumber="32">
          <span class="hits">1632</span>
          
          <code class="ruby">      Config.logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  DEFAULT_PAGE_SIZE = 20</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  MAX_PAGE_SIZE = 100</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  DEFAULT_EXTENSIONS = [&#39;.csv&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  DEFAULT_PATH = &#39;./sample-data&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  class InvalidData &lt; StandardError</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  class InvalidDictionary &lt; StandardError</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.s3</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="46">
          <span class="hits">49</span>
          
          <code class="ruby">    if @s3.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      s3cred = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      if ENV[&#39;VCAP_APPLICATION&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">        s3cred = ::CF::App::Credentials.find_by_service_name(ENV[&#39;s3_bucket_service&#39;] || &#39;bservice&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">        s3cred = {&#39;access_key&#39;=&gt;  ENV[&#39;s3_access_key&#39;], &#39;secret_key&#39; =&gt; ENV[&#39;s3_secret_key&#39;], &#39;region&#39; =&gt; ENV[&#39;s3_region&#39;]}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      # logger.info &quot;s3cred = #{s3cred.inspect}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      if ENV[&#39;RACK_ENV&#39;] != &#39;test&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        s3_access_key = s3cred[&#39;access_key&#39;] || s3cred[&#39;access_key_id&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">        s3_secret_key = s3cred[&#39;secret_key&#39;] || s3cred[&#39;secret_access_key&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        ::Aws.config[:credentials] = ::Aws::Credentials.new(s3_access_key, s3_secret_key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      ::Aws.config[:region] = s3cred[&#39;region&#39;] || &#39;us-east-1&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      @s3 = ::Aws::S3::Client.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      # logger.info &quot;@s3 = #{@s3.inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="63">
          <span class="hits">49</span>
          
          <code class="ruby">    @s3</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  #  logger.info &quot;response: #{response.inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  #========================================================================</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  #   Public Class Methods</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  #========================================================================</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  # thin layer on elasticsearch query</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.search(terms, options = {})</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="73">
          <span class="hits">71</span>
          
          <code class="ruby">    terms = IndifferentHash.new(terms)</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="74">
          <span class="hits">71</span>
          
          <code class="ruby">    errors = ErrorChecker.check(terms, options, config)</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="75">
          <span class="hits">71</span>
          
          <code class="ruby">    return { errors: errors } if errors.length &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="77">
          <span class="hits">71</span>
          
          <code class="ruby">    query_body = QueryBuilder.from_params(terms, options, config)</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="78">
          <span class="hits">71</span>
          
          <code class="ruby">    result_processing_info = query_body[:post_es_response]</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="79">
          <span class="hits">71</span>
          
          <code class="ruby">    query_body.delete(:post_es_response)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="81">
          <span class="hits">71</span>
          
          <code class="ruby">    index_name = index_name_from_options(options)</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="82">
          <span class="hits">71</span>
          
          <code class="ruby">    logger.info &quot;search terms:#{terms.inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    full_query = {</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="85">
          <span class="hits">71</span>
          
          <code class="ruby">      index: index_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      type: &#39;document&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">      body: query_body</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    # Per https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-body.html:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    # &quot;the search_type and the query_cache must be passed as query-string parameters&quot;</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="92">
          <span class="hits">71</span>
          
          <code class="ruby">    if options[:command] == &#39;stats&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="93">
          <span class="hits">2</span>
          
          <code class="ruby">      full_query.merge! :search_type =&gt; &#39;count&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="96">
          <span class="hits">71</span>
          
          <code class="ruby">    logger.info &quot;FULL_QUERY: #{full_query.inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="98">
          <span class="hits">71</span>
          
          <code class="ruby">    time_start = Time.now.to_f</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="99">
          <span class="hits">71</span>
          
          <code class="ruby">    result = client.search full_query</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="101">
          <span class="hits">71</span>
          
          <code class="ruby">    search_time = Time.now.to_f - time_start</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="102">
          <span class="hits">71</span>
          
          <code class="ruby">    logger.info &quot;ES query time (ms): #{result[&quot;took&quot;]} ; Query fetch time (s): #{search_time} ; result: #{result.inspect[0..500]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    # Everything after this is aimed at processing the results from ES for the browser </code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="105">
          <span class="hits">71</span>
          
          <code class="ruby">    hits = result[&quot;hits&quot;]</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="106">
          <span class="hits">71</span>
          
          <code class="ruby">    total = hits[&quot;total&quot;]</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="107">
          <span class="hits">71</span>
          
          <code class="ruby">    results = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    # Before processing result, check if the full_query includes a nested query</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="110">
          <span class="hits">71</span>
          
          <code class="ruby">    includes_nested_query = false</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="111">
          <span class="hits">71</span>
          
          <code class="ruby">    nested_query_type = &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="112">
          <span class="hits">71</span>
          
          <code class="ruby">    if result_processing_info[:nested_type].is_a?(String)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">      includes_nested_query = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">      nested_query_type = result_processing_info[:nested_type]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    # Collect list of nested fields that need to be filtered</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    # This is neccessary because the standard ES fields filter creates arrays from nested data, which we don&#39;t want</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="119">
          <span class="hits">71</span>
          
          <code class="ruby">    nested_fields_filter = result_processing_info[:nested_fields_filter] ? result_processing_info[:nested_fields_filter] : []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="121">
          <span class="hits">71</span>
          
          <code class="ruby">    if query_body.dig(:_source).class == Hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">      # we&#39;re getting the whole document and we can find in _source</code>
        </li>
      
        <li class="covered" data-hits="344" data-linenumber="123">
          <span class="hits">344</span>
          
          <code class="ruby">      results = hits[&quot;hits&quot;].map {|hit| hit[&quot;_source&quot;]}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">      # Tested - implementation of nested vs dotted option - when line below is exposed, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">      # and &amp;keys_nested=true is in query, I get Error: JSON::NestingError - nesting of 100 is too deep</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">      # results = options[:keys_nested] ? NestedHash.new(results) : results</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="129">
          <span class="hits">30</span>
          
          <code class="ruby">      results = hits[&quot;hits&quot;].map do |hit|</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="130">
          <span class="hits">50</span>
          
          <code class="ruby">        found = hit.fetch(&quot;fields&quot;, {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">        # Unless a query term is also a nested data type, fields requested for a nested_data_type are defined under _source</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="133">
          <span class="hits">50</span>
          
          <code class="ruby">        from_source = hit.fetch(&quot;_source&quot;, {})</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="134">
          <span class="hits">50</span>
          
          <code class="ruby">        dotted_from_source = NestedHash.new.withdotkeys(from_source)</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="135">
          <span class="hits">50</span>
          
          <code class="ruby">        found = found.merge(dotted_from_source)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">        # When an inner query is submitted, the nested data_type fields are under inner_hits</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="138">
          <span class="hits">50</span>
          
          <code class="ruby">        inner = hit.fetch(&quot;inner_hits&quot;, {})</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="139">
          <span class="hits">50</span>
          
          <code class="ruby">        delete_set = Set[]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="141">
          <span class="hits">50</span>
          
          <code class="ruby">        delete_set.each { |k| found.delete k }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">        # each result looks like this:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">        # {&quot;city&quot;=&gt;[&quot;Springfield&quot;], &quot;address&quot;=&gt;[&quot;742 Evergreen Terrace&quot;], &quot;children&quot; =&gt; [{...}, {...}, {...}] }</code>
        </li>
      
        <li class="covered" data-hits="103" data-linenumber="145">
          <span class="hits">103</span>
          
          <code class="ruby">        found.keys.each { |key| found[key] = found[key].length &gt; 1 ? found[key] : found[key][0] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">        # now it should look like this:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">        # {&quot;city&quot;=&gt;&quot;Springfield&quot;, &quot;address&quot;=&gt;&quot;742 Evergreen Terrace, &quot;children&quot; =&gt; [{...}, {...}, {...}]}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">        # re-insert null fields that didn&#39;t get returned by ES</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="150">
          <span class="hits">50</span>
          
          <code class="ruby">        if query_body[:fields]</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="151">
          <span class="hits">50</span>
          
          <code class="ruby">          query_body[:fields].each do |field|</code>
        </li>
      
        <li class="covered" data-hits="55" data-linenumber="152">
          <span class="hits">55</span>
          
          <code class="ruby">            if !(found.has_key?(field) || found.has_key?(field.to_s)) &amp;&amp; !delete_set.include?(field || field.to_s)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="153">
          <span class="hits">2</span>
          
          <code class="ruby">              found[field] = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">        # Collect inner hits</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="159">
          <span class="hits">50</span>
          
          <code class="ruby">        nested_details_hash = {}</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="160">
          <span class="hits">50</span>
          
          <code class="ruby">        if !inner.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">          inner.keys.each do |inn_key|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">            inner_details = inner[inn_key][&quot;hits&quot;][&quot;hits&quot;].map do |nested_obj|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">              details = nested_obj.fetch(&quot;_source&quot;, {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">              n_hash = NestedHash.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">              </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">              details.keys.each do |key|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">                n_hash[key] = details[key]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">              # Convert to dotted keys</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">              n_hash = n_hash.withdotkeys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">              # If there is a fields filter for nested datatypes, apply it here</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">              if !nested_fields_filter.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">                keys_to_keep = nested_fields_filter.select { |f| f.start_with? inn_key }.map do |n|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">                  n.gsub(inn_key + &quot;.&quot;,&quot;&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">                n_hash_filtered = n_hash.select { |k| keys_to_keep.include?(k) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">              !n_hash_filtered.nil? ? n_hash_filtered : n_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">            # Set the nested data type string as the key and the array of inner hits as the value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">            nested_details_hash[inn_key] = inner_details</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">        # If nested hits, combine with other fields in found hash</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="189">
          <span class="hits">50</span>
          
          <code class="ruby">        if !nested_details_hash.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">          found = found.merge(nested_details_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">        # If keys_nested option passed in params, then return result keys in nested format</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">        # Default setting is to return results with dotted keys</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="195">
          <span class="hits">50</span>
          
          <code class="ruby">        found = options[:keys_nested] ? NestedHash.new(found) : found</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="197">
          <span class="hits">50</span>
          
          <code class="ruby">        found</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">    metadata = {</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="202">
          <span class="hits">71</span>
          
          <code class="ruby">      &quot;total&quot; =&gt; total,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">      &quot;page&quot; =&gt; query_body[:from] / query_body[:size],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">      &quot;per_page&quot; =&gt; query_body[:size]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="206">
          <span class="hits">71</span>
          
          <code class="ruby">    if options[:debug]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">      metadata[&quot;search_time&quot;] = search_time</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">      metadata[&quot;ES_took_ms&quot;] = result[&quot;took&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">    # assemble a simpler json document to return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">    simple_result =</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="214">
          <span class="hits">71</span>
          
          <code class="ruby">      &quot;metadata&quot; =&gt; metadata,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">      &quot;results&quot; =&gt; 	results</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="218">
          <span class="hits">71</span>
          
          <code class="ruby">    if options[:command] == &#39;stats&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">      # Remove metrics that weren&#39;t requested.</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="220">
          <span class="hits">2</span>
          
          <code class="ruby">      aggregations = result[&#39;aggregations&#39;] || {}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="221">
          <span class="hits">2</span>
          
          <code class="ruby">      aggregations.each do |f_name, values|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="222">
          <span class="hits">4</span>
          
          <code class="ruby">        if options[:metrics] &amp;&amp; options[:metrics].size &gt; 0</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="223">
          <span class="hits">20</span>
          
          <code class="ruby">          aggregations[f_name] = values.reject { |k, v| !(options[:metrics].include? k) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">          # Keep everything is no metric list is provided</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="226">
          <span class="hits">2</span>
          
          <code class="ruby">          aggregations[f_name] = values</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="230">
          <span class="hits">2</span>
          
          <code class="ruby">      simple_result.merge!({&quot;aggregations&quot; =&gt; aggregations})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="233">
          <span class="hits">71</span>
          
          <code class="ruby">    simple_result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="236">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="238">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.document_data_type(hash, root=&#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="259" data-linenumber="239">
          <span class="hits">259</span>
          
          <code class="ruby">    hash.each do |key, value|</code>
        </li>
      
        <li class="covered" data-hits="642" data-linenumber="240">
          <span class="hits">642</span>
          
          <code class="ruby">      if value.is_a?(Hash) &amp;&amp; value[:type].nil?  # things are nested under this</code>
        </li>
      
        <li class="covered" data-hits="192" data-linenumber="241">
          <span class="hits">192</span>
          
          <code class="ruby">        dotted_path = root + key</code>
        </li>
      
        <li class="covered" data-hits="192" data-linenumber="242">
          <span class="hits">192</span>
          
          <code class="ruby">        data_type = get_data_type(dotted_path)</code>
        </li>
      
        <li class="covered" data-hits="192" data-linenumber="243">
          <span class="hits">192</span>
          
          <code class="ruby">        hash[key] = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">          type: data_type,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">          properties: value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">        # need to include nested data-type values in parent document</code>
        </li>
      
        <li class="covered" data-hits="192" data-linenumber="248">
          <span class="hits">192</span>
          
          <code class="ruby">        hash[key][:include_in_parent] = true if data_type === &#39;nested&#39;</code>
        </li>
      
        <li class="covered" data-hits="192" data-linenumber="249">
          <span class="hits">192</span>
          
          <code class="ruby">        document_data_type(value, dotted_path + &#39;.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="254">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.get_data_type(dotted_path)</code>
        </li>
      
        <li class="covered" data-hits="192" data-linenumber="255">
          <span class="hits">192</span>
          
          <code class="ruby">      default_type = &#39;object&#39;</code>
        </li>
      
        <li class="covered" data-hits="192" data-linenumber="256">
          <span class="hits">192</span>
          
          <code class="ruby">      self.config.es_data_types.each do |key, types|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">        if types.include?(dotted_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">          default_type = key</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">          break</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="192" data-linenumber="262">
          <span class="hits">192</span>
          
          <code class="ruby">      default_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="265">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.create_index(es_index_name = nil, field_types={})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">    # logger.info &quot;create_index field_types: #{field_types.inspect[0..500]}&quot;</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="267">
          <span class="hits">67</span>
          
          <code class="ruby">    es_index_name ||= self.config.scoped_index_name</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="268">
          <span class="hits">67</span>
          
          <code class="ruby">    field_types[&#39;location&#39;] = &#39;lat_lon&#39; # custom lat_lon type maps to geo_point with additional field options</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="269">
          <span class="hits">67</span>
          
          <code class="ruby">    es_types = NestedHash.new.add(es_field_types(field_types))</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="270">
          <span class="hits">67</span>
          
          <code class="ruby">    document_data_type(es_types)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="272">
          <span class="hits">67</span>
          
          <code class="ruby">      logger.info &quot;====&gt; creating index with type mapping&quot;</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="273">
          <span class="hits">67</span>
          
          <code class="ruby">      client.indices.create base_index_hash(es_index_name, es_types)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">    rescue Elasticsearch::Transport::Transport::Errors::BadRequest =&gt; error</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">      if error.message.include? &quot;IndexAlreadyExistsException&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">        logger.debug &quot;create_index failed: #{es_index_name} already exists&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="278">
          
          
          <code class="ruby">        logger.error error.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="279">
          
          
          <code class="ruby">        raise error</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="282">
          <span class="hits">67</span>
          
          <code class="ruby">    es_index_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="285">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.base_index_hash(es_index_name, es_types)</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="286">
          <span class="hits">67</span>
          
          <code class="ruby">    shard_number = (RACK_ENV == &#39;test&#39;) ? 1 : 3</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="287">
          <span class="hits">67</span>
          
          <code class="ruby">    replica_number = (RACK_ENV == &#39;test&#39;) ? 0 : 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="289">
          <span class="hits">67</span>
          
          <code class="ruby">        index: es_index_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">        body: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">            settings: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">                number_of_shards: shard_number,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">                number_of_replicas: replica_number,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby">                analysis: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">                    filter: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">                        autocomplete_filter: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">                            type: &#39;edge_ngram&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">                            min_gram: 1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">                            max_gram: 25,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">                        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">                        autocomplete_word_delimiter: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">                            type: &#39;word_delimiter&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">                            preserve_original: true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">                            split_on_case_change:false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">                            split_on_numerics: false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">                            stem_english_possessive:false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">                        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">                    },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">                    analyzer: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">                        autocomplete_index: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">                            tokenizer: &#39;whitespace&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">                            filter: [&#39;lowercase&#39;, &#39;autocomplete_word_delimiter&#39;, &#39;autocomplete_filter&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">                            type: &#39;custom&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">                        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">                        autocomplete_search: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">                            tokenizer: &#39;whitespace&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">                            filter: [&#39;lowercase&#39;,&#39;autocomplete_word_delimiter&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">                            type: &#39;custom&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">                        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">                    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">                }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">            },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">            mappings: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">                document: { # type &#39;document&#39; is always used for external indexed docs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">                   properties: es_types</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">                }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">  # convert the types from data.yaml to Elasticsearch-specific types</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="333">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.es_field_types(field_types)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">    custom_type = {</code>
        </li>
      
        <li class="covered" data-hits="69" data-linenumber="335">
          <span class="hits">69</span>
          
          <code class="ruby">      &#39;literal&#39; =&gt; {type: &#39;string&#39;, index:&#39;not_analyzed&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby">      &#39;name&#39; =&gt; {type: &#39;string&#39;, index:&#39;not_analyzed&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">      &#39;lowercase_name&#39; =&gt; {type: &#39;string&#39;, index:&#39;not_analyzed&#39;, store: false},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">      &#39;autocomplete&#39; =&gt; {type: &#39;string&#39;, analyzer: &#39;autocomplete_index&#39;, search_analyzer: &#39;autocomplete_search&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby">      &#39;lat_lon&#39; =&gt; { type: &#39;geo_point&#39;, lat_lon: true, store: true }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">   }</code>
        </li>
      
        <li class="covered" data-hits="69" data-linenumber="341">
          <span class="hits">69</span>
          
          <code class="ruby">    field_types.each_with_object({}) do |(key, type), result|</code>
        </li>
      
        <li class="covered" data-hits="468" data-linenumber="342">
          <span class="hits">468</span>
          
          <code class="ruby">      result[key] = custom_type[type]</code>
        </li>
      
        <li class="covered" data-hits="468" data-linenumber="343">
          <span class="hits">468</span>
          
          <code class="ruby">      result[key] ||= { type: type }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby">  # get the real index name when given either</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby">  # endpoint: api endpoint configured in data.yaml</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby">  # index: index name</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="351">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.index_name_from_options(options)</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="352">
          <span class="hits">71</span>
          
          <code class="ruby">    api = options[:endpoint]</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="353">
          <span class="hits">71</span>
          
          <code class="ruby">    options[:index] = options[&#39;index&#39;].to_sym if options[&#39;index&#39;]</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="354">
          <span class="hits">71</span>
          
          <code class="ruby">    logger.info &quot;WARNING: DataMagic.search options api will override index, only one expected&quot;  if api and options[:index]</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="355">
          <span class="hits">71</span>
          
          <code class="ruby">    if api</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">      index_name = config.find_index_for(api)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="357">
          
          
          <code class="ruby">      if index_name.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">        raise ArgumentError, &quot;no configuration found for &#39;#{api}&#39;, available endpoints: #{self.config.api_endpoint_names.inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="361">
          <span class="hits">71</span>
          
          <code class="ruby">      index_name = options[:index]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="363">
          <span class="hits">71</span>
          
          <code class="ruby">    index_name = self.config.scoped_index_name(index_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="366">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.index_data_if_needed</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="367">
          <span class="hits">41</span>
          
          <code class="ruby">    logger.info &quot;index_data_if_needed&quot;</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="368">
          <span class="hits">41</span>
          
          <code class="ruby">    if @index_thread and @index_thread.alive?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby">      logger.info &quot;already indexing... skip!&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="371">
          <span class="hits">41</span>
          
          <code class="ruby">      if config.update_indexed_config</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="372">
          <span class="hits">41</span>
          
          <code class="ruby">        logger.info &quot;new config detected... hitting the big RESET button&quot;</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="373">
          <span class="hits">41</span>
          
          <code class="ruby">        @index_thread = Thread.new do</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="374">
          <span class="hits">41</span>
          
          <code class="ruby">          logger.info &quot;re-indexing...&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="376">
          <span class="hits">41</span>
          
          <code class="ruby">          self.import_with_dictionary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="382">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.reindex</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">    logger.info &quot;reindex&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="384">
          
          
          <code class="ruby">    if @index_thread and @index_thread.alive?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">      logger.info &quot;kill off old indexing process&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="386">
          
          
          <code class="ruby">      Thread.kill(@index_thread)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="387">
          
          
          <code class="ruby">      @index_thread = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">    logger.info &quot;DELETE the index and RELOAD config...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="391">
          
          
          <code class="ruby">    config.delete_index_and_reload_config  # refresh the config</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">    @index_thread = Thread.new do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="393">
          
          
          <code class="ruby">      logger.info &quot;re-indexing!&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">      self.index_with_dictionary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="397">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="398">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="399">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.eservice_uri</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">    if @eservice_uri.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="401">
          
          
          <code class="ruby">      eservice = ::CF::App::Credentials.find_by_service_name(ENV[&#39;es_service&#39;] || &#39;eservice&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="402">
          
          
          <code class="ruby">      logger.info &quot;eservice: #{eservice.inspect}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="403">
          
          
          <code class="ruby">      fail &quot;Please set up eservice credentials in Cloud Foundry env&quot; if eservice.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="404">
          
          
          <code class="ruby">      @eservice_uri = eservice[&#39;url&#39;] || eservice[&#39;uri&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="406">
          
          
          <code class="ruby">    @eservice_uri</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="407">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="409">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.client</code>
        </li>
      
        <li class="covered" data-hits="833" data-linenumber="410">
          <span class="hits">833</span>
          
          <code class="ruby">    timeout = (ENV[&#39;INDEX_APP&#39;] == &#39;enable&#39;) ? 10*60 : 5*60</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="411">
          
          
          <code class="ruby">    opts =</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="covered" data-hits="833" data-linenumber="413">
          <span class="hits">833</span>
          
          <code class="ruby">      transport_options: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby">        request: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">          timeout: timeout,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby">          open_timeout: timeout</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="418">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="covered" data-hits="833" data-linenumber="420">
          <span class="hits">833</span>
          
          <code class="ruby">    if ENV[&#39;ES_DEBUG&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="421">
          
          
          <code class="ruby">      tracer = Logger.new(STDOUT)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="422">
          
          
          <code class="ruby">      tracer.formatter = -&gt;(_s, _d, _p, m) { &quot;#{m.gsub(/^.*$/) { |n| &#39;   &#39; + n }}\n&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">      opts[:tracer] = tracer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="833" data-linenumber="425">
          <span class="hits">833</span>
          
          <code class="ruby">    if @client.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="426">
          
          
          <code class="ruby">      if ENV[&#39;VCAP_APPLICATION&#39;]    # Cloud Foundry</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="427">
          
          
          <code class="ruby">        logger.info &quot;connect to Cloud Foundry elasticsearch service&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="428">
          
          
          <code class="ruby">        logger.info &quot;eservice_uri: #{eservice_uri}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="429">
          
          
          <code class="ruby">        opts[:host] = eservice_uri</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="430">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="431">
          
          
          <code class="ruby">      if ENV[&#39;ES_URI&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="432">
          
          
          <code class="ruby">        opts[:host] = ENV[&#39;ES_URI&#39;] # env override for eservice uri</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="433">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="434">
          
          
          <code class="ruby">      logger.info &quot;default local elasticsearch connection&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="435">
          
          
          <code class="ruby">      @client = ::Elasticsearch::Client.new(opts)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="436">
          
          
          <code class="ruby">      @client = Elasticsearch::Client.new(opts)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="437">
          
          
          <code class="ruby">      Stretchy.client = @client   # use a custom client</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="438">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="833" data-linenumber="439">
          <span class="hits">833</span>
          
          <code class="ruby">    @client</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="440">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby">  # call this before calling anything that requires data.yaml</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="443">
          
          
          <code class="ruby">  # this will load data.yaml, and optionally index referenced data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby">  # options hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="445">
          
          
          <code class="ruby">  #   load_now: default load in background,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="446">
          
          
          <code class="ruby">  #             false don&#39;t load,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="447">
          
          
          <code class="ruby">  #             true load immediately, wait for complete indexing</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="448">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.init(options = {})</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="449">
          <span class="hits">50</span>
          
          <code class="ruby">    logger.info &quot;--&quot;*20</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="450">
          <span class="hits">50</span>
          
          <code class="ruby">    logger.info &quot;    DataMagic init VCAP_APPLICATION=#{ENV[&#39;VCAP_APPLICATION&#39;].inspect}&quot;</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="451">
          <span class="hits">50</span>
          
          <code class="ruby">    logger.info &quot;--&quot;*20</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby">    # logger.info &quot;options: #{options.inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="453">
          
          
          <code class="ruby">    # logger.info &quot;self.config: #{self.config.inspect}&quot;</code>
        </li>
      
        <li class="covered" data-hits="50" data-linenumber="454">
          <span class="hits">50</span>
          
          <code class="ruby">    if self.config.nil?   # only init once</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="455">
          
          
          <code class="ruby">      #::Aws.eager_autoload!       # see https://github.com/aws/aws-sdk-ruby/issues/833</code>
        </li>
      
        <li class="covered" data-hits="49" data-linenumber="456">
          <span class="hits">49</span>
          
          <code class="ruby">      self.config = Config.new(s3: self.s3)    # loads data.yaml</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="457">
          <span class="hits">48</span>
          
          <code class="ruby">      self.client   # make sure we can set up the Elasticsearch client</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="458">
          <span class="hits">48</span>
          
          <code class="ruby">      self.index_data_if_needed unless options[:load_now] == false</code>
        </li>
      
        <li class="covered" data-hits="47" data-linenumber="459">
          <span class="hits">47</span>
          
          <code class="ruby">      @index_thread.join if options[:load_now] and @index_thread</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="460">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="461">
          
          
          <code class="ruby">  end # init</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="462">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="463">
          
          
          <code class="ruby">  # DANGER!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="464">
          
          
          <code class="ruby">  # removes all indices associated with the loaded data.yaml</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="465">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.destroy</code>
        </li>
      
        <li class="covered" data-hits="197" data-linenumber="466">
          <span class="hits">197</span>
          
          <code class="ruby">    logger.info &quot;DataMagic.destroy&quot;</code>
        </li>
      
        <li class="covered" data-hits="197" data-linenumber="467">
          <span class="hits">197</span>
          
          <code class="ruby">    @index_thread.join unless @index_thread.nil?   # finish up indexing, if needed</code>
        </li>
      
        <li class="covered" data-hits="197" data-linenumber="468">
          <span class="hits">197</span>
          
          <code class="ruby">    self.config.clear_all unless config.nil?</code>
        </li>
      
        <li class="covered" data-hits="197" data-linenumber="469">
          <span class="hits">197</span>
          
          <code class="ruby">    self.config = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="470">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="471">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d7ff520cf2596cb16c3737abee7448050dfdc32c">
  <div class="header">
    <h3>lib/data_magic/category.rb</h3>
    <h4><span class="red">22.22 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">Category = Struct.new(:category_id) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def assemble</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    category_entry = DataMagic.config.data[&#39;categories&#39;][category_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    dictionary = DataMagic.config.dictionary</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    field_details = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    category_entry[&#39;fields&#39;].each do |field_name|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      field_details[field_name] = dictionary[field_name] || { &quot;description&quot;=&gt;&quot;&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    field_details = { &quot;field_details&quot; =&gt; field_details }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    assemble = category_entry.merge(field_details)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d1862391aca8f7acf6ecdbdb30a9f9b947d83d0b">
  <div class="header">
    <h3>lib/data_magic/config.rb</h3>
    <h4><span class="yellow">88.45 %</span> covered</h4>
    <div>
      <b>277</b> relevant lines. 
      <span class="green"><b>245</b> lines covered</span> and
      <span class="red"><b>32</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;../data_magic.rb&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module DataMagic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  require_relative &#39;example.rb&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  require_relative &#39;category.rb&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  class Config</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_reader :data_path, :data, :dictionary, :files, :s3, :api_endpoints,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">                :null_value, :file_config</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :page_size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    def init_ivars</code>
        </li>
      
        <li class="covered" data-hits="259" data-linenumber="12">
          <span class="hits">259</span>
          
          <code class="ruby">      @api_endpoints = {}</code>
        </li>
      
        <li class="covered" data-hits="259" data-linenumber="13">
          <span class="hits">259</span>
          
          <code class="ruby">      @files = []</code>
        </li>
      
        <li class="covered" data-hits="259" data-linenumber="14">
          <span class="hits">259</span>
          
          <code class="ruby">      @dictionary = {}</code>
        </li>
      
        <li class="covered" data-hits="259" data-linenumber="15">
          <span class="hits">259</span>
          
          <code class="ruby">      @examples = nil</code>
        </li>
      
        <li class="covered" data-hits="259" data-linenumber="16">
          <span class="hits">259</span>
          
          <code class="ruby">      @column_types = nil</code>
        </li>
      
        <li class="covered" data-hits="259" data-linenumber="17">
          <span class="hits">259</span>
          
          <code class="ruby">      @csv_column_types = nil</code>
        </li>
      
        <li class="covered" data-hits="259" data-linenumber="18">
          <span class="hits">259</span>
          
          <code class="ruby">      @field_mapping = nil</code>
        </li>
      
        <li class="covered" data-hits="259" data-linenumber="19">
          <span class="hits">259</span>
          
          <code class="ruby">      @calculated_field_list = nil</code>
        </li>
      
        <li class="covered" data-hits="259" data-linenumber="20">
          <span class="hits">259</span>
          
          <code class="ruby">      @field_types = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(options = {})</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="24">
          <span class="hits">142</span>
          
          <code class="ruby">      init_ivars</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="25">
          <span class="hits">142</span>
          
          <code class="ruby">      @page_size = DataMagic::DEFAULT_PAGE_SIZE</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="26">
          <span class="hits">142</span>
          
          <code class="ruby">      @extensions = DataMagic::DEFAULT_EXTENSIONS</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="27">
          <span class="hits">142</span>
          
          <code class="ruby">      @s3 = options[:s3]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="29">
          <span class="hits">142</span>
          
          <code class="ruby">      @data_path = options[:data_path] || ENV[&#39;DATA_PATH&#39;]</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="30">
          <span class="hits">142</span>
          
          <code class="ruby">      if @data_path.nil? or @data_path.empty?</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="31">
          <span class="hits">34</span>
          
          <code class="ruby">        @data_path = DEFAULT_PATH</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="33">
          <span class="hits">142</span>
          
          <code class="ruby">      if options[:load_datayaml] == false</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="34">
          <span class="hits">25</span>
          
          <code class="ruby">        @data = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="117" data-linenumber="36">
          <span class="hits">117</span>
          
          <code class="ruby">        load_datayaml</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    def options</code>
        </li>
      
        <li class="covered" data-hits="173" data-linenumber="41">
          <span class="hits">173</span>
          
          <code class="ruby">      @data[&#39;options&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    def dictionary_only_search?</code>
        </li>
      
        <li class="covered" data-hits="101" data-linenumber="45">
          <span class="hits">101</span>
          
          <code class="ruby">      options[:search] == &#39;dictionary_only&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    # what are the valid types for the configured dictionary to have</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    # we allow type to be blank (nil), which will be interpreted as a String</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    def valid_types</code>
        </li>
      
        <li class="covered" data-hits="2477" data-linenumber="51">
          <span class="hits">2477</span>
          
          <code class="ruby">      @valid_type_config ||= DataMagic.valid_types + [nil]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    def examples</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      if @examples.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">        api = api_endpoint_names[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        data[&#39;examples&#39;] ||= []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        @examples = data[&#39;examples&#39;].map do |i|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">          Example.new(i.merge(endpoint: api))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      @examples</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    def categories</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">      data[&#39;categories&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    def category_by_id id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      Category.new(id).assemble</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.init(s3 = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">      logger.info &quot;Config.init #{s3.inspect}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">      @s3 = s3</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      Config.load</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">    def clear_all</code>
        </li>
      
        <li class="covered" data-hits="106" data-linenumber="80">
          <span class="hits">106</span>
          
          <code class="ruby">      unless @data.nil? or @data.empty?</code>
        </li>
      
        <li class="covered" data-hits="106" data-linenumber="81">
          <span class="hits">106</span>
          
          <code class="ruby">        logger.info &quot;Config.clear_all: deleting index &#39;#{scoped_index_name}&#39;&quot;</code>
        </li>
      
        <li class="covered" data-hits="106" data-linenumber="82">
          <span class="hits">106</span>
          
          <code class="ruby">        Stretchy.delete_index scoped_index_name</code>
        </li>
      
        <li class="covered" data-hits="106" data-linenumber="83">
          <span class="hits">106</span>
          
          <code class="ruby">        DataMagic.client.indices.clear_cache</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.logger=(new_logger)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      @logger = new_logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.logger</code>
        </li>
      
        <li class="covered" data-hits="2602" data-linenumber="92">
          <span class="hits">2602</span>
          
          <code class="ruby">      @logger ||= Logger.new(&quot;log/#{ENV[&#39;RACK_ENV&#39;] || &#39;development&#39;}.log&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">    def logger</code>
        </li>
      
        <li class="covered" data-hits="898" data-linenumber="96">
          <span class="hits">898</span>
          
          <code class="ruby">      Config.logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">    def csv_column_type(column_name)</code>
        </li>
      
        <li class="covered" data-hits="28894" data-linenumber="100">
          <span class="hits">28894</span>
          
          <code class="ruby">      extract_csv_column_types[column_name.to_s]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">    # fetches file configuration</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    # add: whatever</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">    def additional_data_for_file(index)</code>
        </li>
      
        <li class="covered" data-hits="262" data-linenumber="106">
          <span class="hits">262</span>
          
          <code class="ruby">      @data.fetch(&#39;files&#39;, []).fetch(index, {}).fetch(&#39;add&#39;, nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">    def info_for_file(index, field)</code>
        </li>
      
        <li class="covered" data-hits="551" data-linenumber="110">
          <span class="hits">551</span>
          
          <code class="ruby">      field = field.to_s</code>
        </li>
      
        <li class="covered" data-hits="551" data-linenumber="111">
          <span class="hits">551</span>
          
          <code class="ruby">      result = @data.fetch(&#39;files&#39;, []).fetch(index, {}).fetch(field, nil)</code>
        </li>
      
        <li class="covered" data-hits="551" data-linenumber="112">
          <span class="hits">551</span>
          
          <code class="ruby">      result = IndifferentHash.new(result) if result.is_a? Hash</code>
        </li>
      
        <li class="covered" data-hits="551" data-linenumber="113">
          <span class="hits">551</span>
          
          <code class="ruby">      result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">    def scoped_index_name(index_name = nil)</code>
        </li>
      
        <li class="covered" data-hits="3448" data-linenumber="117">
          <span class="hits">3448</span>
          
          <code class="ruby">      index_name ||= @data[&#39;index&#39;]</code>
        </li>
      
        <li class="covered" data-hits="3448" data-linenumber="118">
          <span class="hits">3448</span>
          
          <code class="ruby">      env = ENV[&#39;RACK_ENV&#39;]</code>
        </li>
      
        <li class="covered" data-hits="3448" data-linenumber="119">
          <span class="hits">3448</span>
          
          <code class="ruby">      &quot;#{env}-#{index_name}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    # returns an array of api_endpoints</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">    # list of strings</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">    def api_endpoint_names</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      @api_endpoints.keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">    def es_data_types</code>
        </li>
      
        <li class="covered" data-hits="309" data-linenumber="129">
          <span class="hits">309</span>
          
          <code class="ruby">      @data.fetch(&#39;data_types&#39;, {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="132">
          <span class="hits">1</span>
          
          <code class="ruby">    def partial_doc_map</code>
        </li>
      
        <li class="covered" data-hits="131" data-linenumber="133">
          <span class="hits">131</span>
          
          <code class="ruby">      @data.fetch(&#39;partial_map&#39;, {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">    def find_index_for(api)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="137">
          <span class="hits">2</span>
          
          <code class="ruby">      api_info = @api_endpoints[api] || {}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="138">
          <span class="hits">2</span>
          
          <code class="ruby">      api_info[:index]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">    def dictionary=(yaml_hash = {})</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="142">
          <span class="hits">6</span>
          
          <code class="ruby">      @dictionary = IndifferentHash.new(yaml_hash)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="143">
          <span class="hits">6</span>
          
          <code class="ruby">      @dictionary.each do |key, info|</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="144">
          <span class="hits">17</span>
          
          <code class="ruby">        if info === String</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">          @dictionary[key] = {source: info}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">    # pull out all the fields that are specified in</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">    # only: [one, two, three]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">    # this means we should only take these fields from that file, or fields</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">    # with the specified prefix</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">    def only_field_list(only_names, all_fields)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">      # logger.info &quot;only_field_list #{only_names.inspect}&quot;</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="156">
          <span class="hits">19</span>
          
          <code class="ruby">      selected = {}</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="157">
          <span class="hits">19</span>
          
          <code class="ruby">      only_names.each do |name|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">        # pick all fields with given only_name as either exact match or prefix</code>
        </li>
      
        <li class="covered" data-hits="85" data-linenumber="159">
          <span class="hits">85</span>
          
          <code class="ruby">        named = all_fields.select do |k,v|</code>
        </li>
      
        <li class="covered" data-hits="895" data-linenumber="160">
          <span class="hits">895</span>
          
          <code class="ruby">          name == k || ((k =~ /#{name}.*/) == 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="85" data-linenumber="162">
          <span class="hits">85</span>
          
          <code class="ruby">        selected.merge! named</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="164">
          <span class="hits">19</span>
          
          <code class="ruby">      selected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    # return new fields Hash, with fields that will turn into the nested hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">    # based on the &#39;nest&#39; option for a file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="169">
          <span class="hits">1</span>
          
          <code class="ruby">    def make_nested(nest_config, all_fields)</code>
        </li>
      
        <li class="covered" data-hits="47" data-linenumber="170">
          <span class="hits">47</span>
          
          <code class="ruby">      new_fields = {}</code>
        </li>
      
        <li class="covered" data-hits="47" data-linenumber="171">
          <span class="hits">47</span>
          
          <code class="ruby">      selected = []</code>
        </li>
      
        <li class="covered" data-hits="47" data-linenumber="172">
          <span class="hits">47</span>
          
          <code class="ruby">      nest_config[&#39;contents&#39;].each do |key_name|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">        # select the exact match or all the fields with prefix &quot;whatever.&quot;</code>
        </li>
      
        <li class="covered" data-hits="1088" data-linenumber="174">
          <span class="hits">1088</span>
          
          <code class="ruby">        selected += all_fields.keys.select { |name| name == key_name || name =~ /#{key_name}\..*/ }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="47" data-linenumber="176">
          <span class="hits">47</span>
          
          <code class="ruby">      nested_prefix = nest_config[&#39;key&#39;]</code>
        </li>
      
        <li class="covered" data-hits="47" data-linenumber="177">
          <span class="hits">47</span>
          
          <code class="ruby">      selected.each do |name|</code>
        </li>
      
        <li class="covered" data-hits="141" data-linenumber="178">
          <span class="hits">141</span>
          
          <code class="ruby">        new_fields[&quot;#{nested_prefix}.#{name}&quot;] = all_fields[name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="47" data-linenumber="180">
          <span class="hits">47</span>
          
          <code class="ruby">      new_fields</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="183">
          <span class="hits">1</span>
          
          <code class="ruby">    def file_config</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="184">
          <span class="hits">87</span>
          
          <code class="ruby">      @data.fetch(&#39;files&#39;, [])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">    # returns a hash that lets us know the types of what we read from csv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">    # key: the field names which map directly to csv columns</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">    # value: type</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">    def column_field_types</code>
        </li>
      
        <li class="covered" data-hits="2488" data-linenumber="191">
          <span class="hits">2488</span>
          
          <code class="ruby">      if @column_types.nil?</code>
        </li>
      
        <li class="covered" data-hits="88" data-linenumber="192">
          <span class="hits">88</span>
          
          <code class="ruby">        @column_types = {}</code>
        </li>
      
        <li class="covered" data-hits="88" data-linenumber="193">
          <span class="hits">88</span>
          
          <code class="ruby">        dictionary.each do |field_name, info|</code>
        </li>
      
        <li class="covered" data-hits="388" data-linenumber="194">
          <span class="hits">388</span>
          
          <code class="ruby">          type = info[&#39;type&#39;]</code>
        </li>
      
        <li class="covered" data-hits="388" data-linenumber="195">
          <span class="hits">388</span>
          
          <code class="ruby">          @column_types[field_name] = type unless type.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="2488" data-linenumber="198">
          <span class="hits">2488</span>
          
          <code class="ruby">      @column_types</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">    # actually does what column_field_types is meant to do - creates a hash of CSV column</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    # names (strings) to types (as symbols).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">    # Access to this hash is done through Config#column_type(column_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">    # TODO: remove column_field_types</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="205">
          <span class="hits">1</span>
          
          <code class="ruby">    def extract_csv_column_types</code>
        </li>
      
        <li class="covered" data-hits="28894" data-linenumber="206">
          <span class="hits">28894</span>
          
          <code class="ruby">      if @csv_column_types.nil?</code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="207">
          <span class="hits">74</span>
          
          <code class="ruby">        @csv_column_types = {}</code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="208">
          <span class="hits">74</span>
          
          <code class="ruby">        dictionary.each do |_, info|</code>
        </li>
      
        <li class="covered" data-hits="380" data-linenumber="209">
          <span class="hits">380</span>
          
          <code class="ruby">          next if info[&#39;source&#39;].nil?</code>
        </li>
      
        <li class="covered" data-hits="380" data-linenumber="210">
          <span class="hits">380</span>
          
          <code class="ruby">          type = info[&#39;type&#39;] || &quot;string&quot;</code>
        </li>
      
        <li class="covered" data-hits="380" data-linenumber="211">
          <span class="hits">380</span>
          
          <code class="ruby">          @csv_column_types[info[&#39;source&#39;].to_s] = type.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="28894" data-linenumber="214">
          <span class="hits">28894</span>
          
          <code class="ruby">      @csv_column_types</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">    # field_mapping[column_name] = field_name</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">    def field_mapping</code>
        </li>
      
        <li class="covered" data-hits="474" data-linenumber="219">
          <span class="hits">474</span>
          
          <code class="ruby">      if @field_mapping.nil?</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="220">
          <span class="hits">65</span>
          
          <code class="ruby">        @field_mapping = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">        # field_name: name we want as the json key</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="222">
          <span class="hits">65</span>
          
          <code class="ruby">        dictionary.each do |field_name, info|</code>
        </li>
      
        <li class="covered" data-hits="374" data-linenumber="223">
          <span class="hits">374</span>
          
          <code class="ruby">          case info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">            when String</code>
        </li>
      
        <li class="covered" data-hits="253" data-linenumber="225">
          <span class="hits">253</span>
          
          <code class="ruby">              dictionary[field_name] = {&#39;source&#39; =&gt; field_name}</code>
        </li>
      
        <li class="covered" data-hits="253" data-linenumber="226">
          <span class="hits">253</span>
          
          <code class="ruby">              field_mapping[info] = field_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">            when Hash</code>
        </li>
      
        <li class="covered" data-hits="121" data-linenumber="228">
          <span class="hits">121</span>
          
          <code class="ruby">              column_name = info[&#39;source&#39;]</code>
        </li>
      
        <li class="covered" data-hits="121" data-linenumber="229">
          <span class="hits">121</span>
          
          <code class="ruby">              unless column_name.nil? and info[&#39;calculate&#39;] # skip calc columns</code>
        </li>
      
        <li class="covered" data-hits="121" data-linenumber="230">
          <span class="hits">121</span>
          
          <code class="ruby">                @field_mapping[column_name] = field_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">              Config.logger.warn(&quot;unexpected dictionary field info &quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">                &quot;for #{field_name}: #{info.inspect} -- expected String or Hash&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="474" data-linenumber="239">
          <span class="hits">474</span>
          
          <code class="ruby">      @field_mapping</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="242">
          <span class="hits">1</span>
          
          <code class="ruby">    def calculated_field_list</code>
        </li>
      
        <li class="covered" data-hits="2477" data-linenumber="243">
          <span class="hits">2477</span>
          
          <code class="ruby">      if @calculated_field_list.nil?</code>
        </li>
      
        <li class="covered" data-hits="89" data-linenumber="244">
          <span class="hits">89</span>
          
          <code class="ruby">        @calculated_field_list = []</code>
        </li>
      
        <li class="covered" data-hits="89" data-linenumber="245">
          <span class="hits">89</span>
          
          <code class="ruby">        dictionary.each do |field_name, info|</code>
        </li>
      
        <li class="covered" data-hits="389" data-linenumber="246">
          <span class="hits">389</span>
          
          <code class="ruby">          if info.is_a? Hash</code>
        </li>
      
        <li class="covered" data-hits="389" data-linenumber="247">
          <span class="hits">389</span>
          
          <code class="ruby">            if info[&#39;calculate&#39;] or info[:calculate]</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="248">
          <span class="hits">12</span>
          
          <code class="ruby">              @calculated_field_list &lt;&lt; field_name.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="2477" data-linenumber="253">
          <span class="hits">2477</span>
          
          <code class="ruby">      @calculated_field_list</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="256">
          <span class="hits">1</span>
          
          <code class="ruby">    def field_type(field_name)</code>
        </li>
      
        <li class="covered" data-hits="165" data-linenumber="257">
          <span class="hits">165</span>
          
          <code class="ruby">      field_types[field_name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">    # this is a mapping of the fields that end up in the json doc</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">    # to their types, which might include nested documents</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">    # but at this stage, field names use dot syntax for nesting</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="263">
          <span class="hits">1</span>
          
          <code class="ruby">    def field_types</code>
        </li>
      
        <li class="covered" data-hits="225" data-linenumber="264">
          <span class="hits">225</span>
          
          <code class="ruby">      if @field_types.nil?</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="265">
          <span class="hits">87</span>
          
          <code class="ruby">        @field_types = {}</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="266">
          <span class="hits">87</span>
          
          <code class="ruby">        fields = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">        # logger.info &quot;file_config #{file_config.inspect}&quot;</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="268">
          <span class="hits">87</span>
          
          <code class="ruby">        file_config.each do |f|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">          # logger.info &quot;f #{f.inspect}&quot;</code>
        </li>
      
        <li class="covered" data-hits="113" data-linenumber="270">
          <span class="hits">113</span>
          
          <code class="ruby">          if f.keys == [&#39;name&#39;]   # only filename, use all the columns</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="271">
          <span class="hits">36</span>
          
          <code class="ruby">            fields.merge!(dictionary)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="273">
          <span class="hits">77</span>
          
          <code class="ruby">            fields.merge!(only_field_list(f[&#39;only&#39;], dictionary)) if f[&#39;only&#39;]</code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="274">
          <span class="hits">77</span>
          
          <code class="ruby">            fields.merge!(make_nested(f[&#39;nest&#39;], dictionary)) if f[&#39;nest&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">        # logger.info &quot;field_types #{fields.inspect}&quot;</code>
        </li>
      
        <li class="covered" data-hits="87" data-linenumber="278">
          <span class="hits">87</span>
          
          <code class="ruby">        fields.each do |field_name, info|</code>
        </li>
      
        <li class="covered" data-hits="373" data-linenumber="279">
          <span class="hits">373</span>
          
          <code class="ruby">          type = info[&#39;type&#39;] || &quot;string&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">          #logger.info &quot;field #{field_name}: #{type.inspect}&quot;</code>
        </li>
      
        <li class="covered" data-hits="373" data-linenumber="281">
          <span class="hits">373</span>
          
          <code class="ruby">          @field_types[field_name] = type unless type.nil?</code>
        </li>
      
        <li class="covered" data-hits="373" data-linenumber="282">
          <span class="hits">373</span>
          
          <code class="ruby">          if type == &#39;name&#39; || type == &#39;autocomplete&#39;</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="283">
          <span class="hits">24</span>
          
          <code class="ruby">            @field_types[&quot;_#{field_name}&quot;] = &#39;lowercase_name&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="225" data-linenumber="287">
          <span class="hits">225</span>
          
          <code class="ruby">      @field_types</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="290">
          <span class="hits">1</span>
          
          <code class="ruby">    def recreate_indexed_config</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">      # the config specifies how we index, so we always want to delete the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">      # index when we update the configuration document</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="293">
          <span class="hits">41</span>
          
          <code class="ruby">      DataMagic.client.indices.delete index: scoped_index_name if index_exists?</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="294">
          <span class="hits">41</span>
          
          <code class="ruby">      DataMagic.create_index(scoped_index_name, field_types)  ## DataMagic::Index.create ?</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="295">
          <span class="hits">41</span>
          
          <code class="ruby">      dotted_dictionary = @data[&#39;dictionary&#39;] unless @data[&#39;dictionary&#39;].nil? # ES &lt;2.4 dotted keys fix</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="296">
          <span class="hits">41</span>
          
          <code class="ruby">      @data[&#39;dictionary&#39;] = NestedHash.new.add(@data[&#39;dictionary&#39;]) unless @data[&#39;dictionary&#39;].nil?</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="297">
          <span class="hits">41</span>
          
          <code class="ruby">      DataMagic.client.index index: scoped_index_name, type: &#39;config&#39;, id: 1, body: @data</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="298">
          <span class="hits">41</span>
          
          <code class="ruby">      DataMagic.client.indices.refresh index: scoped_index_name</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="299">
          <span class="hits">41</span>
          
          <code class="ruby">      @data[&#39;dictionary&#39;] = dotted_dictionary unless @data[&#39;dictionary&#39;].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="302">
          <span class="hits">1</span>
          
          <code class="ruby">    def delete_index_and_reload_config</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">      load_or_reload_datayaml(data_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">      recreate_indexed_config</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">    # update current configuration document in the index, if needed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">    # return whether the current config was new and required an update</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="309">
          <span class="hits">1</span>
          
          <code class="ruby">    def update_indexed_config</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="310">
          <span class="hits">41</span>
          
          <code class="ruby">      updated = false</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="311">
          <span class="hits">41</span>
          
          <code class="ruby">      index_name = scoped_index_name</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="312">
          <span class="hits">41</span>
          
          <code class="ruby">      if index_needs_update?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">        # logger.debug &quot;--------&gt; new config -&gt; new index: #{@data.inspect[0..255]}&quot;</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="314">
          <span class="hits">41</span>
          
          <code class="ruby">        recreate_indexed_config</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="315">
          <span class="hits">41</span>
          
          <code class="ruby">        updated = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="317">
          <span class="hits">41</span>
          
          <code class="ruby">      updated</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="320">
          <span class="hits">1</span>
          
          <code class="ruby">    def index_exists?(index_name=nil)</code>
        </li>
      
        <li class="covered" data-hits="283" data-linenumber="321">
          <span class="hits">283</span>
          
          <code class="ruby">      index_name ||= scoped_index_name</code>
        </li>
      
        <li class="covered" data-hits="283" data-linenumber="322">
          <span class="hits">283</span>
          
          <code class="ruby">      logger.debug &quot;looking for: #{index_name}&quot;</code>
        </li>
      
        <li class="covered" data-hits="283" data-linenumber="323">
          <span class="hits">283</span>
          
          <code class="ruby">      DataMagic.client.indices.exists? index: index_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="327">
          <span class="hits">1</span>
          
          <code class="ruby">    def index_needs_update?(index_name=nil)</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="328">
          <span class="hits">41</span>
          
          <code class="ruby">      index_name ||= scoped_index_name</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="329">
          <span class="hits">41</span>
          
          <code class="ruby">      old_config = nil</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="330">
          <span class="hits">41</span>
          
          <code class="ruby">      if index_exists?(index_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="332">
          
          
          <code class="ruby">          response = DataMagic.client.get index: index_name, type: &#39;config&#39;, id: 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="333">
          
          
          <code class="ruby">          logger.debug &quot;+-- DM index exists -- #{response.inspect}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="334">
          
          
          <code class="ruby">          old_config = response[&quot;_source&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">        rescue Elasticsearch::Transport::Transport::Errors::NotFound</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">          logger.debug &quot;no prior index configuration&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="339">
          <span class="hits">41</span>
          
          <code class="ruby">      logger.debug &quot;old config version (from es): #{(old_config.nil? ? old_config : old_config[&#39;version&#39;]).inspect}&quot;</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="340">
          <span class="hits">41</span>
          
          <code class="ruby">      logger.debug &quot;new config version (from data.yaml): #{@data[&#39;version&#39;].inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="342">
          <span class="hits">41</span>
          
          <code class="ruby">      old_config.nil? || old_config[&quot;version&quot;] != @data[&quot;version&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">    # read from the key,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">    # return contents or...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">    # nil if not found, otherwise raise exception</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="348">
          <span class="hits">1</span>
          
          <code class="ruby">    def read_from_s3(bucket, key)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="349">
          <span class="hits">2</span>
          
          <code class="ruby">      result = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">        # the explicit encoding required to ensure no encoding conversion is attempted,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">        # and that we write in &quot;binary&quot; mode.</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="353">
          <span class="hits">2</span>
          
          <code class="ruby">        tmpfile = Tempfile.new(key, encoding: &#39;ascii-8bit&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="354">
          <span class="hits">2</span>
          
          <code class="ruby">        response = @s3.get_object(bucket: bucket, key: key, response_target: tmpfile)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="355">
          
          
          <code class="ruby">        result = response.body</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby">        # manual check for BOM, set pos beyond it if necessary.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="357">
          
          
          <code class="ruby">        first_three_bytes = result.sysread(3)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">        if first_three_bytes == &quot;\xEF\xBB\xBF&quot;.force_encoding(first_three_bytes.encoding)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">          # do nothing, pos now beyond BOM</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="361">
          
          
          <code class="ruby">          result.rewind</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="363">
          
          
          <code class="ruby">        result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">      rescue Aws::S3::Errors::NoSuchKey</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">        # we don&#39;t want to raise this one, might be expected</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="366">
          <span class="hits">2</span>
          
          <code class="ruby">        result = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="368">
          
          
          <code class="ruby">        logger.debug &quot;read_from_s3 failed: #{bucket} #{key} with #{e.class}:#{e.message}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby">        raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="371">
          <span class="hits">2</span>
          
          <code class="ruby">      result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby">    # read local file and return content</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby">    # if not found, return nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby">    # any other failure, raise exception</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="377">
          <span class="hits">1</span>
          
          <code class="ruby">    def read_path_local(path)</code>
        </li>
      
        <li class="covered" data-hits="323" data-linenumber="378">
          <span class="hits">323</span>
          
          <code class="ruby">      result = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="covered" data-hits="323" data-linenumber="380">
          <span class="hits">323</span>
          
          <code class="ruby">        result = File.open(path, &#39;r:bom|utf-8&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="382">
          <span class="hits">8</span>
          
          <code class="ruby">        if e.message.include? &quot;No such file or directory&quot;</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="383">
          <span class="hits">8</span>
          
          <code class="ruby">          result = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">          logger.error &quot;read_path_local failed: #{path} with #{e.class}:#{e.message}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="386">
          
          
          <code class="ruby">          raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="323" data-linenumber="389">
          <span class="hits">323</span>
          
          <code class="ruby">      result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="390">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby">    # opens a file or s3 object, returns an IO stream</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby">    # path follows URI pattern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="394">
          
          
          <code class="ruby">    # could be</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">    #   s3://username:password@bucket_name/path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">    #   s3://bucket_name/path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="397">
          
          
          <code class="ruby">    #   s3://bucket_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="398">
          
          
          <code class="ruby">    #   a local path like: &#39;./data&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="399">
          <span class="hits">1</span>
          
          <code class="ruby">    def read_path(path)</code>
        </li>
      
        <li class="covered" data-hits="325" data-linenumber="400">
          <span class="hits">325</span>
          
          <code class="ruby">      result = nil</code>
        </li>
      
        <li class="covered" data-hits="325" data-linenumber="401">
          <span class="hits">325</span>
          
          <code class="ruby">      uri = URI(path)</code>
        </li>
      
        <li class="covered" data-hits="325" data-linenumber="402">
          <span class="hits">325</span>
          
          <code class="ruby">      scheme = uri.scheme</code>
        </li>
      
        <li class="covered" data-hits="325" data-linenumber="403">
          <span class="hits">325</span>
          
          <code class="ruby">      case scheme</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">        when nil</code>
        </li>
      
        <li class="covered" data-hits="323" data-linenumber="405">
          <span class="hits">323</span>
          
          <code class="ruby">          result = read_path_local(uri.path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby">        when &quot;s3&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="407">
          <span class="hits">2</span>
          
          <code class="ruby">          key = uri.path</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="408">
          <span class="hits">2</span>
          
          <code class="ruby">          key[0] = &#39;&#39;  # remove initial /</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="409">
          <span class="hits">2</span>
          
          <code class="ruby">          result = read_from_s3(uri.hostname, key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">          raise ArgumentError, &quot;unexpected scheme: #{scheme}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="325" data-linenumber="413">
          <span class="hits">325</span>
          
          <code class="ruby">      result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="416">
          <span class="hits">1</span>
          
          <code class="ruby">    def load_yaml(path = nil)</code>
        </li>
      
        <li class="covered" data-hits="117" data-linenumber="417">
          <span class="hits">117</span>
          
          <code class="ruby">      logger.info &quot;load_yaml: #{path}&quot;</code>
        </li>
      
        <li class="covered" data-hits="117" data-linenumber="418">
          <span class="hits">117</span>
          
          <code class="ruby">      raw = read_path(File.join(path, &quot;data.yaml&quot;))</code>
        </li>
      
        <li class="covered" data-hits="117" data-linenumber="419">
          <span class="hits">117</span>
          
          <code class="ruby">      raw ||= read_path(File.join(path, &quot;data.yml&quot;))</code>
        </li>
      
        <li class="covered" data-hits="117" data-linenumber="420">
          <span class="hits">117</span>
          
          <code class="ruby">      raw ||= &#39;{}&#39; if ENV[&#39;ALLOW_MISSING_YML&#39;]</code>
        </li>
      
        <li class="covered" data-hits="117" data-linenumber="421">
          <span class="hits">117</span>
          
          <code class="ruby">      if raw.nil?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="422">
          <span class="hits">2</span>
          
          <code class="ruby">        raise IOError, &quot;No data.y?ml found at #{path}. Did you mean to define ALLOW_MISSING_YML environment variable?&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="423">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="425">
          <span class="hits">115</span>
          
          <code class="ruby">      YAML.load(raw)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="427">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="428">
          <span class="hits">1</span>
          
          <code class="ruby">    def list_files(path)</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="429">
          <span class="hits">46</span>
          
          <code class="ruby">      Dir[&quot;#{path}/*&quot;].select { |file|</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="430">
          <span class="hits">46</span>
          
          <code class="ruby">        @extensions.include? File.extname(file)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="431">
          
          
          <code class="ruby">      }.map { |file|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="432">
          <span class="hits">3</span>
          
          <code class="ruby">        File.basename file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="433">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="434">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="436">
          
          
          <code class="ruby">    # if limit is not nil, truncate the length of list to limit</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="437">
          <span class="hits">1</span>
          
          <code class="ruby">    def truncate_list(list, limit)</code>
        </li>
      
        <li class="covered" data-hits="69" data-linenumber="438">
          <span class="hits">69</span>
          
          <code class="ruby">      logger.info(&quot;truncating list limit: #{limit.inspect}&quot;) unless limit.nil?</code>
        </li>
      
        <li class="covered" data-hits="69" data-linenumber="439">
          <span class="hits">69</span>
          
          <code class="ruby">      limit.nil? ? list : list[0...limit]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="440">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby">    # file_data from data.yaml is an array of hashes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="443">
          
          
          <code class="ruby">    # must have a name, everything else is optional</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby">    # fdata can be nil, then we get all files in path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="445">
          <span class="hits">1</span>
          
          <code class="ruby">    def parse_files(path, fdata = nil, options = {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="446">
          
          
          <code class="ruby">      # logger.debug &quot;parse_files: #{fdata.inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="447">
          
          
          <code class="ruby">      # logger.debug &quot;options: #{options.inspect}&quot;</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="448">
          <span class="hits">115</span>
          
          <code class="ruby">      names = []</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="449">
          <span class="hits">115</span>
          
          <code class="ruby">      if fdata.nil?</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="450">
          <span class="hits">46</span>
          
          <code class="ruby">        names = list_files(path)</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="451">
          <span class="hits">46</span>
          
          <code class="ruby">        fdata = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="69" data-linenumber="453">
          <span class="hits">69</span>
          
          <code class="ruby">        fdata = truncate_list(fdata, options[:limit_files])</code>
        </li>
      
        <li class="covered" data-hits="69" data-linenumber="454">
          <span class="hits">69</span>
          
          <code class="ruby">        fdata.each_with_index do |info, index|</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="455">
          <span class="hits">123</span>
          
          <code class="ruby">          name = info.fetch(&#39;name&#39;, &#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="456">
          <span class="hits">123</span>
          
          <code class="ruby">          if name.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="457">
          
          
          <code class="ruby">            raise ArgumentError &quot;file #{index}: &#39;name&#39; must not be empty &quot; +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby">                                &quot;in #{fdata.inspect}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="459">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="123" data-linenumber="460">
          <span class="hits">123</span>
          
          <code class="ruby">          names &lt;&lt; name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="461">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="462">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="463">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="241" data-linenumber="464">
          <span class="hits">241</span>
          
          <code class="ruby">      paths = names.map { |name| File.join(path, name) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="465">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="466">
          <span class="hits">115</span>
          
          <code class="ruby">      return paths, fdata</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="467">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="469">
          <span class="hits">1</span>
          
          <code class="ruby">    def clean_index(path)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="470">
          <span class="hits">48</span>
          
          <code class="ruby">      uri = URI(path)</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="471">
          <span class="hits">48</span>
          
          <code class="ruby">      File.basename(uri.hostname || uri.path).gsub(/[^0-9a-z]+/, &#39;-&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="473">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="474">
          <span class="hits">1</span>
          
          <code class="ruby">    def null_value</code>
        </li>
      
        <li class="covered" data-hits="2475" data-linenumber="475">
          <span class="hits">2475</span>
          
          <code class="ruby">      @data[&#39;null_value&#39;] || &#39;NULL&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="476">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="477">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="478">
          <span class="hits">1</span>
          
          <code class="ruby">    def load_or_reload_datayaml(directory_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="479">
          
          
          <code class="ruby">      # logger.debug &quot;load config #{directory_path.inspect}&quot;</code>
        </li>
      
        <li class="covered" data-hits="117" data-linenumber="480">
          <span class="hits">117</span>
          
          <code class="ruby">      init_ivars</code>
        </li>
      
        <li class="covered" data-hits="117" data-linenumber="481">
          <span class="hits">117</span>
          
          <code class="ruby">      @data = load_yaml(directory_path)</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="482">
          <span class="hits">115</span>
          
          <code class="ruby">      @data[&#39;unique&#39;] ||= []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="483">
          
          
          <code class="ruby">      # logger.debug &quot;config: #{@data.inspect[0..600]}&quot;</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="484">
          <span class="hits">115</span>
          
          <code class="ruby">      @data[&#39;index&#39;] ||= clean_index(@data_path)</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="485">
          <span class="hits">115</span>
          
          <code class="ruby">      endpoint = @data[&#39;api&#39;] || clean_index(@data_path)</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="486">
          <span class="hits">115</span>
          
          <code class="ruby">      @dictionary = @data[&#39;dictionary&#39;] || {}</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="487">
          <span class="hits">115</span>
          
          <code class="ruby">      @data[&#39;options&#39;] ||= {}</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="488">
          <span class="hits">115</span>
          
          <code class="ruby">      Hashie.symbolize_keys! @data[&#39;options&#39;]</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="489">
          <span class="hits">115</span>
          
          <code class="ruby">      @api_endpoints[endpoint] = {index: @data[&#39;index&#39;]}</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="490">
          <span class="hits">115</span>
          
          <code class="ruby">      @files, @data[&#39;files&#39;] = parse_files(directory_path, @data[&#39;files&#39;], @data[&#39;options&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="491">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="492">
          
          
          <code class="ruby">      # logger.debug &quot;file_config: #{@data[&#39;files&#39;].inspect}&quot;</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="493">
          <span class="hits">115</span>
          
          <code class="ruby">      logger.debug &quot;no files found&quot; if @data[&#39;files&#39;].empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="494">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="495">
          
          
          <code class="ruby">      # keep track of where we loaded our data, so we can avoid loading again</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="496">
          <span class="hits">115</span>
          
          <code class="ruby">      @data[&#39;data_path&#39;] = directory_path</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="497">
          <span class="hits">115</span>
          
          <code class="ruby">      @data_path = directory_path  # make sure this is set, in case it changed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="498">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="499">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="500">
          <span class="hits">1</span>
          
          <code class="ruby">    def load_datayaml(directory_path = nil)</code>
        </li>
      
        <li class="covered" data-hits="189" data-linenumber="501">
          <span class="hits">189</span>
          
          <code class="ruby">      logger.debug &quot;---- Config.load -----&quot;</code>
        </li>
      
        <li class="covered" data-hits="189" data-linenumber="502">
          <span class="hits">189</span>
          
          <code class="ruby">      if directory_path.nil? or directory_path.empty?</code>
        </li>
      
        <li class="covered" data-hits="189" data-linenumber="503">
          <span class="hits">189</span>
          
          <code class="ruby">        directory_path = data_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="504">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="505">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="189" data-linenumber="506">
          <span class="hits">189</span>
          
          <code class="ruby">      if @data and @data[&#39;data_path&#39;] == directory_path</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="507">
          <span class="hits">72</span>
          
          <code class="ruby">        logger.debug &quot;already loaded, nothing to do!&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="508">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="117" data-linenumber="509">
          <span class="hits">117</span>
          
          <code class="ruby">        load_or_reload_datayaml(directory_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="510">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="187" data-linenumber="511">
          <span class="hits">187</span>
          
          <code class="ruby">      scoped_index_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="512">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="513">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="514">
          
          
          <code class="ruby">  end # class Config</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="515">
          
          
          <code class="ruby">end # module DataMagic</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="034378574ccca7de81c52d7ae68570adc87d6397">
  <div class="header">
    <h3>lib/data_magic/error_checker.rb</h3>
    <h4><span class="green">97.06 %</span> covered</h4>
    <div>
      <b>68</b> relevant lines. 
      <span class="green"><b>66</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;action_view&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">include ActionView::Helpers::SanitizeHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module DataMagic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  module ErrorChecker</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    class &lt;&lt; self</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      def check(params, options, config)</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="7">
          <span class="hits">94</span>
          
          <code class="ruby">        report_required_params_absent(options) +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">          report_nonexistent_params(params, config) +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">          report_nonexistent_operators(params) +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">          report_nonexistent_fields(options[:fields], config) +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">          report_bad_range_argument(params) +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">          report_wrong_field_type(params, config) +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">          report_wrong_zip(options) +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">          report_distance_requires_zip(options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">      def report_required_params_absent(options)</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="20">
          <span class="hits">94</span>
          
          <code class="ruby">        if options[:command] == &#39;stats&#39; &amp;&amp; options[:fields].length == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">          [build_error(error: &#39;invalid_or_incomplete_parameters&#39;, input: options[:command])]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="23">
          <span class="hits">94</span>
          
          <code class="ruby">          []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">      def report_distance_requires_zip(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        # if distance, must have zip</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="29">
          <span class="hits">94</span>
          
          <code class="ruby">        return [] if (params[:distance] &amp;&amp; params[:zip]) || (!params[:distance])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">        [build_error(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">          error: &#39;distance_error&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">        )]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">      def report_wrong_zip(params)</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="36">
          <span class="hits">94</span>
          
          <code class="ruby">        return [] if !params[:zip] || Zipcode.valid?(params[:zip])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="37">
          <span class="hits">2</span>
          
          <code class="ruby">        [build_error(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">          error: &#39;zipcode_error&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">          parameter: :zip,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">          input: params[:zip].to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        )]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">      def report_nonexistent_params(params, config)</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="45">
          <span class="hits">94</span>
          
          <code class="ruby">        return [] unless config.dictionary_only_search?</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="46">
          <span class="hits">13</span>
          
          <code class="ruby">        params.keys.reject { |p| config.field_type(strip_op(p)) }.</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="47">
          <span class="hits">2</span>
          
          <code class="ruby">          map { |p| build_error(error: &#39;parameter_not_found&#39;, input: strip_op(p)) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      def report_nonexistent_operators(params)</code>
        </li>
      
        <li class="covered" data-hits="160" data-linenumber="51">
          <span class="hits">160</span>
          
          <code class="ruby">        params.keys.select { |p| p =~ /__(\w+)$/ &amp;&amp; $1 !~ /range|not|ne/i }.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">          map do |p|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">            (param, op) = p.match(/^(.*)__(\w+)$/).captures</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">            build_error(error: &#39;operator_not_found&#39;, parameter: param, input: op)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">      def report_nonexistent_fields(fields, config)</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="59">
          <span class="hits">94</span>
          
          <code class="ruby">        if fields &amp;&amp; !fields.empty? &amp;&amp; config.dictionary_only_search?</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="60">
          <span class="hits">14</span>
          
          <code class="ruby">          fields.reject { |f| config.field_type(f.to_s) }.</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="61">
          <span class="hits">6</span>
          
          <code class="ruby">            map { |f| build_error(error: &#39;field_not_found&#39;, input: f.to_s) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="90" data-linenumber="63">
          <span class="hits">90</span>
          
          <code class="ruby">          []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">      def report_bad_range_argument(params)</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="68">
          <span class="hits">94</span>
          
          <code class="ruby">        ranges = params.select do |p,v|</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="69">
          <span class="hits">66</span>
          
          <code class="ruby">          p =~ /__range$/ and</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">            v !~ / ^(\d+(\.\d+)?)? # optional starting number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">                   \.\.           # range dots</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">                   (\d+(\.\d+)?)?  # optional ending number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">                   (,(\d+(\.\d+)?)?\.\.(\d+(\.\d+)?)?)* # and more, with commas</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">                   $/x</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="76">
          <span class="hits">94</span>
          
          <code class="ruby">        ranges.map do |p,v|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="77">
          <span class="hits">4</span>
          
          <code class="ruby">          build_error(error: &#39;range_format_error&#39;, parameter: strip_op(p), input: v)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">      def report_wrong_field_type(params, config)</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="82">
          <span class="hits">94</span>
          
          <code class="ruby">        bad_fields = params.select do |p, v|</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="83">
          <span class="hits">66</span>
          
          <code class="ruby">          next false if p =~ /__range$/</code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="84">
          <span class="hits">61</span>
          
          <code class="ruby">          param_type = config.field_type(strip_op(p))</code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="85">
          <span class="hits">61</span>
          
          <code class="ruby">          value_type = guess_value_type(v)</code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="86">
          <span class="hits">61</span>
          
          <code class="ruby">          (param_type == &quot;float&quot; &amp;&amp; value_type != &quot;float&quot; &amp;&amp; value_type != &quot;integer&quot;) or</code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="87">
          <span class="hits">61</span>
          
          <code class="ruby">            (param_type == &quot;integer&quot; &amp;&amp; value_type != &quot;integer&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="89">
          <span class="hits">94</span>
          
          <code class="ruby">        bad_fields.map do |p, v|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="90">
          <span class="hits">4</span>
          
          <code class="ruby">          build_error(error: &#39;parameter_type_error&#39;, parameter: p, input: v,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">                      expected_type: config.field_type(strip_op(p)),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">                      input_type: guess_value_type(v))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">      def build_error(opts)</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="97">
          <span class="hits">20</span>
          
          <code class="ruby">        opts[:input] = sanitize_error_opts(opts[:input]) unless opts[:input].nil?</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="98">
          <span class="hits">20</span>
          
          <code class="ruby">        opts[:parameter] = sanitize_error_opts(opts[:parameter]) unless opts[:parameter].nil?</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="99">
          <span class="hits">20</span>
          
          <code class="ruby">        opts[:message] =</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">          case opts[:error]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">          when &#39;invalid_or_incomplete_parameters&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">            &quot;The command #{opts[:input]} requires a fields parameter.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">          when &#39;parameter_not_found&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="104">
          <span class="hits">2</span>
          
          <code class="ruby">            &quot;The input parameter &#39;#{opts[:input]}&#39; is not known in this dataset.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">          when &#39;field_not_found&#39;</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="106">
          <span class="hits">6</span>
          
          <code class="ruby">            &quot;The input field &#39;#{opts[:input]}&#39; (in the fields parameter) is not a field in this dataset.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">          when &#39;operator_not_found&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">            &quot;The input operator &#39;#{opts[:input]}&#39; (appended to the parameter &#39;#{opts[:parameter]}&#39;) is not known or supported. (Known operators: range, ne, not)&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">          when &#39;parameter_type_error&#39;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="110">
          <span class="hits">4</span>
          
          <code class="ruby">            &quot;The parameter &#39;#{opts[:parameter]}&#39; expects a value of type #{opts[:expected_type]}, but received &#39;#{opts[:input]}&#39; which is a value of type #{opts[:input_type]}.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">          when &#39;range_format_error&#39;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="112">
          <span class="hits">4</span>
          
          <code class="ruby">            &quot;The range &#39;#{opts[:input]}&#39; supplied to parameter &#39;#{opts[:parameter]}&#39; isn&#39;t in the correct format.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">          when &#39;zipcode_error&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="114">
          <span class="hits">2</span>
          
          <code class="ruby">            &quot;The provided zipcode, &#39;#{opts[:input]}&#39;, is not valid.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">          when &#39;distance_error&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">            &quot;Use of the &#39;distance&#39; parameter also requires a &#39;zip&#39; parameter.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="118">
          <span class="hits">20</span>
          
          <code class="ruby">        opts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">      def guess_value_type(value)</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="122">
          <span class="hits">65</span>
          
          <code class="ruby">        case value.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">        when /^-?\d+$/</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="124">
          <span class="hits">15</span>
          
          <code class="ruby">          &quot;integer&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">        when /^(-?\d+,?)+$/ # list of integers</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="126">
          <span class="hits">2</span>
          
          <code class="ruby">          &quot;integer&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">        when /^-?\d+\.\d+$/</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="128">
          <span class="hits">2</span>
          
          <code class="ruby">          &quot;float&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="130">
          <span class="hits">46</span>
          
          <code class="ruby">          &quot;string&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">      def strip_op(param)</code>
        </li>
      
        <li class="covered" data-hits="76" data-linenumber="135">
          <span class="hits">76</span>
          
          <code class="ruby">        param.sub(/__\w+$/, &#39;&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">      def sanitize_error_opts(html)</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="139">
          <span class="hits">30</span>
          
          <code class="ruby">        strip_tags(html.to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="caea3bc38c4dd443d3ced1d24303f948e415b0c7">
  <div class="header">
    <h3>lib/data_magic/example.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>11</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Example &lt; Hashie::Mash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include Hashie::Extensions::Coercion</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include Hashie::Extensions::MergeInitializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  coerce_key :name, String</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  coerce_key :description, String</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  coerce_key :params, String</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  coerce_key :endpoint, String</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  coerce_key :link, String</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize(hash = {})</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="10">
          <span class="hits">5</span>
          
          <code class="ruby">   super</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">   # we want to use this in a liquid template</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">   # so all attributes needs to be plain data, not code</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="13">
          <span class="hits">5</span>
          
          <code class="ruby">   self[:link] = &quot;/v1/#{endpoint}?#{params}&quot; if self[:link].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"> end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c0fc89e1152c97276029748de56be148d1d5a742">
  <div class="header">
    <h3>lib/data_magic/index.rb</h3>
    <h4><span class="green">95.19 %</span> covered</h4>
    <div>
      <b>104</b> relevant lines. 
      <span class="green"><b>99</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;forwardable&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;yaml&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;config&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;index/builder_data&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;index/event_logger&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;index/document&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;index/document_builder&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;index/importer&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;index/output&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;index/repository&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;index/row_importer&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;index/super_client&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;index/row_map&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;action_view&#39;  # for distance_of_time_in_words (logging time)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">include ActionView::Helpers::DateHelper  # for distance_of_time_in_words (logging time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">module DataMagic</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  # data could be a String or an io stream</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.import_csv(data, options={}, row_map={})</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="22">
          <span class="hits">138</span>
          
          <code class="ruby">    Index::Importer.process(data, options, row_map)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.log_index_start</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="26">
          <span class="hits">72</span>
          
          <code class="ruby">    start_time = Time.now</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="27">
          <span class="hits">72</span>
          
          <code class="ruby">    Config.logger.debug &quot;--- Indexing Begins, starting at #{start_time}&quot;</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="28">
          <span class="hits">72</span>
          
          <code class="ruby">    start_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.log_index_end(start_time)</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="32">
          <span class="hits">71</span>
          
          <code class="ruby">    end_time = Time.now</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="33">
          <span class="hits">71</span>
          
          <code class="ruby">    logger.debug &quot;indexing complete: #{distance_of_time_in_words(end_time, start_time)}&quot;</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="34">
          <span class="hits">71</span>
          
          <code class="ruby">    logger.debug &quot;duration: #{end_time - start_time}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.index_file_process(options = {}, filepath, row_map)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="131" data-linenumber="39">
          <span class="hits">131</span>
          
          <code class="ruby">      logger.debug &quot;--&quot;*40</code>
        </li>
      
        <li class="covered" data-hits="131" data-linenumber="40">
          <span class="hits">131</span>
          
          <code class="ruby">      logger.debug &quot;--    #{filepath}&quot;</code>
        </li>
      
        <li class="covered" data-hits="131" data-linenumber="41">
          <span class="hits">131</span>
          
          <code class="ruby">      logger.debug &quot;--&quot;*40</code>
        </li>
      
        <li class="covered" data-hits="131" data-linenumber="42">
          <span class="hits">131</span>
          
          <code class="ruby">      file_start = Time.now</code>
        </li>
      
        <li class="covered" data-hits="131" data-linenumber="43">
          <span class="hits">131</span>
          
          <code class="ruby">      data = config.read_path(filepath)</code>
        </li>
      
        <li class="covered" data-hits="131" data-linenumber="44">
          <span class="hits">131</span>
          
          <code class="ruby">      rows, _ = DataMagic.import_csv(data, options, row_map)</code>
        </li>
      
        <li class="covered" data-hits="130" data-linenumber="45">
          <span class="hits">130</span>
          
          <code class="ruby">      file_end = Time.now</code>
        </li>
      
        <li class="covered" data-hits="130" data-linenumber="46">
          <span class="hits">130</span>
          
          <code class="ruby">      logger.debug &quot;imported #{rows} rows in #{distance_of_time_in_words(file_end, file_start)}, ms: #{file_end - file_start}&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    rescue DataMagic::InvalidData =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      Config.logger.debug &quot;Error: skipping #{filepath}, #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  # pre-condition: index is already created w/ config</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.index_with_dictionary(options = {})</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="54">
          <span class="hits">63</span>
          
          <code class="ruby">    start_time = log_index_start</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    # optionally continue importing from a named file (see import.rake)</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="56">
          <span class="hits">63</span>
          
          <code class="ruby">    starting_from = 0</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="57">
          <span class="hits">63</span>
          
          <code class="ruby">    if options[:continue]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      starting_from = config.files.find_index { |file| file.match( /#{options[:continue]}/ ) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      logger.info &quot;Indexing continues with file: #{options[:continue]}&quot; unless starting_from.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    # for partial data rows, this is a map to a related key</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="62">
          <span class="hits">63</span>
          
          <code class="ruby">    row_map = create_row_map(options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    # iterate config data files</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="64">
          <span class="hits">63</span>
          
          <code class="ruby">    logger.info &quot;files: #{self.config.files[starting_from.to_i..-1]}&quot;</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="65">
          <span class="hits">63</span>
          
          <code class="ruby">    config.files[starting_from.to_i..-1].each_with_index do |filepath, index|</code>
        </li>
      
        <li class="covered" data-hits="122" data-linenumber="66">
          <span class="hits">122</span>
          
          <code class="ruby">      fname = filepath.split(&#39;/&#39;).last</code>
        </li>
      
        <li class="covered" data-hits="122" data-linenumber="67">
          <span class="hits">122</span>
          
          <code class="ruby">      logger.debug &quot;indexing #{fname} #{starting_from + index} file config:#{config.additional_data_for_file(starting_from + index).inspect}&quot;</code>
        </li>
      
        <li class="covered" data-hits="122" data-linenumber="68">
          <span class="hits">122</span>
          
          <code class="ruby">      options[:add_data] = config.additional_data_for_file(starting_from + index)</code>
        </li>
      
        <li class="covered" data-hits="122" data-linenumber="69">
          <span class="hits">122</span>
          
          <code class="ruby">      options[:root] = config.info_for_file(starting_from + index, :root)</code>
        </li>
      
        <li class="covered" data-hits="122" data-linenumber="70">
          <span class="hits">122</span>
          
          <code class="ruby">      options[:only] = config.info_for_file(starting_from + index, :only)</code>
        </li>
      
        <li class="covered" data-hits="122" data-linenumber="71">
          <span class="hits">122</span>
          
          <code class="ruby">      options[:nest] = config.info_for_file(starting_from + index, :nest)</code>
        </li>
      
        <li class="covered" data-hits="122" data-linenumber="72">
          <span class="hits">122</span>
          
          <code class="ruby">      options[:map] = config.info_for_file(starting_from + index, :map)</code>
        </li>
      
        <li class="covered" data-hits="122" data-linenumber="73">
          <span class="hits">122</span>
          
          <code class="ruby">      options[:partial_map] = config.partial_doc_map[options[:map]] unless config.partial_doc_map[options[:map]].nil?</code>
        </li>
      
        <li class="covered" data-hits="122" data-linenumber="74">
          <span class="hits">122</span>
          
          <code class="ruby">      index_file_process(options, filepath, row_map)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="62" data-linenumber="76">
          <span class="hits">62</span>
          
          <code class="ruby">    log_index_end(start_time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.create_row_map(options)</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="80">
          <span class="hits">72</span>
          
          <code class="ruby">    data = config.read_path(config.files.first)</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="81">
          <span class="hits">72</span>
          
          <code class="ruby">    row_map = DataMagic::Index::RowMap.new(&#39;id&#39;, &#39;ope6_id&#39;)</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="82">
          <span class="hits">72</span>
          
          <code class="ruby">    CSV.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">        data,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">        headers: true,</code>
        </li>
      
        <li class="covered" data-hits="647" data-linenumber="85">
          <span class="hits">647</span>
          
          <code class="ruby">        header_converters: lambda { |str| str.strip.to_sym }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    ).each do |row|</code>
        </li>
      
        <li class="covered" data-hits="1326" data-linenumber="87">
          <span class="hits">1326</span>
          
          <code class="ruby">      row_map.add_item(row.to_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="89">
          <span class="hits">72</span>
          
          <code class="ruby">    row_map</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.import_with_dictionary(options = {})</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="93">
          <span class="hits">63</span>
          
          <code class="ruby">    options[:mapping] = config.field_mapping</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="94">
          <span class="hits">63</span>
          
          <code class="ruby">    options = options.merge(config.options)</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="95">
          <span class="hits">63</span>
          
          <code class="ruby">    es_index_name = self.config.load_datayaml(options[:data_path])</code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="96">
          <span class="hits">63</span>
          
          <code class="ruby">    unless config.index_exists?(es_index_name)</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="97">
          <span class="hits">19</span>
          
          <code class="ruby">      logger.info &quot;creating #{es_index_name}&quot;   # TO DO: fix #14</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="98">
          <span class="hits">19</span>
          
          <code class="ruby">      create_index es_index_name, config.field_types</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="63" data-linenumber="101">
          <span class="hits">63</span>
          
          <code class="ruby">    index_with_dictionary(options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">  end # import_with_dictionary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.index_with_delta(options = {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">    # delta updates the current index with a single file</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="107">
          <span class="hits">9</span>
          
          <code class="ruby">    if options[:delta_original]</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="108">
          <span class="hits">9</span>
          
          <code class="ruby">      start_time = log_index_start</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">      # find the index of the delta file from the config by the :delta_only key (see delta.rake)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="110">
          <span class="hits">9</span>
          
          <code class="ruby">      original_file_index = nil</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="111">
          <span class="hits">9</span>
          
          <code class="ruby">      config.files.each_with_index do|file, index|</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="112">
          <span class="hits">36</span>
          
          <code class="ruby">        if config.info_for_file(index, :delta_only)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="113">
          <span class="hits">9</span>
          
          <code class="ruby">          original_file_index = index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="117">
          <span class="hits">9</span>
          
          <code class="ruby">      unless original_file_index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">        raise ArgumentError, &quot;delta_original file must contiain :delta_only key in data.yaml. No :delta_only key found.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="121">
          <span class="hits">9</span>
          
          <code class="ruby">      row_map = create_row_map(options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      # use specified :delta_update filename, or fall back to :delta_original if not provided</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="124">
          <span class="hits">9</span>
          
          <code class="ruby">      delta_filename = options[:delta_update] || options[:delta_original]</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="125">
          <span class="hits">9</span>
          
          <code class="ruby">      config.files[original_file_index..original_file_index].each do |filepath|</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="126">
          <span class="hits">9</span>
          
          <code class="ruby">        original_fname = filepath.split(&#39;/&#39;).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">        # update filepath to use a &quot;delta&quot; subdirectory within DATA_PATH (e.g, &lt;DATA_PATH&gt;/delta/&lt;CSV_FILE&gt; )</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="128">
          <span class="hits">9</span>
          
          <code class="ruby">        delta_filepath = filepath.gsub(/#{original_fname}/, &quot;delta/#{delta_filename}&quot; )</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="129">
          <span class="hits">9</span>
          
          <code class="ruby">        logger.debug &quot;delta update with #{delta_filename} file config:#{config.additional_data_for_file(original_file_index).inspect}&quot;</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="130">
          <span class="hits">9</span>
          
          <code class="ruby">        options[:add_data] = config.additional_data_for_file(original_file_index)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">        # Append the :delta_only array as our :only fields</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="132">
          <span class="hits">9</span>
          
          <code class="ruby">        options[:only] = config.info_for_file(original_file_index, :delta_only)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="133">
          <span class="hits">9</span>
          
          <code class="ruby">        options[:nest] = config.info_for_file(original_file_index, :nest)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="134">
          <span class="hits">9</span>
          
          <code class="ruby">        options[:root] = false # we are not creating new documents</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="135">
          <span class="hits">9</span>
          
          <code class="ruby">        options[:nest][:parent_missing] = &#39;skip&#39; # we allow skips</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="136">
          <span class="hits">9</span>
          
          <code class="ruby">        options[:map] = config.info_for_file(original_file_index, :map)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="137">
          <span class="hits">9</span>
          
          <code class="ruby">        options[:partial_map] = config.partial_doc_map[options[:map]] unless config.partial_doc_map[options[:map]].nil?</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="138">
          <span class="hits">9</span>
          
          <code class="ruby">        index_file_process(options, delta_filepath, row_map)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="140">
          <span class="hits">9</span>
          
          <code class="ruby">      log_index_end(start_time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">      raise ArgumentError, &quot;delta.rake requires &#39;delta_original&#39; argument to be a filename from the config. No option[:delta_original] provided.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">  # pre-condition: index is already created w/ config</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.import_with_delta(options = {})</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="148">
          <span class="hits">9</span>
          
          <code class="ruby">    options[:mapping] = config.field_mapping</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="149">
          <span class="hits">9</span>
          
          <code class="ruby">    options = options.merge(config.options)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="150">
          <span class="hits">9</span>
          
          <code class="ruby">    es_index_name = self.config.load_datayaml(options[:data_path])</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="151">
          <span class="hits">9</span>
          
          <code class="ruby">    index_with_delta(options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">  end # import_with_delta</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">private</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.valid_types</code>
        </li>
      
        <li class="covered" data-hits="89" data-linenumber="156">
          <span class="hits">89</span>
          
          <code class="ruby">    %w[integer float string literal name autocomplete boolean]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">end # module DataMagic</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="35b717c1edcd06b1b47636b28feb351606b5ca2e">
  <div class="header">
    <h3>lib/data_magic/index/builder_data.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>14</b> relevant lines. 
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module DataMagic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    class BuilderData</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :data, :options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(data, options)</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="7">
          <span class="hits">138</span>
          
          <code class="ruby">        @options = options</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="8">
          <span class="hits">138</span>
          
          <code class="ruby">        @data = data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">      def additional_fields</code>
        </li>
      
        <li class="covered" data-hits="2591" data-linenumber="12">
          <span class="hits">2591</span>
          
          <code class="ruby">        options[:mapping] || {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      def new_field_names</code>
        </li>
      
        <li class="covered" data-hits="2591" data-linenumber="16">
          <span class="hits">2591</span>
          
          <code class="ruby">        field_names = options[:fields] || {}</code>
        </li>
      
        <li class="covered" data-hits="2591" data-linenumber="17">
          <span class="hits">2591</span>
          
          <code class="ruby">        field_names.merge(additional_fields)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">      def additional_data</code>
        </li>
      
        <li class="covered" data-hits="2591" data-linenumber="21">
          <span class="hits">2591</span>
          
          <code class="ruby">        options[:add_data]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9bc50df13874dc21f61f78dde20c8f9ca1a3933f">
  <div class="header">
    <h3>lib/data_magic/index/document.rb</h3>
    <h4><span class="green">90.48 %</span> covered</h4>
    <div>
      <b>21</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module DataMagic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    class Document</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :data, :id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(data)</code>
        </li>
      
        <li class="covered" data-hits="2460" data-linenumber="7">
          <span class="hits">2460</span>
          
          <code class="ruby">        @data = data</code>
        </li>
      
        <li class="covered" data-hits="2460" data-linenumber="8">
          <span class="hits">2460</span>
          
          <code class="ruby">        @id = calculate_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">      def remove_ids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">        config.data[&#39;unique&#39;].each { |key| data.delete key }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      def headers</code>
        </li>
      
        <li class="covered" data-hits="135" data-linenumber="16">
          <span class="hits">135</span>
          
          <code class="ruby">        data.keys.map(&amp;:to_s) # does this only return top level fields?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">      def preview(n=500)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">        data.inspect[0..n]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">      def id_empty?</code>
        </li>
      
        <li class="covered" data-hits="2456" data-linenumber="24">
          <span class="hits">2456</span>
          
          <code class="ruby">        id &amp;&amp; id.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">      def calculate_id</code>
        </li>
      
        <li class="covered" data-hits="2460" data-linenumber="30">
          <span class="hits">2460</span>
          
          <code class="ruby">        return nil if config.data[&#39;unique&#39;].length == 0</code>
        </li>
      
        <li class="covered" data-hits="3034" data-linenumber="31">
          <span class="hits">3034</span>
          
          <code class="ruby">        config.data[&#39;unique&#39;].map { |field| data[field] }.join(&#39;:&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">      def config</code>
        </li>
      
        <li class="covered" data-hits="3976" data-linenumber="35">
          <span class="hits">3976</span>
          
          <code class="ruby">        DataMagic.config</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="70145ea163116afe5cb1f77589249bcd9e96e8aa">
  <div class="header">
    <h3>lib/data_magic/index/document_builder.rb</h3>
    <h4><span class="green">92.24 %</span> covered</h4>
    <div>
      <b>116</b> relevant lines. 
      <span class="green"><b>107</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;./lib/expression/expression&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module DataMagic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  module Index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    module DocumentBuilder</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      class &lt;&lt; self</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">        def logger</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">          DataMagic::Config.logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">        # build a nested json document from a csv row</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">        # row: a hash  { column_name =&gt; value }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">        #      where all column_names and values are strings</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">        # fields: column_name =&gt; field_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">        # config: DataMagic.Config instance for dictionary, column types, NULL</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">        # return: hash - may include :only, :nest, or both :only AND :nest fields/value pairs as specified in config.files</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">        def build(row, builder_data, config)</code>
        </li>
      
        <li class="covered" data-hits="2477" data-linenumber="18">
          <span class="hits">2477</span>
          
          <code class="ruby">          fields = builder_data.new_field_names</code>
        </li>
      
        <li class="covered" data-hits="2477" data-linenumber="19">
          <span class="hits">2477</span>
          
          <code class="ruby">          options = builder_data.options</code>
        </li>
      
        <li class="covered" data-hits="2477" data-linenumber="20">
          <span class="hits">2477</span>
          
          <code class="ruby">          additional = builder_data.additional_data</code>
        </li>
      
        <li class="covered" data-hits="2477" data-linenumber="21">
          <span class="hits">2477</span>
          
          <code class="ruby">          csv_row = map_column_types(row.to_hash, config)</code>
        </li>
      
        <li class="covered" data-hits="2476" data-linenumber="22">
          <span class="hits">2476</span>
          
          <code class="ruby">          if fields.empty?</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="23">
          <span class="hits">138</span>
          
          <code class="ruby">            field_values = csv_row</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="2338" data-linenumber="25">
          <span class="hits">2338</span>
          
          <code class="ruby">            field_values = map_field_names(csv_row, fields, options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="2476" data-linenumber="27">
          <span class="hits">2476</span>
          
          <code class="ruby">          field_values.merge!(calculated_fields(csv_row, config))</code>
        </li>
      
        <li class="covered" data-hits="2476" data-linenumber="28">
          <span class="hits">2476</span>
          
          <code class="ruby">          field_values.merge!(lowercase_columns(field_values, config.column_field_types))</code>
        </li>
      
        <li class="covered" data-hits="2476" data-linenumber="29">
          <span class="hits">2476</span>
          
          <code class="ruby">          field_values.merge!(additional) if additional</code>
        </li>
      
        <li class="covered" data-hits="2476" data-linenumber="30">
          <span class="hits">2476</span>
          
          <code class="ruby">          doc = NestedHash.new.add(field_values)</code>
        </li>
      
        <li class="covered" data-hits="2476" data-linenumber="31">
          <span class="hits">2476</span>
          
          <code class="ruby">          if options[:only] &amp;&amp; options[:nest]</code>
        </li>
      
        <li class="covered" data-hits="100" data-linenumber="32">
          <span class="hits">100</span>
          
          <code class="ruby">            doc_from_only = select_only_fields(doc, options[:only])</code>
        </li>
      
        <li class="covered" data-hits="100" data-linenumber="33">
          <span class="hits">100</span>
          
          <code class="ruby">            doc_from_nest = parse_nested(doc, options)</code>
        </li>
      
        <li class="covered" data-hits="100" data-linenumber="34">
          <span class="hits">100</span>
          
          <code class="ruby">            doc = doc_from_only.merge!(doc_from_nest)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="2376" data-linenumber="36">
          <span class="hits">2376</span>
          
          <code class="ruby">            doc = parse_nested(doc, options) if options[:nest]</code>
        </li>
      
        <li class="covered" data-hits="2376" data-linenumber="37">
          <span class="hits">2376</span>
          
          <code class="ruby">            doc = select_only_fields(doc, options[:only]) unless options[:only].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="2476" data-linenumber="39">
          <span class="hits">2476</span>
          
          <code class="ruby">          doc</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">        def create(row, builder_data, config)</code>
        </li>
      
        <li class="covered" data-hits="2453" data-linenumber="43">
          <span class="hits">2453</span>
          
          <code class="ruby">          if !row.is_a?(Array)</code>
        </li>
      
        <li class="covered" data-hits="2453" data-linenumber="44">
          <span class="hits">2453</span>
          
          <code class="ruby">            Document.new(build(row, builder_data, config))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">            docs = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">            row.each do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">              docs.push( Document.new(build(r, builder_data, config)))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">            docs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">        private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">        def calculated_fields(row, config)</code>
        </li>
      
        <li class="covered" data-hits="2477" data-linenumber="57">
          <span class="hits">2477</span>
          
          <code class="ruby">          result = {}</code>
        </li>
      
        <li class="covered" data-hits="2477" data-linenumber="58">
          <span class="hits">2477</span>
          
          <code class="ruby">          config.calculated_field_list.each do |name|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="59">
          <span class="hits">12</span>
          
          <code class="ruby">            result[name] = calculate(name, row, config.dictionary)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="2477" data-linenumber="61">
          <span class="hits">2477</span>
          
          <code class="ruby">          result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        # row: a hash  (keys may be strings or symbols)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">        # valid_types: an array of allowed types</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        # null_value: row values that will map to null</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">        # field_types: hash field_name : type (float, integer, string)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">        # returns a hash where values have been coerced to the new type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">        # TODO: move type validation to config load time instead</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">        def map_column_types(row, config)</code>
        </li>
      
        <li class="covered" data-hits="2477" data-linenumber="71">
          <span class="hits">2477</span>
          
          <code class="ruby">          valid_types = config.valid_types</code>
        </li>
      
        <li class="covered" data-hits="2477" data-linenumber="72">
          <span class="hits">2477</span>
          
          <code class="ruby">          null_value = [*config.null_value] || [&#39;NULL&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2477" data-linenumber="74">
          <span class="hits">2477</span>
          
          <code class="ruby">          mapped = {}</code>
        </li>
      
        <li class="covered" data-hits="2477" data-linenumber="75">
          <span class="hits">2477</span>
          
          <code class="ruby">          row.each do |key, value|</code>
        </li>
      
        <li class="covered" data-hits="30654" data-linenumber="76">
          <span class="hits">30654</span>
          
          <code class="ruby">            if null_value.include? value</code>
        </li>
      
        <li class="covered" data-hits="1734" data-linenumber="77">
          <span class="hits">1734</span>
          
          <code class="ruby">              mapped[key] = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="covered" data-hits="28920" data-linenumber="79">
          <span class="hits">28920</span>
          
          <code class="ruby">              type = config.csv_column_type(key)</code>
        </li>
      
        <li class="covered" data-hits="28920" data-linenumber="80">
          <span class="hits">28920</span>
          
          <code class="ruby">              if valid_types.include? type</code>
        </li>
      
        <li class="covered" data-hits="28919" data-linenumber="81">
          <span class="hits">28919</span>
          
          <code class="ruby">                mapped[key] = fix_field_type(type, value, key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">                fail InvalidDictionary, &quot;unexpected type &#39;#{type.inspect}&#39; for field &#39;#{key}&#39;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="2476" data-linenumber="87">
          <span class="hits">2476</span>
          
          <code class="ruby">          mapped</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">        def lowercase_columns(row, field_types = {})</code>
        </li>
      
        <li class="covered" data-hits="2476" data-linenumber="91">
          <span class="hits">2476</span>
          
          <code class="ruby">          new_columns = {}</code>
        </li>
      
        <li class="covered" data-hits="2476" data-linenumber="92">
          <span class="hits">2476</span>
          
          <code class="ruby">          row.each do |key, value|</code>
        </li>
      
        <li class="covered" data-hits="18515" data-linenumber="93">
          <span class="hits">18515</span>
          
          <code class="ruby">            next if value.nil?</code>
        </li>
      
        <li class="covered" data-hits="17588" data-linenumber="94">
          <span class="hits">17588</span>
          
          <code class="ruby">            type = field_types[key.to_sym] || field_types[key.to_s]</code>
        </li>
      
        <li class="covered" data-hits="17588" data-linenumber="95">
          <span class="hits">17588</span>
          
          <code class="ruby">            new_columns[&quot;_#{key}&quot;] = value.downcase if type == &quot;name&quot; || type == &quot;autocomplete&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="2476" data-linenumber="97">
          <span class="hits">2476</span>
          
          <code class="ruby">          new_columns</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">        def parse_nested(document, options)</code>
        </li>
      
        <li class="covered" data-hits="599" data-linenumber="101">
          <span class="hits">599</span>
          
          <code class="ruby">          new_doc = {}</code>
        </li>
      
        <li class="covered" data-hits="599" data-linenumber="102">
          <span class="hits">599</span>
          
          <code class="ruby">          nest_options = options[:nest]</code>
        </li>
      
        <li class="covered" data-hits="599" data-linenumber="103">
          <span class="hits">599</span>
          
          <code class="ruby">          if nest_options</code>
        </li>
      
        <li class="covered" data-hits="599" data-linenumber="104">
          <span class="hits">599</span>
          
          <code class="ruby">            key = nest_options[&#39;key&#39;]</code>
        </li>
      
        <li class="covered" data-hits="599" data-linenumber="105">
          <span class="hits">599</span>
          
          <code class="ruby">            new_doc[key] = {}</code>
        </li>
      
        <li class="covered" data-hits="599" data-linenumber="106">
          <span class="hits">599</span>
          
          <code class="ruby">            new_doc[&#39;id&#39;] = document[&#39;id&#39;] unless document[&#39;id&#39;].nil?</code>
        </li>
      
        <li class="covered" data-hits="599" data-linenumber="107">
          <span class="hits">599</span>
          
          <code class="ruby">            nest_options[&#39;contents&#39;].each do |item_key|</code>
        </li>
      
        <li class="covered" data-hits="1199" data-linenumber="108">
          <span class="hits">1199</span>
          
          <code class="ruby">              unless options[:partial_map].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">                parse_nested_partial(document, options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="covered" data-hits="1199" data-linenumber="111">
          <span class="hits">1199</span>
          
          <code class="ruby">              new_doc[key][item_key] = document[item_key]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="599" data-linenumber="114">
          <span class="hits">599</span>
          
          <code class="ruby">          new_doc</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">        def parse_nested_partial(doc, options)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">          path = options[:partial_map][&#39;path&#39;].split(&#39;.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">          # wrap real (ES) nested partial doc in an array</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">          doc.dotkey_set(path.join(&#39;.&#39;), [doc.dig(*path)])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">        def fix_field_type(type, value, key=nil)</code>
        </li>
      
        <li class="covered" data-hits="28955" data-linenumber="124">
          <span class="hits">28955</span>
          
          <code class="ruby">          return value if value.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="28923" data-linenumber="126">
          <span class="hits">28923</span>
          
          <code class="ruby">          new_value = case type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">                      when &quot;float&quot;</code>
        </li>
      
        <li class="covered" data-hits="1440" data-linenumber="128">
          <span class="hits">1440</span>
          
          <code class="ruby">                        value.to_f</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">                      when &quot;integer&quot;</code>
        </li>
      
        <li class="covered" data-hits="1590" data-linenumber="130">
          <span class="hits">1590</span>
          
          <code class="ruby">                        value.to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">                      when &quot;lowercase_name&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">                        value.to_s.downcase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">                      when &quot;boolean&quot;</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="134">
          <span class="hits">14</span>
          
          <code class="ruby">                        parse_boolean(value)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">                      else # &quot;string&quot;</code>
        </li>
      
        <li class="covered" data-hits="25879" data-linenumber="136">
          <span class="hits">25879</span>
          
          <code class="ruby">                        value.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="28923" data-linenumber="138">
          <span class="hits">28923</span>
          
          <code class="ruby">          new_value = value.to_f if key and key.to_s.include? &quot;location&quot;</code>
        </li>
      
        <li class="covered" data-hits="28923" data-linenumber="139">
          <span class="hits">28923</span>
          
          <code class="ruby">          new_value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">        def parse_boolean(value)</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="143">
          <span class="hits">14</span>
          
          <code class="ruby">          case value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">          when &quot;true&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">            true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">          when &quot;false&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">            false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">          when 0</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="149">
          <span class="hits">6</span>
          
          <code class="ruby">            false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="151">
          <span class="hits">6</span>
          
          <code class="ruby">            !!value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">        # currently we just support &#39;or&#39; operations on two columns</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">        def calculate(field_name, row, dictionary)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="157">
          <span class="hits">12</span>
          
          <code class="ruby">          item = dictionary[field_name.to_s] || dictionary[field_name.to_sym]</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="158">
          <span class="hits">12</span>
          
          <code class="ruby">          type = item[&#39;type&#39;] || item[:type]</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="159">
          <span class="hits">12</span>
          
          <code class="ruby">          fail &quot;calculate: field not found in dictionary #{field_name.inspect}&quot; if item.nil?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="160">
          <span class="hits">12</span>
          
          <code class="ruby">          expr = item[&#39;calculate&#39;] || item[:calculate]</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="161">
          <span class="hits">12</span>
          
          <code class="ruby">          fail ArgumentError, &quot;expected to calculate #{field_name}&quot; if expr.nil?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="162">
          <span class="hits">12</span>
          
          <code class="ruby">          e = Expression.find_or_create(expr)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="163">
          <span class="hits">12</span>
          
          <code class="ruby">          vars = {}</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="164">
          <span class="hits">12</span>
          
          <code class="ruby">          e.variables.each do |name|</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="165">
          <span class="hits">24</span>
          
          <code class="ruby">            vars[name] = fix_field_type(type, row[name.to_sym])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="167">
          <span class="hits">12</span>
          
          <code class="ruby">          fix_field_type(type, e.evaluate(vars))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">        # row: a hash  (keys may be strings or symbols)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">        # new_fields: hash current_name : new_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">        # returns a hash (which may be a subset of row) where keys are new_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">        #         with value of corresponding row[current_name]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="174">
          <span class="hits">1</span>
          
          <code class="ruby">        def map_field_names(row, new_fields, options = {})</code>
        </li>
      
        <li class="covered" data-hits="2338" data-linenumber="175">
          <span class="hits">2338</span>
          
          <code class="ruby">          mapped = {}</code>
        </li>
      
        <li class="covered" data-hits="2338" data-linenumber="176">
          <span class="hits">2338</span>
          
          <code class="ruby">          row.each do |key, value|</code>
        </li>
      
        <li class="covered" data-hits="29125" data-linenumber="177">
          <span class="hits">29125</span>
          
          <code class="ruby">            fail ArgumentError, &quot;column header missing for: #{value}&quot; if key.nil?</code>
        </li>
      
        <li class="covered" data-hits="29125" data-linenumber="178">
          <span class="hits">29125</span>
          
          <code class="ruby">            new_key = new_fields[key.to_sym] || new_fields[key.to_s]</code>
        </li>
      
        <li class="covered" data-hits="29125" data-linenumber="179">
          <span class="hits">29125</span>
          
          <code class="ruby">            if new_key</code>
        </li>
      
        <li class="covered" data-hits="16954" data-linenumber="180">
          <span class="hits">16954</span>
          
          <code class="ruby">              value = value.to_f if new_key.include? &quot;location&quot;</code>
        </li>
      
        <li class="covered" data-hits="16954" data-linenumber="181">
          <span class="hits">16954</span>
          
          <code class="ruby">              mapped[new_key] = value</code>
        </li>
      
        <li class="covered" data-hits="12171" data-linenumber="182">
          <span class="hits">12171</span>
          
          <code class="ruby">            elsif options[:columns] == &#39;all&#39;</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="183">
          <span class="hits">26</span>
          
          <code class="ruby">              mapped[key] = value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="2338" data-linenumber="186">
          <span class="hits">2338</span>
          
          <code class="ruby">          mapped</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">        # select top-level fields from a hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">        # if there are name types, also select _name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">        # doc: hash with string keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">        # only_keys: array of keys</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">        def select_only_fields(doc, only_keys)</code>
        </li>
      
        <li class="covered" data-hits="311" data-linenumber="194">
          <span class="hits">311</span>
          
          <code class="ruby">          doc = doc.select do |key, value|</code>
        </li>
      
        <li class="covered" data-hits="2676" data-linenumber="195">
          <span class="hits">2676</span>
          
          <code class="ruby">            key = key.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">            # if key has _ prefix, select if key present without _</code>
        </li>
      
        <li class="covered" data-hits="2676" data-linenumber="197">
          <span class="hits">2676</span>
          
          <code class="ruby">            key = key[1..-1] if key[0] == &#39;_&#39;</code>
        </li>
      
        <li class="covered" data-hits="2676" data-linenumber="198">
          <span class="hits">2676</span>
          
          <code class="ruby">            only_keys.include?(key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">      end # class methods</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">    end # module QueryBuilder</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">end  # module DataMagic</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7324573adfc5afa786d1c06a1aa58d5b4a1b61a7">
  <div class="header">
    <h3>lib/data_magic/index/event_logger.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>14</b> relevant lines. 
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module DataMagic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    class EventLogger</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">      def trigger(event, *args)</code>
        </li>
      
        <li class="covered" data-hits="829" data-linenumber="5">
          <span class="hits">829</span>
          
          <code class="ruby">        self.send(event, *args)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      [&#39;debug&#39;, &#39;info&#39;, &#39;warn&#39;, &#39;error&#39;].each do |level|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="9">
          <span class="hits">4</span>
          
          <code class="ruby">        class_eval &lt;&lt;-RUBY, __FILE__, __LINE__ + 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">          def #{level}(message, object=nil, limit=nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">            logger.#{level}(full_message(message, object, limit))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">        RUBY</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      def full_message(prefix, object, limit)</code>
        </li>
      
        <li class="covered" data-hits="829" data-linenumber="17">
          <span class="hits">829</span>
          
          <code class="ruby">        return prefix unless object</code>
        </li>
      
        <li class="covered" data-hits="427" data-linenumber="18">
          <span class="hits">427</span>
          
          <code class="ruby">        message = &quot;#{prefix}: &quot;</code>
        </li>
      
        <li class="covered" data-hits="427" data-linenumber="19">
          <span class="hits">427</span>
          
          <code class="ruby">        if limit</code>
        </li>
      
        <li class="covered" data-hits="136" data-linenumber="20">
          <span class="hits">136</span>
          
          <code class="ruby">          message &lt;&lt; object.inspect[0..limit]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="291" data-linenumber="22">
          <span class="hits">291</span>
          
          <code class="ruby">          message &lt;&lt; object.inspect</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="427" data-linenumber="24">
          <span class="hits">427</span>
          
          <code class="ruby">        message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="40e43bd22105715bf5fe1a52844f9bf309b1a771">
  <div class="header">
    <h3>lib/data_magic/index/importer.rb</h3>
    <h4><span class="red">69.3 %</span> covered</h4>
    <div>
      <b>114</b> relevant lines. 
      <span class="green"><b>79</b> lines covered</span> and
      <span class="red"><b>35</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;forwardable&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module DataMagic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  module Index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    class Importer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :raw_data, :options, :row_map</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(raw_data, options, row_map)</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="9">
          <span class="hits">138</span>
          
          <code class="ruby">        @raw_data = raw_data</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="10">
          <span class="hits">138</span>
          
          <code class="ruby">        @options = options</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="11">
          <span class="hits">138</span>
          
          <code class="ruby">        @row_map = row_map</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">      def process</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="15">
          <span class="hits">138</span>
          
          <code class="ruby">        setup</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="16">
          <span class="hits">138</span>
          
          <code class="ruby">        parse_and_log</code>
        </li>
      
        <li class="covered" data-hits="136" data-linenumber="17">
          <span class="hits">136</span>
          
          <code class="ruby">        finish!</code>
        </li>
      
        <li class="covered" data-hits="135" data-linenumber="18">
          <span class="hits">135</span>
          
          <code class="ruby">        [row_count, headers]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      def client</code>
        </li>
      
        <li class="covered" data-hits="5179" data-linenumber="22">
          <span class="hits">5179</span>
          
          <code class="ruby">        @client ||= SuperClient.new(es_client, options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      def builder_data</code>
        </li>
      
        <li class="covered" data-hits="3003" data-linenumber="26">
          <span class="hits">3003</span>
          
          <code class="ruby">        @builder_data ||= BuilderData.new(raw_data, options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">      def row_map</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        @row_map || {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">      def output</code>
        </li>
      
        <li class="covered" data-hits="10643" data-linenumber="34">
          <span class="hits">10643</span>
          
          <code class="ruby">        @output ||= Output.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_and_log</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="38">
          <span class="hits">138</span>
          
          <code class="ruby">        parse_csv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      rescue InvalidData =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        trigger(&quot;error&quot;, e.message)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        raise InvalidData, &quot;invalid file format&quot; if empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">      def chunk_size</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">        (ENV[&#39;CHUNK_SIZE&#39;] || 100).to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">      def nprocs</code>
        </li>
      
        <li class="covered" data-hits="139" data-linenumber="49">
          <span class="hits">139</span>
          
          <code class="ruby">        (ENV[&#39;NPROCS&#39;] || 1).to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_csv</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="53">
          <span class="hits">138</span>
          
          <code class="ruby">        if nprocs == 1</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="54">
          <span class="hits">137</span>
          
          <code class="ruby">          parse_csv_whole</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">        elsif client.nested_partial?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">          parse_csv_mapped</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">          parse_csv_chunked</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="136" data-linenumber="60">
          <span class="hits">136</span>
          
          <code class="ruby">        data.close</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_csv_whole</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="64">
          <span class="hits">137</span>
          
          <code class="ruby">        CSV.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">          data,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">          headers: true,</code>
        </li>
      
        <li class="covered" data-hits="1428" data-linenumber="67">
          <span class="hits">1428</span>
          
          <code class="ruby">          header_converters: lambda { |str| str.strip.to_sym }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">        ).each do |row|</code>
        </li>
      
        <li class="covered" data-hits="2453" data-linenumber="69">
          <span class="hits">2453</span>
          
          <code class="ruby">          dispatch_row_importer(row)</code>
        </li>
      
        <li class="covered" data-hits="2452" data-linenumber="70">
          <span class="hits">2452</span>
          
          <code class="ruby">          break if at_limit?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_csv_chunked</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">        CSV.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">          data,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">          headers: true,</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="78">
          <span class="hits">2</span>
          
          <code class="ruby">          header_converters: lambda { |str| str.strip.to_sym }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">        ).each.each_slice(chunk_size) do |chunk|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">          break if at_limit?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">          chunks_per_proc = (chunk.size / nprocs.to_f).ceil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">          Parallel.each(chunk.each_slice(chunks_per_proc)) do |rows|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">            rows.each_with_index do |row, idx|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">              dispatch_row_importer(row)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">          if !headers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">            single_document = DocumentBuilder.create(chunk.first, builder_data, DataMagic.config)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">            set_headers(single_document)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">          increment(chunk.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">      def parse_csv_mapped</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">        rocky_chunks = CSV.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">          data,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">          headers: true,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">          header_converters: lambda { |str| str.strip.to_sym }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">        ).chunk_while { |a, b|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">          # chunk by nested document link</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">          lookup_row_id(a) === lookup_row_id(b)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">        }.to_a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">        # rearrange chunks for parallel processing, so our slices are &#39;roughly&#39; the same size</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">        sorted = rocky_chunks.sort_by(&amp;:size)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">        grouped = sorted.each.each_with_index.group_by { |_, index| index % nprocs }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        smooth_chunks = grouped.map { |_, data|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">          # here we only return the first array , each_with_index was adding in an unwanted index item</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">          data.map(&amp;:first)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        }.flatten(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">        chunks_per_proc = (smooth_chunks.size / nprocs.to_f).ceil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">        Parallel.each(smooth_chunks.each_slice(chunks_per_proc)) do |chunks|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">          chunks.each do |chunk|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">            dispatch_row_importer(chunk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">        increment(smooth_chunks.size)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">      def dispatch_row_importer(row)</code>
        </li>
      
        <li class="covered" data-hits="2453" data-linenumber="124">
          <span class="hits">2453</span>
          
          <code class="ruby">        if client.nested_partial?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">          if row.is_a?(Array)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">            dispatch_row_bulk_importer(row)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">            row_id = lookup_row_id(row)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">            Array(row_map.map[row_id]).each do |related_id|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">              row &lt;&lt; [row_map.id, related_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">              RowImporter.process(row, self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="2453" data-linenumber="135">
          <span class="hits">2453</span>
          
          <code class="ruby">          RowImporter.process(row, self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">      def dispatch_row_bulk_importer(rows)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">        row_id = lookup_row_id(rows[0])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">        Array(row_map.map[row_id]).each do |related_id|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">          rows.each do |row|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">            row &lt;&lt; [row_map.id, related_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">          RowBulkImporter.process(rows, self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">      def lookup_row_id(row)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">        link = row_map.calculate_column(options[:partial_map][&#39;link&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">        row.to_hash[link]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">      def setup</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="155">
          <span class="hits">138</span>
          
          <code class="ruby">        client.create_index</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="156">
          <span class="hits">138</span>
          
          <code class="ruby">        log_setup</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="159">
          <span class="hits">1</span>
          
          <code class="ruby">      def finish!</code>
        </li>
      
        <li class="covered" data-hits="136" data-linenumber="160">
          <span class="hits">136</span>
          
          <code class="ruby">        validate!</code>
        </li>
      
        <li class="covered" data-hits="135" data-linenumber="161">
          <span class="hits">135</span>
          
          <code class="ruby">        refresh_index if ENV[&#39;RACK_ENV&#39;] == &#39;test&#39;</code>
        </li>
      
        <li class="covered" data-hits="135" data-linenumber="162">
          <span class="hits">135</span>
          
          <code class="ruby">        log_finish</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">      def log_setup</code>
        </li>
      
        <li class="covered" data-hits="958" data-linenumber="166">
          <span class="hits">958</span>
          
          <code class="ruby">        opts = options.reject { |k,v| k == :mapping }</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="167">
          <span class="hits">138</span>
          
          <code class="ruby">        trigger(&quot;info&quot;, &quot;options&quot;, opts)</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="168">
          <span class="hits">138</span>
          
          <code class="ruby">        trigger(&quot;info&quot;, &quot;new_field_names&quot;, new_field_names)</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="169">
          <span class="hits">138</span>
          
          <code class="ruby">        trigger(&quot;info&quot;, &quot;additional_data&quot;, additional_data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="172">
          <span class="hits">1</span>
          
          <code class="ruby">      def log_finish</code>
        </li>
      
        <li class="covered" data-hits="135" data-linenumber="173">
          <span class="hits">135</span>
          
          <code class="ruby">        trigger(&quot;info&quot;, &quot;skipped (missing parent id)&quot;, output.skipped) if !output.skipped.empty?</code>
        </li>
      
        <li class="covered" data-hits="135" data-linenumber="174">
          <span class="hits">135</span>
          
          <code class="ruby">        trigger(&#39;info&#39;, &quot;done #{row_count} rows&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="177">
          <span class="hits">1</span>
          
          <code class="ruby">      def event_logger</code>
        </li>
      
        <li class="covered" data-hits="823" data-linenumber="178">
          <span class="hits">823</span>
          
          <code class="ruby">        @event_logger ||= EventLogger.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">      def at_limit?</code>
        </li>
      
        <li class="covered" data-hits="4905" data-linenumber="182">
          <span class="hits">4905</span>
          
          <code class="ruby">        options[:limit_rows] &amp;&amp; row_count == options[:limit_rows]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="185">
          <span class="hits">1</span>
          
          <code class="ruby">      extend Forwardable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">      def_delegators :output, :set_headers, :skipping, :skipped, :increment, :row_count, :log_limit,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">        :empty?, :validate!, :headers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="189">
          <span class="hits">1</span>
          
          <code class="ruby">      def_delegators :builder_data, :data, :new_field_names, :additional_data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">      def_delegators :client, :refresh_index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">      def_delegators :event_logger, :trigger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.process(*args)</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="194">
          <span class="hits">138</span>
          
          <code class="ruby">        new(*args).process</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="197">
          <span class="hits">1</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">      def es_client</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="200">
          <span class="hits">138</span>
          
          <code class="ruby">        DataMagic.client</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d65375660cca9580f56d900f548b196047c386f9">
  <div class="header">
    <h3>lib/data_magic/index/output.rb</h3>
    <h4><span class="red">70.59 %</span> covered</h4>
    <div>
      <b>34</b> relevant lines. 
      <span class="green"><b>24</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module DataMagic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    class Output</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :row_count, :headers, :skipped</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="7">
          <span class="hits">137</span>
          
          <code class="ruby">        @row_count = 0</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="8">
          <span class="hits">137</span>
          
          <code class="ruby">        @skipped = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">      def set_headers(doc)</code>
        </li>
      
        <li class="covered" data-hits="2452" data-linenumber="12">
          <span class="hits">2452</span>
          
          <code class="ruby">        return if headers</code>
        </li>
      
        <li class="covered" data-hits="135" data-linenumber="13">
          <span class="hits">135</span>
          
          <code class="ruby">        if doc.is_a?(Array)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">          @headers = doc[0].headers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="135" data-linenumber="16">
          <span class="hits">135</span>
          
          <code class="ruby">          @headers = doc.headers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">      def skipping(id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">        skipped &lt;&lt; id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">      def increment(count = 1)</code>
        </li>
      
        <li class="covered" data-hits="2452" data-linenumber="25">
          <span class="hits">2452</span>
          
          <code class="ruby">        @row_count += count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">      def validate!</code>
        </li>
      
        <li class="covered" data-hits="136" data-linenumber="29">
          <span class="hits">136</span>
          
          <code class="ruby">        raise DataMagic::InvalidData, &quot;zero rows&quot; if empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">      def empty?</code>
        </li>
      
        <li class="covered" data-hits="2589" data-linenumber="33">
          <span class="hits">2589</span>
          
          <code class="ruby">        row_count == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">      def log(doc)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        log_0(doc) if empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">        log_marker if row_count % 500 == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      def log_skips</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        return if skipped.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        logger.info &quot;skipped (missing parent id): #{skipped.join(&#39;,&#39;)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">      def log_limit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        logger.info &quot;done now, limiting rows to #{row_count}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">      def log_0(document)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        logger.debug &quot;csv parsed&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        logger.info &quot;row#{row_count} -&gt; #{document.preview}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">      def log_marker</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        logger.info &quot;indexing rows: #{row_count}...&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="accbf4558c410d11472a43f2cfbf22781eb248ea">
  <div class="header">
    <h3>lib/data_magic/index/repository.rb</h3>
    <h4><span class="red">50.88 %</span> covered</h4>
    <div>
      <b>57</b> relevant lines. 
      <span class="green"><b>29</b> lines covered</span> and
      <span class="red"><b>28</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module DataMagic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    class Repository</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :client, :document</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(client, document)</code>
        </li>
      
        <li class="covered" data-hits="2458" data-linenumber="7">
          <span class="hits">2458</span>
          
          <code class="ruby">        @client = client</code>
        </li>
      
        <li class="covered" data-hits="2458" data-linenumber="8">
          <span class="hits">2458</span>
          
          <code class="ruby">        @document = document</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">      def skipped?</code>
        </li>
      
        <li class="covered" data-hits="2455" data-linenumber="12">
          <span class="hits">2455</span>
          
          <code class="ruby">        @skipped</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      def save</code>
        </li>
      
        <li class="covered" data-hits="2458" data-linenumber="16">
          <span class="hits">2458</span>
          
          <code class="ruby">        @skipped = false</code>
        </li>
      
        <li class="covered" data-hits="2458" data-linenumber="17">
          <span class="hits">2458</span>
          
          <code class="ruby">        if client.creating?</code>
        </li>
      
        <li class="covered" data-hits="1857" data-linenumber="18">
          <span class="hits">1857</span>
          
          <code class="ruby">          create</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="601" data-linenumber="20">
          <span class="hits">601</span>
          
          <code class="ruby">          update</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">      def update</code>
        </li>
      
        <li class="covered" data-hits="601" data-linenumber="27">
          <span class="hits">601</span>
          
          <code class="ruby">        if client.allow_skips?</code>
        </li>
      
        <li class="covered" data-hits="100" data-linenumber="28">
          <span class="hits">100</span>
          
          <code class="ruby">          update_with_rescue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="501" data-linenumber="30">
          <span class="hits">501</span>
          
          <code class="ruby">          update_without_rescue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">      def create</code>
        </li>
      
        <li class="covered" data-hits="1857" data-linenumber="35">
          <span class="hits">1857</span>
          
          <code class="ruby">        client.index({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">          index: client.index_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">          id: document.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">          type: &#39;document&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">          body: document.data,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">          timeout: &#39;5m&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">      def update_without_rescue</code>
        </li>
      
        <li class="covered" data-hits="601" data-linenumber="45">
          <span class="hits">601</span>
          
          <code class="ruby">        if client.nested_partial?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">          update_nested_partial</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="601" data-linenumber="48">
          <span class="hits">601</span>
          
          <code class="ruby">          client.update({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">              index: client.index_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">              id: document.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">              type: &#39;document&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">              body: {doc: document.data},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">              timeout: &#39;5m&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">          })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">      def update_with_rescue</code>
        </li>
      
        <li class="covered" data-hits="100" data-linenumber="59">
          <span class="hits">100</span>
          
          <code class="ruby">        update_without_rescue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      rescue Elasticsearch::Transport::Transport::Errors::NotFound</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">        @skipped = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">      def update_nested_partial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">        if document.is_a?(Array)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">          update_bulk_nested_partial</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">        doc = {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">            index: client.index_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">            id: document.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">            type: &#39;document&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">            body: {doc: document.data},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">            timeout: &#39;5m&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">        root_key = client.options[:nest][&#39;key&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">        partial_path =  client.options[:partial_map][&#39;path&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        # extract some keys of the dotted path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">        path_keys = partial_path.split(&#39;.&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">        first = path_keys.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">        path_keys = path_keys.unshift(root_key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">        # extract the current row&#39;s nested data, in the case we&#39;re appending to an exiting array</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">        nested_item = document.data.dig(*path_keys)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">        # this script will either create the new nested array if it doesn&#39;t exist, or append the nested item</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">        script = &quot;if (ctx._source[&#39;#{root_key}&#39;].#{first} == null) { ctx._source[&#39;#{root_key}&#39;].#{first} = data[&#39;#{root_key}&#39;].#{first}; } else { ctx._source[&#39;#{root_key}&#39;].#{partial_path} += inner; }&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">        doc[:body] = { script: script, params: { inner: nested_item, data: document.data } }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">        doc[:retry_on_conflict] = 5</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        client.update(doc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">      def update_bulk_nested_partial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">        root_key = client.options[:nest][&#39;key&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">        partial_path =  client.options[:partial_map][&#39;path&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">        # extract some keys of the dotted path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        path_keys = partial_path.split(&#39;.&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        first = path_keys.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        path_keys = path_keys.unshift(root_key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">        nested_items = document.map do |doc|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">          doc.data.dig(*path_keys)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">        hash = NestedHash.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        hash.dotkey_set(path_keys.join(&#39;.&#39;), nested_items)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">        doc = {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">            index: client.index_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">            id: document[0].id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">            type: &#39;document&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">            timeout: &#39;5m&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">        # this script will either create the full object path and new nested array if it doesn&#39;t exist already, or create the new nested items array</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">        script = &quot;if (ctx._source[&#39;#{root_key}&#39;] == null) { ctx._source[&#39;#{root_key}&#39;] = data[&#39;#{root_key}&#39;]; } else { if (ctx._source[&#39;#{root_key}&#39;].#{first} == null) { ctx._source[&#39;#{root_key}&#39;].#{first} = data[&#39;#{root_key}&#39;].#{first}; } else { ctx._source[&#39;#{root_key}&#39;].#{partial_path} = inner; } }&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">        doc[:body] = { script: script, params: { inner: nested_items, data: hash } }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">        doc[:retry_on_conflict] = 5</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">        client.update(doc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ba94503355ea8a8fea823fcfcabb083e5fd9bd4c">
  <div class="header">
    <h3>lib/data_magic/index/row_bulk_importer.rb</h3>
    <h4><span class="red">45.24 %</span> covered</h4>
    <div>
      <b>42</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>23</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;forwardable&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module DataMagic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  module Index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    class RowBulkImporter</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :rows, :importer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(rows, importer)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">        @rows = rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        @importer = importer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">      def process</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">        log_row_start</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">        before_save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">        save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">        after_save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        log_row_end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      def documents</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        @documents ||= DocumentBuilder.create(rows, importer.builder_data, config)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      def repository</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        @repository ||= Repository.new(importer.client, documents)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">      def log_row_start</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        trigger(&quot;debug&quot;, &quot;csv parsed&quot;) if importer.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        trigger(&quot;info&quot;, &quot;row #{importer.row_count}&quot;, documents, 500) if importer.row_count % 500 == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">        #trigger(&quot;info&quot;, &quot;id&quot;, document.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        if documents[0].id_empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">          trigger(&quot;warn&quot;, &quot;blank id&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">          trigger(&quot;warn&quot;, &quot;unique&quot;, config.data[&quot;unique&quot;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">          trigger(&quot;warn&quot;, &quot;in row&quot;, documents, 255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">      def before_save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        importer.set_headers(documents)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">      def save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        repository.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      def after_save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">        importer.skipping(documents[0].id) if repository.skipped?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">        importer.increment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">      def log_row_end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">        return if !importer.at_limit?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        trigger(&quot;info&quot;, &quot;done now, limiting rows to #{importer.row_count}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">      def config</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        DataMagic.config</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">      extend Forwardable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">      def_delegators :importer, :trigger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.process(*args)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">        new(*args).process</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f8eb249d34fbdd010dcf185b342f1f11ba9549a4">
  <div class="header">
    <h3>lib/data_magic/index/row_importer.rb</h3>
    <h4><span class="green">92.86 %</span> covered</h4>
    <div>
      <b>42</b> relevant lines. 
      <span class="green"><b>39</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;forwardable&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module DataMagic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  module Index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    class RowImporter</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :row, :importer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(row, importer)</code>
        </li>
      
        <li class="covered" data-hits="2453" data-linenumber="9">
          <span class="hits">2453</span>
          
          <code class="ruby">        @row = row</code>
        </li>
      
        <li class="covered" data-hits="2453" data-linenumber="10">
          <span class="hits">2453</span>
          
          <code class="ruby">        @importer = importer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">      def process</code>
        </li>
      
        <li class="covered" data-hits="2453" data-linenumber="14">
          <span class="hits">2453</span>
          
          <code class="ruby">        log_row_start</code>
        </li>
      
        <li class="covered" data-hits="2452" data-linenumber="15">
          <span class="hits">2452</span>
          
          <code class="ruby">        before_save</code>
        </li>
      
        <li class="covered" data-hits="2452" data-linenumber="16">
          <span class="hits">2452</span>
          
          <code class="ruby">        save</code>
        </li>
      
        <li class="covered" data-hits="2452" data-linenumber="17">
          <span class="hits">2452</span>
          
          <code class="ruby">        after_save</code>
        </li>
      
        <li class="covered" data-hits="2452" data-linenumber="18">
          <span class="hits">2452</span>
          
          <code class="ruby">        log_row_end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      def document</code>
        </li>
      
        <li class="covered" data-hits="7492" data-linenumber="22">
          <span class="hits">7492</span>
          
          <code class="ruby">        @document ||= DocumentBuilder.create(row, importer.builder_data, config)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      def repository</code>
        </li>
      
        <li class="covered" data-hits="4904" data-linenumber="26">
          <span class="hits">4904</span>
          
          <code class="ruby">        @repository ||= Repository.new(importer.client, document)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">      def log_row_start</code>
        </li>
      
        <li class="covered" data-hits="2453" data-linenumber="32">
          <span class="hits">2453</span>
          
          <code class="ruby">        trigger(&quot;debug&quot;, &quot;csv parsed&quot;) if importer.empty?</code>
        </li>
      
        <li class="covered" data-hits="2453" data-linenumber="33">
          <span class="hits">2453</span>
          
          <code class="ruby">        trigger(&quot;info&quot;, &quot;row #{importer.row_count}&quot;, document, 500) if importer.row_count % 500 == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">        #trigger(&quot;info&quot;, &quot;id&quot;, document.id)</code>
        </li>
      
        <li class="covered" data-hits="2452" data-linenumber="35">
          <span class="hits">2452</span>
          
          <code class="ruby">        if document.id_empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">          trigger(&quot;warn&quot;, &quot;blank id&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">          trigger(&quot;warn&quot;, &quot;unique&quot;, config.data[&quot;unique&quot;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">          trigger(&quot;warn&quot;, &quot;in row&quot;, document, 255)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">      def before_save</code>
        </li>
      
        <li class="covered" data-hits="2452" data-linenumber="43">
          <span class="hits">2452</span>
          
          <code class="ruby">        importer.set_headers(document)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">      def save</code>
        </li>
      
        <li class="covered" data-hits="2452" data-linenumber="47">
          <span class="hits">2452</span>
          
          <code class="ruby">        repository.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      def after_save</code>
        </li>
      
        <li class="covered" data-hits="2452" data-linenumber="51">
          <span class="hits">2452</span>
          
          <code class="ruby">        importer.skipping(document.id) if repository.skipped?</code>
        </li>
      
        <li class="covered" data-hits="2452" data-linenumber="52">
          <span class="hits">2452</span>
          
          <code class="ruby">        importer.increment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">      def log_row_end</code>
        </li>
      
        <li class="covered" data-hits="2452" data-linenumber="56">
          <span class="hits">2452</span>
          
          <code class="ruby">        return if !importer.at_limit?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="57">
          <span class="hits">3</span>
          
          <code class="ruby">        trigger(&quot;info&quot;, &quot;done now, limiting rows to #{importer.row_count}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">      def config</code>
        </li>
      
        <li class="covered" data-hits="2453" data-linenumber="61">
          <span class="hits">2453</span>
          
          <code class="ruby">        DataMagic.config</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">      extend Forwardable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">      def_delegators :importer, :trigger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">      def self.process(*args)</code>
        </li>
      
        <li class="covered" data-hits="2453" data-linenumber="69">
          <span class="hits">2453</span>
          
          <code class="ruby">        new(*args).process</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="3b7d0645eeb54fd542a7fb2154071259e27f7084">
  <div class="header">
    <h3>lib/data_magic/index/row_map.rb</h3>
    <h4><span class="green">93.33 %</span> covered</h4>
    <div>
      <b>15</b> relevant lines. 
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module DataMagic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module Index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    class RowMap</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">        attr_reader :map, :id, :related</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">        def initialize(primary_key, join_key)</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="7">
          <span class="hits">72</span>
          
          <code class="ruby">          @id = calculate_column(primary_key)</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="8">
          <span class="hits">72</span>
          
          <code class="ruby">          @related = calculate_column(join_key)</code>
        </li>
      
        <li class="covered" data-hits="72" data-linenumber="9">
          <span class="hits">72</span>
          
          <code class="ruby">          @map = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">        def add_item(row)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">          # only add unique ids to the related key array</code>
        </li>
      
        <li class="covered" data-hits="1326" data-linenumber="14">
          <span class="hits">1326</span>
          
          <code class="ruby">          @map[row[@related]] = (@map[row[@related]] ||= []) | [row[@id]]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">        def map</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">          @map</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">        def calculate_column(value)</code>
        </li>
      
        <li class="covered" data-hits="144" data-linenumber="22">
          <span class="hits">144</span>
          
          <code class="ruby">          column_name = DataMagic::config.field_mapping.invert[value]</code>
        </li>
      
        <li class="covered" data-hits="144" data-linenumber="23">
          <span class="hits">144</span>
          
          <code class="ruby">          column_name.to_sym unless column_name.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="138028bf9adf29470920d1e39c2b03dc5afebb4e">
  <div class="header">
    <h3>lib/data_magic/index/super_client.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>24</b> relevant lines. 
      <span class="green"><b>24</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;forwardable&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module DataMagic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  module Index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    class SuperClient</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      attr_reader :client, :options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      def initialize(client, options)</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="9">
          <span class="hits">138</span>
          
          <code class="ruby">        @client = client</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="10">
          <span class="hits">138</span>
          
          <code class="ruby">        @options = options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">      def create_index</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="14">
          <span class="hits">138</span>
          
          <code class="ruby">        DataMagic.create_index unless config.index_exists?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      def refresh_index</code>
        </li>
      
        <li class="covered" data-hits="135" data-linenumber="18">
          <span class="hits">135</span>
          
          <code class="ruby">        client.indices.refresh index: index_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      def creating?</code>
        </li>
      
        <li class="covered" data-hits="2452" data-linenumber="22">
          <span class="hits">2452</span>
          
          <code class="ruby">        options[:root] || options[:nest] == nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      def nested_partial?</code>
        </li>
      
        <li class="covered" data-hits="3051" data-linenumber="26">
          <span class="hits">3051</span>
          
          <code class="ruby">        options[:map]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">      def allow_skips?</code>
        </li>
      
        <li class="covered" data-hits="597" data-linenumber="30">
          <span class="hits">597</span>
          
          <code class="ruby">        options[:nest][:parent_missing] == &#39;skip&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">      def index_name</code>
        </li>
      
        <li class="covered" data-hits="2587" data-linenumber="34">
          <span class="hits">2587</span>
          
          <code class="ruby">        config.scoped_index_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">      def config</code>
        </li>
      
        <li class="covered" data-hits="2725" data-linenumber="38">
          <span class="hits">2725</span>
          
          <code class="ruby">        DataMagic.config</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      extend Forwardable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">      def_delegators :client, :index, :update</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="675f8943c06ee5538f405cb43bf80ea0c8f67c0e">
  <div class="header">
    <h3>lib/data_magic/query_builder.rb</h3>
    <h4><span class="red">63.27 %</span> covered</h4>
    <div>
      <b>196</b> relevant lines. 
      <span class="green"><b>124</b> lines covered</span> and
      <span class="red"><b>72</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module DataMagic</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  module QueryBuilder</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">    class &lt;&lt; self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">      # Creates query from parameters passed into endpoint and returns a Hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">      def from_params(params, options, config)</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="6">
          <span class="hits">109</span>
          
          <code class="ruby">        per_page = (options[:per_page] || config.page_size || DataMagic::DEFAULT_PAGE_SIZE).to_i</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="7">
          <span class="hits">109</span>
          
          <code class="ruby">        page = options[:page].to_i || 0</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="8">
          <span class="hits">109</span>
          
          <code class="ruby">        per_page = DataMagic::MAX_PAGE_SIZE if per_page &gt; DataMagic::MAX_PAGE_SIZE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">        query_hash = {</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="11">
          <span class="hits">109</span>
          
          <code class="ruby">          post_es_response: {},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">          from:             page * per_page,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">          size:             per_page,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">        # check options[:fields] - are any nested data type?</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="17">
          <span class="hits">109</span>
          
          <code class="ruby">        nested_fields = !options[:fields].nil? ? nested_fields(options[:fields]) : []</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="18">
          <span class="hits">109</span>
          
          <code class="ruby">        query_fields  = !options[:fields].nil? ? options[:fields] - nested_fields : []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">        # check params keys - are any nested data type?</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="21">
          <span class="hits">109</span>
          
          <code class="ruby">        term_pairs = determine_query_term_datatypes(params)</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="22">
          <span class="hits">109</span>
          
          <code class="ruby">        nested_query_pairs = term_pairs[:nested_query_pairs]</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="23">
          <span class="hits">109</span>
          
          <code class="ruby">        query_pairs        = term_pairs[:query_pairs]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        # Use stretchy to build query</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="26">
          <span class="hits">109</span>
          
          <code class="ruby">        squery = generate_squery(query_pairs, options, config)</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="27">
          <span class="hits">109</span>
          
          <code class="ruby">        query_hash[:query] = squery.request[:body][:query]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="29">
          <span class="hits">109</span>
          
          <code class="ruby">        nested_query = false</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="30">
          <span class="hits">109</span>
          
          <code class="ruby">        if !nested_query_pairs.empty? &amp;&amp; query_pairs.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">          build_query_from_nested_datatypes(nested_query_pairs, query_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">          nested_query = true</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="33">
          <span class="hits">109</span>
          
          <code class="ruby">        elsif !nested_query_pairs.empty? &amp;&amp; !query_pairs.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">          build_query_from_nested_and_nonnested_datatypes(nested_query_pairs, query_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">          nested_query = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="38">
          <span class="hits">109</span>
          
          <code class="ruby">        if !query_fields.empty?</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="39">
          <span class="hits">32</span>
          
          <code class="ruby">          query_hash[:fields] = query_fields</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="42">
          <span class="hits">109</span>
          
          <code class="ruby">        query_hash[:query].except!(:match_all) unless query_hash[:query][:bool].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        # TODO - Revisit ./spec/lib/data_magic/query_builder_spec.rb:28</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">        # That test broke, when the following line was no longer wrapped in a condtional, if query_hash[:query][:bool]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">        # When I commented out the line, nothing broke.. not sure if it is relevant.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">        # query_hash[:query].except!( :terms)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="49">
          <span class="hits">109</span>
          
          <code class="ruby">        if options[:command] == &#39;stats&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="50">
          <span class="hits">2</span>
          
          <code class="ruby">          query_hash.merge! add_aggregations(params, options, config)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="53">
          <span class="hits">109</span>
          
          <code class="ruby">        query_hash = set_query_source(query_hash, nested_query, nested_fields, query_fields)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="55">
          <span class="hits">109</span>
          
          <code class="ruby">        query_hash[:sort] = get_sort_order(options[:sort], config) if options[:sort] &amp;&amp; !options[:sort].empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="57">
          <span class="hits">109</span>
          
          <code class="ruby">        query_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">      def generate_squery(params, options, config)</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="63">
          <span class="hits">109</span>
          
          <code class="ruby">        squery = Stretchy.query(type: &#39;document&#39;)</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="64">
          <span class="hits">109</span>
          
          <code class="ruby">        squery = search_location(squery, options)</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="65">
          <span class="hits">109</span>
          
          <code class="ruby">        search_fields_and_ranges(squery, params, config)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      # Wrapper for Stretchy aggregation clause builder (which wraps ElasticSearch (ES) :aggs parameter)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      # Extracts all extended_stats aggregations from ES, to be filtered later</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      # Is a no-op if no fields are specified, or none of them are numeric</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">      def add_aggregations(params, options, config)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="72">
          <span class="hits">2</span>
          
          <code class="ruby">        agg_hash = options[:fields].inject({}) do |memo, f|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="73">
          <span class="hits">6</span>
          
          <code class="ruby">          if config.column_field_types[f.to_s] &amp;&amp; [&quot;integer&quot;, &quot;float&quot;].include?(config.column_field_types[f.to_s])</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="74">
          <span class="hits">4</span>
          
          <code class="ruby">            memo[f.to_s] = { extended_stats: { &quot;field&quot; =&gt; f.to_s } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="76">
          <span class="hits">6</span>
          
          <code class="ruby">          memo</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="79">
          <span class="hits">2</span>
          
          <code class="ruby">        agg_hash.empty? ? {} : { aggs: agg_hash }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">      def nested_data_types()</code>
        </li>
      
        <li class="covered" data-hits="117" data-linenumber="83">
          <span class="hits">117</span>
          
          <code class="ruby">        DataMagic.config.es_data_types[&quot;nested&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">      def field_type_nested?(field_name)</code>
        </li>
      
        <li class="covered" data-hits="117" data-linenumber="87">
          <span class="hits">117</span>
          
          <code class="ruby">        if nested_data_types()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">          nested_data_types().any? {|nested| field_name.start_with? nested }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">      def nested_fields(submitted_fields)</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="93">
          <span class="hits">32</span>
          
          <code class="ruby">        nested_fields = []</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="94">
          <span class="hits">32</span>
          
          <code class="ruby">        if !submitted_fields.empty?</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="95">
          <span class="hits">32</span>
          
          <code class="ruby">          submitted_fields.each do |field_name|</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="96">
          <span class="hits">41</span>
          
          <code class="ruby">            if field_type_nested?(field_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">              nested_fields.push(field_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="101">
          <span class="hits">32</span>
          
          <code class="ruby">        nested_fields</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">      def determine_query_term_datatypes(params)</code>
        </li>
      
        <li class="covered" data-hits="185" data-linenumber="105">
          <span class="hits">185</span>
          
          <code class="ruby">        nested_terms = params.keys.select { |key| field_type_nested?(key) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="107">
          <span class="hits">109</span>
          
          <code class="ruby">        nested_query_pairs = {}</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="108">
          <span class="hits">109</span>
          
          <code class="ruby">        nested_terms.each { |key| nested_query_pairs[key] = params[key] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="110">
          <span class="hits">109</span>
          
          <code class="ruby">        if !nested_terms.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">          nested_terms.each do |key|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">            params.except!( key )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="116">
          <span class="hits">109</span>
          
          <code class="ruby">        query_pairs = params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="119">
          <span class="hits">109</span>
          
          <code class="ruby">          nested_query_pairs: nested_query_pairs,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">          query_pairs:        query_pairs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">      def outer_range_wrapper(key, range_values)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">        field = key.chomp(&quot;__range&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">        range_hash = { </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">          or: [{</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">            range: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">              field =&gt; range_values</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">          }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">        range_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_nested_range_query(key, value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">        range_params = value.split(&quot;..&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">        first, last = range_params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">        if !first.empty? &amp;&amp; !last.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">          range_values = { gte: first, lte: last } </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">        elsif first.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">          range_values = { lte: last }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">          range_values = { gte: first }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">        range_hash = outer_range_wrapper(key, range_values)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">        range_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">      def sort_nested_query_paths_and_terms(nested_query_pairs)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">        paths_and_terms = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">        nested_query_pairs.each do |key, value|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">          if nested_data_types.any? {|nested| key.start_with? nested }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">            path = nested_data_types.select {|nested| key.start_with? nested }.join(&quot;&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">          range_query = key.include?(&quot;__range&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">          if range_query</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">            query_term = get_nested_range_query(key, value)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">            query_term = { match: { key =&gt; value }}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">          paths_and_terms.push({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">            path: path,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">            term: query_term</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">          })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">        paths_and_terms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="176">
          <span class="hits">1</span>
          
          <code class="ruby">      def build_nested_query(nested_query_pairs)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">        paths_and_terms = sort_nested_query_paths_and_terms(nested_query_pairs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">        paths = Set[]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">        paths_and_terms.each { |hash| paths.add(hash[:path]) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">        if paths.length == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">          path         = paths.to_a[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">          terms        = paths_and_terms.map { |item| item[:term] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">          nested_query = get_inner_nested_query(path, terms)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">        nested_query</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_outer_nested_query(inner_queries)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">        { must: inner_queries }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="195">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_inner_nested_query(path, matches)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">        { </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">          nested: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">            path: path,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">            query: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">              bool: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">                must: matches</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">              }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">            },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">            inner_hits: {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="209">
          <span class="hits">1</span>
          
          <code class="ruby">      def add_bool_to_query_hash(query_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">        query_hash[:query][:bool] = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="213">
          <span class="hits">1</span>
          
          <code class="ruby">      def add_filter_key_to_bool_on_query_hash(query_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">        query_hash[:query][:bool][:filter] = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">        query_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="219">
          <span class="hits">1</span>
          
          <code class="ruby">      def add_must_key_to_bool_on_query_hash(query_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">        query_hash[:query][:bool][:must] = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">        query_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="225">
          <span class="hits">1</span>
          
          <code class="ruby">      def build_query_from_nested_datatypes(nested_query_pairs, query_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">        add_bool_to_query_hash(query_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">        add_filter_key_to_bool_on_query_hash(query_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">        query_hash[:query][:bool][:filter] = build_nested_query(nested_query_pairs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">        query_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">      def incorporate_nested_with_filter_query(query_hash, nested_query_pairs)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">        nested_query = build_nested_query(nested_query_pairs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">        query_hash[:query][:bool][:filter].push(nested_query)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">        query_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="242">
          <span class="hits">1</span>
          
          <code class="ruby">      def move_common_key_to_must_key_on_query_hash(query_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="243">
          
          
          <code class="ruby">        common = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">        common[:common] = query_hash[:query][:common]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">        query_hash[:query].delete(:common)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="247">
          
          
          <code class="ruby">        query_hash[:query][:bool][:must] = common</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">        query_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="252">
          <span class="hits">1</span>
          
          <code class="ruby">      def incorporate_nested_with_autocomplete_query(query_hash, nested_query_pairs)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">        if (query_hash.dig(:query,:bool).nil?)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">          add_bool_to_query_hash(query_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">        if (query_hash.dig(:query,:bool,:must).nil?)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">          add_must_key_to_bool_on_query_hash(query_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">          move_common_key_to_must_key_on_query_hash(query_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">          add_filter_key_to_bool_on_query_hash(query_hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="264">
          
          
          <code class="ruby">        query_hash[:query][:bool][:filter] = build_nested_query(nested_query_pairs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="266">
          
          
          <code class="ruby">        query_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="269">
          <span class="hits">1</span>
          
          <code class="ruby">      def build_query_from_nested_and_nonnested_datatypes(nested_query_pairs, query_hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">        if !query_hash.dig(:query,:bool,:filter).nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">          query_hash_with_nested_query = incorporate_nested_with_filter_query(query_hash, nested_query_pairs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">          query_hash_with_nested_query = incorporate_nested_with_autocomplete_query(query_hash, nested_query_pairs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">        query_hash_with_nested_query</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="279">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_restrict_fields(options)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">        options[:fields].map(&amp;:to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">      # @description turns a string like &quot;state,population:desc&quot; into [{&#39;state&#39; =&gt; {order: &#39;asc&#39;}},{ &quot;population&quot; =&gt; {order: &quot;desc&quot;} }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">      # @param [String] sort_param</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">      # @return [Array]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="286">
          <span class="hits">1</span>
          
          <code class="ruby">      def get_sort_order(sort_param, config)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="287">
          <span class="hits">9</span>
          
          <code class="ruby">        sort_param.to_s.scan(/(\w+[\.\w]*):?(\w*)/).map do |field_name, direction|</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="288">
          <span class="hits">13</span>
          
          <code class="ruby">          direction = &#39;asc&#39; if direction.empty?</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="289">
          <span class="hits">13</span>
          
          <code class="ruby">          type = config.field_type(field_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">          # for &#39;autocomplete&#39; search on lowercase not analyzed indexed in _name</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="291">
          <span class="hits">13</span>
          
          <code class="ruby">          field_name = &quot;_#{field_name}&quot; if type  == &#39;autocomplete&#39;</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="292">
          <span class="hits">13</span>
          
          <code class="ruby">          { field_name =&gt; { order: direction } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="296">
          <span class="hits">1</span>
          
          <code class="ruby">      def to_number(value)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="297">
          <span class="hits">18</span>
          
          <code class="ruby">        value =~ /\./ ? value.to_f : value.to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="300">
          <span class="hits">1</span>
          
          <code class="ruby">      def search_fields_and_ranges(squery, params, config)</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="301">
          <span class="hits">109</span>
          
          <code class="ruby">        params.each do |param, value|</code>
        </li>
      
        <li class="covered" data-hits="76" data-linenumber="302">
          <span class="hits">76</span>
          
          <code class="ruby">          field_type = config.field_type(param)</code>
        </li>
      
        <li class="covered" data-hits="76" data-linenumber="303">
          <span class="hits">76</span>
          
          <code class="ruby">          if field_type == &quot;name&quot;</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="304">
          <span class="hits">6</span>
          
          <code class="ruby">            squery = include_name_query(squery, param, value)</code>
        </li>
      
        <li class="covered" data-hits="70" data-linenumber="305">
          <span class="hits">70</span>
          
          <code class="ruby">          elsif field_type == &quot;autocomplete&quot;</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="306">
          <span class="hits">18</span>
          
          <code class="ruby">            squery = autocomplete_query(squery, param, value)</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="307">
          <span class="hits">52</span>
          
          <code class="ruby">          elsif match = /(.+)__(range|ne|not)\z/.match(param)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="308">
          <span class="hits">16</span>
          
          <code class="ruby">            field, operator = match.captures.map(&amp;:to_sym)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="309">
          <span class="hits">16</span>
          
          <code class="ruby">            squery = range_query(squery, operator, field, value)</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="310">
          <span class="hits">36</span>
          
          <code class="ruby">          elsif field_type == &quot;integer&quot; &amp;&amp; value.is_a?(String) &amp;&amp; /,/.match(value) # list of integers</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="311">
          <span class="hits">3</span>
          
          <code class="ruby">            squery = integer_list_query(squery, param, value)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">          else # field equality</code>
        </li>
      
        <li class="covered" data-hits="33" data-linenumber="313">
          <span class="hits">33</span>
          
          <code class="ruby">            squery = squery.filter.match(param =&gt; value)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="316">
          <span class="hits">109</span>
          
          <code class="ruby">        squery</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="319">
          <span class="hits">1</span>
          
          <code class="ruby">      def include_name_query(squery, field, value)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="320">
          <span class="hits">16</span>
          
          <code class="ruby">        value = value.split(&#39; &#39;).map { |word| &quot;#{word}*&quot;}.join(&#39; &#39;)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="321">
          <span class="hits">6</span>
          
          <code class="ruby">        squery.match.query(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">          # we store lowercase name in field with prefix _</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">          &quot;wildcard&quot;: { &quot;_#{field}&quot; =&gt; { &quot;value&quot;: value.downcase } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="327">
          <span class="hits">1</span>
          
          <code class="ruby">      def range_query(squery, operator, field, value)</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="328">
          <span class="hits">16</span>
          
          <code class="ruby">        if operator == :ne or operator == :not # field negation</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="329">
          <span class="hits">6</span>
          
          <code class="ruby">          squery.where.not(field =&gt; value)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">        else # field range</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="331">
          <span class="hits">10</span>
          
          <code class="ruby">          squery.filter(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">            or: build_ranges(field, value.split(&#39;,&#39;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby">          )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="337">
          <span class="hits">1</span>
          
          <code class="ruby">      def autocomplete_query(squery, field, value)</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="338">
          <span class="hits">18</span>
          
          <code class="ruby">        squery.match.query(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby">          common: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">            field =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby">              query: value,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">              cutoff_frequency: 0.001,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">              low_freq_operator: &quot;and&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">          })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="348">
          <span class="hits">1</span>
          
          <code class="ruby">      def integer_list_query(squery, field, value)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="349">
          <span class="hits">3</span>
          
          <code class="ruby">        squery.filter(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby">          terms: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">            field =&gt; value.split(&#39;,&#39;).map(&amp;:to_i) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="355">
          <span class="hits">1</span>
          
          <code class="ruby">      def build_ranges(field, range_strings)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="356">
          <span class="hits">10</span>
          
          <code class="ruby">        range_strings.map do |range|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="357">
          <span class="hits">12</span>
          
          <code class="ruby">          min, max = range.split(&#39;..&#39;)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="358">
          <span class="hits">12</span>
          
          <code class="ruby">          values = {}</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="359">
          <span class="hits">12</span>
          
          <code class="ruby">          values[:gte] = to_number(min) unless min.empty?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="360">
          <span class="hits">12</span>
          
          <code class="ruby">          values[:lte] = to_number(max) if max</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">          {</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="362">
          <span class="hits">12</span>
          
          <code class="ruby">            range: { field =&gt; values }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">      # Handles location (currently only uses SFO location)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="368">
          <span class="hits">1</span>
          
          <code class="ruby">      def search_location(squery, options)</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="369">
          <span class="hits">109</span>
          
          <code class="ruby">        distance = options[:distance]</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="370">
          <span class="hits">109</span>
          
          <code class="ruby">        location = Zipcode.latlon(options[:zip])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="372">
          <span class="hits">109</span>
          
          <code class="ruby">        if distance &amp;&amp; !distance.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby">          # default to miles if no distance given</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="374">
          <span class="hits">3</span>
          
          <code class="ruby">          unit = distance[-2..-1]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="375">
          <span class="hits">3</span>
          
          <code class="ruby">          distance = &quot;#{distance}mi&quot; if unit != &quot;km&quot; and unit != &quot;mi&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="376">
          <span class="hits">3</span>
          
          <code class="ruby">          squery = squery.geo_distance(field: &#39;coords&#39;, distance: distance, location: {lat: location[:lat], lon: location[:lon]})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="378">
          <span class="hits">109</span>
          
          <code class="ruby">        squery</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="381">
          <span class="hits">1</span>
          
          <code class="ruby">      def set_query_source(query_hash, nested_query, nested_fields, query_fields)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby">        # CASES</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby">        # - not a nested query, but the listed fields are nested datatypes - then set up a source filter</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">        # - is a nested query and no fields specified</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby">        # - is a nested query and fields are specified &gt;&gt; the nested field types can&#39;t be retrieved via ES</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby">            # figure out how to select fields from inner hits during result processing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby">        # Source filter will contain fields that come from nested datatypes (not to be confused with nested fields, as a structure)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby">        # if there is a nested_query AND if there are query_fields AND no nested fields</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="390">
          <span class="hits">109</span>
          
          <code class="ruby">        if nested_query || (!query_fields.empty? &amp;&amp; nested_fields.empty?)</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="391">
          <span class="hits">32</span>
          
          <code class="ruby">          query_hash[:_source] = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby">        # if this is NOT a nested_query AND there are nested fields, then filter source on those fields</code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="393">
          <span class="hits">77</span>
          
          <code class="ruby">        elsif !nested_query &amp;&amp; !nested_fields.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">            query_hash[:_source] = nested_fields</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">        # if neither fields, nor a source filter, then exclude fields from source beginning with underscores</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="397">
          <span class="hits">77</span>
          
          <code class="ruby">          query_hash[:_source] = { exclude: [&quot;_*&quot;] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="398">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby">        # if this is a nested_query AND there are nested fields, then those fields should be passed to post_es_response key, rather than :_source</code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="401">
          <span class="hits">109</span>
          
          <code class="ruby">        if nested_query &amp;&amp; !nested_fields.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="402">
          
          
          <code class="ruby">          query_hash[:post_es_response][:nested_fields_filter] = nested_fields</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="109" data-linenumber="405">
          <span class="hits">109</span>
          
          <code class="ruby">        query_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="407">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="409">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="77bff3ab847a1af317d3fc9f18af280e003a446e">
  <div class="header">
    <h3>lib/expression/eval.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>8</b> relevant lines. 
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">class Expression</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  class Eval &lt; Parslet::Transform</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">    rule(:var =&gt; simple(:var)) {</code>
        </li>
      
        <li class="covered" data-hits="55" data-linenumber="5">
          <span class="hits">55</span>
          
          <code class="ruby">      variables[String(var)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    # in Ruby 0 is &#39;truthy&#39; but that&#39;s not what most people expect</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    rule(:or =&gt; { :left =&gt; subtree(:left), :right =&gt; subtree(:right) }) do</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="10">
          <span class="hits">25</span>
          
          <code class="ruby">      left == 0 ? right : (left or right)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    rule(:and =&gt; { :left =&gt; subtree(:left), :right =&gt; subtree(:right) }) do</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="14">
          <span class="hits">4</span>
          
          <code class="ruby">      left == 0 ? left : (left and right)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b52dd238c5d4a115d3c782c56aba486e4d18a9af">
  <div class="header">
    <h3>lib/expression/expression.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>17</b> relevant lines. 
      <span class="green"><b>17</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;parser&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;eval&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;variables&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;hashie&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">class Expression</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :name   # purely for reporting Errors</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_reader   :variables</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize(expr, name = &#39;unknown&#39;)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="11">
          <span class="hits">10</span>
          
          <code class="ruby">    @tree = Parser.new.parse(expr)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="12">
          <span class="hits">10</span>
          
          <code class="ruby">    @variables = Variables.new.apply(@tree)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  def evaluate(vars)</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="16">
          <span class="hits">20</span>
          
          <code class="ruby">    Hashie.stringify_keys! vars</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="17">
          <span class="hits">20</span>
          
          <code class="ruby">    Eval.new.apply(@tree, variables: vars)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.find_or_create(expr, name = &#39;unknown&#39;)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="21">
          <span class="hits">12</span>
          
          <code class="ruby">    @cached_expression ||= {}</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="22">
          <span class="hits">12</span>
          
          <code class="ruby">    @cached_expression[expr] ||= Expression.new(expr, name)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="23">
          <span class="hits">12</span>
          
          <code class="ruby">    @cached_expression[expr]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="2ec554d225e49cff5c98675bd7b6faee22e36c62">
  <div class="header">
    <h3>lib/expression/parser.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>16</b> relevant lines. 
      <span class="green"><b>16</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;parslet&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># based on https://github.com/kschiess/parslet/blob/master/example/boolean_algebra.rb</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># usage:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># def parse(str)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#   ExpressionParser.new.parse(str)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"># rescue Parslet::ParseFailed =&gt; failure</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">#   puts failure.cause.ascii_tree</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"># end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"># tree = ExpressionParser.new.parse(&quot;one or two&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">#  =&gt; {:or=&gt;{:left=&gt;{:var=&gt;&quot;one&quot;@0}, :right=&gt;{:var=&gt;&quot;two&quot;@7}}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"># Eval.new.apply(tree, variables: {&quot;one&quot;=&gt;1, &quot;two&quot;=&gt;2})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"># Variables.new.apply(tree)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">class Expression</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  class Parser &lt; Parslet::Parser</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="19">
          <span class="hits">27</span>
          
          <code class="ruby">  rule(:space)  { match[&quot; &quot;].repeat(1) }</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="20">
          <span class="hits">27</span>
          
          <code class="ruby">  rule(:space?) { space.maybe }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="22">
          <span class="hits">27</span>
          
          <code class="ruby">  rule(:lparen) { str(&quot;(&quot;) &gt;&gt; space? }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="23">
          <span class="hits">5</span>
          
          <code class="ruby">  rule(:rparen) { str(&quot;)&quot;) &gt;&gt; space? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="25">
          <span class="hits">27</span>
          
          <code class="ruby">  rule(:and_operator) { str(&quot;and&quot;) &gt;&gt; space? }</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="26">
          <span class="hits">27</span>
          
          <code class="ruby">  rule(:or_operator)  { str(&quot;or&quot;)  &gt;&gt; space? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="28">
          <span class="hits">27</span>
          
          <code class="ruby">  rule(:var) { match[&quot;[^\s\(\)]&quot;].repeat(1).as(:var) &gt;&gt; space? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  # The primary rule deals with parentheses.</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="31">
          <span class="hits">27</span>
          
          <code class="ruby">  rule(:primary) { lparen &gt;&gt; or_operation &gt;&gt; rparen | var }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  # Note that following rules are both right-recursive.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  rule(:and_operation) {</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="35">
          <span class="hits">26</span>
          
          <code class="ruby">    (primary.as(:left) &gt;&gt; and_operator &gt;&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      and_operation.as(:right)).as(:and) |</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    primary }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  rule(:or_operation)  {</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="40">
          <span class="hits">26</span>
          
          <code class="ruby">    (and_operation.as(:left) &gt;&gt; or_operator &gt;&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      or_operation.as(:right)).as(:or) |</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    and_operation }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  # We start at the lowest precedence rule.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  root(:or_operation)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="0587cf3e9eac301ec534f180c2adfeda0edd584f">
  <div class="header">
    <h3>lib/expression/variables.rb</h3>
    <h4><span class="yellow">88.89 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;parslet&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Expression</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  class Variables &lt; Parslet::Transform</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    rule(:var =&gt; simple(:var)) {</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="6">
          <span class="hits">25</span>
          
          <code class="ruby">      [String(var)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    rule(:or =&gt; { :left =&gt; subtree(:left), :right =&gt; subtree(:right) }) do</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="9">
          <span class="hits">12</span>
          
          <code class="ruby">      (left + right)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    rule(:and =&gt; { :left =&gt; subtree(:left), :right =&gt; subtree(:right) }) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      (left + right)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7bf6bf19af5d715f246e7831a915ff4deb9799cf">
  <div class="header">
    <h3>lib/nested_hash.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>38</b> relevant lines. 
      <span class="green"><b>38</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class NestedHash &lt; Hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize(hash = {}, default = nil, &amp;block)</code>
        </li>
      
        <li class="covered" data-hits="2642" data-linenumber="4">
          <span class="hits">2642</span>
          
          <code class="ruby">    default ? super(default) : super(&amp;block)</code>
        </li>
      
        <li class="covered" data-hits="2642" data-linenumber="5">
          <span class="hits">2642</span>
          
          <code class="ruby">    self.add(hash)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def add(hash)</code>
        </li>
      
        <li class="covered" data-hits="5228" data-linenumber="9">
          <span class="hits">5228</span>
          
          <code class="ruby">    hash.each do |full_name, value|</code>
        </li>
      
        <li class="covered" data-hits="19897" data-linenumber="10">
          <span class="hits">19897</span>
          
          <code class="ruby">      parts = full_name.to_s.split(&#39;.&#39;)</code>
        </li>
      
        <li class="covered" data-hits="19897" data-linenumber="11">
          <span class="hits">19897</span>
          
          <code class="ruby">      last = parts.length - 1</code>
        </li>
      
        <li class="covered" data-hits="19897" data-linenumber="12">
          <span class="hits">19897</span>
          
          <code class="ruby">      add_to = self</code>
        </li>
      
        <li class="covered" data-hits="19897" data-linenumber="13">
          <span class="hits">19897</span>
          
          <code class="ruby">      parts.each_with_index do |name, index|</code>
        </li>
      
        <li class="covered" data-hits="26794" data-linenumber="14">
          <span class="hits">26794</span>
          
          <code class="ruby">        if index == last</code>
        </li>
      
        <li class="covered" data-hits="19897" data-linenumber="15">
          <span class="hits">19897</span>
          
          <code class="ruby">          add_to[name] = value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="6897" data-linenumber="17">
          <span class="hits">6897</span>
          
          <code class="ruby">          add_to[name] ||= {}</code>
        </li>
      
        <li class="covered" data-hits="6897" data-linenumber="18">
          <span class="hits">6897</span>
          
          <code class="ruby">          add_to = add_to[name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="5228" data-linenumber="22">
          <span class="hits">5228</span>
          
          <code class="ruby">    self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  # generate a flat, non-nested hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # with keys that have dots representing the hierarchy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  def withdotkeys(deep_hash = self, flat_hash = {}, root = &#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="28">
          <span class="hits">58</span>
          
          <code class="ruby">    deep_hash.each do |k, value|</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="29">
          <span class="hits">16</span>
          
          <code class="ruby">      key = root + k</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="30">
          <span class="hits">16</span>
          
          <code class="ruby">      if value.is_a?(Hash)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="31">
          <span class="hits">6</span>
          
          <code class="ruby">        flat_hash.merge! withdotkeys(value, flat_hash, key + &#39;.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="33">
          <span class="hits">10</span>
          
          <code class="ruby">        flat_hash[key] = value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="58" data-linenumber="36">
          <span class="hits">58</span>
          
          <code class="ruby">    flat_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  # generate a list of the keys with dots representing the hierarchy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  def dotkeys(row = self, prefix = &#39;&#39;)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="41">
          <span class="hits">8</span>
          
          <code class="ruby">    human_names = []</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="42">
          <span class="hits">8</span>
          
          <code class="ruby">    row.keys.each do |k|</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="43">
          <span class="hits">16</span>
          
          <code class="ruby">      key = prefix + k</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="44">
          <span class="hits">16</span>
          
          <code class="ruby">      if row[k].is_a?(Hash)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="45">
          <span class="hits">6</span>
          
          <code class="ruby">        new_human_names = dotkeys(row[k], key + &#39;.&#39;)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="46">
          <span class="hits">6</span>
          
          <code class="ruby">          human_names += new_human_names</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="48">
          <span class="hits">10</span>
          
          <code class="ruby">        human_names &lt;&lt; key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="51">
          <span class="hits">8</span>
          
          <code class="ruby">    human_names</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  # set a new or existing nested key&#39;s value by a dotted-string key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  def dotkey_set(dottedkey, value, deep_hash = self)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="56">
          <span class="hits">3</span>
          
          <code class="ruby">    keys = dottedkey.to_s.split(&#39;.&#39;)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="57">
          <span class="hits">3</span>
          
          <code class="ruby">    first = keys.first</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="58">
          <span class="hits">3</span>
          
          <code class="ruby">    if keys.length == 1</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">      deep_hash[first] = value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      # in the case that we are creating a hash from a dotted key, we&#39;ll assign a default</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="62">
          <span class="hits">2</span>
          
          <code class="ruby">      deep_hash[first] = (deep_hash[first] || {})</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="63">
          <span class="hits">2</span>
          
          <code class="ruby">      dotkey_set(keys.slice(1..-1).join(&#39;.&#39;), value, deep_hash[first])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="12a6b7059b0a5598c3d8de085332d57991ca14bd">
  <div class="header">
    <h3>lib/sass_initializer.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>6</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module SassInitializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.registered(app)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">    # Enables support for SASS template reloading in rack applications.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">    # See http://nex-3.com/posts/88-sass-supports-rack for more details.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">    # Store SASS files (by default) within &#39;app/stylesheets&#39;.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    require &#39;sass/plugin/rack&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    Sass::Plugin.options[:template_location] = Padrino.root(&quot;app/stylesheets&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    Sass::Plugin.options[:css_location] = Padrino.root(&quot;public/stylesheets&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    app.use Sass::Plugin::Rack</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="fe2c681fa39056b6dd6a76894f79079ffca79a53">
  <div class="header">
    <h3>lib/zipcode/zipcode.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>19</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Zipcode latitude and longitude data in us_zipcodes.txt</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># provided by [GeoNames](http://www.geonames.org/)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># under under a Creative Commons Attribution 3.0 License:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># http://creativecommons.org/licenses/by/3.0/</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"># this code is in public domain (CC0 1.0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"># https://github.com/18F/open-data-maker/blob/dev/LICENSE.md</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">class Zipcode</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  @@zipcode_hash = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def Zipcode.latlon(zipcode)</code>
        </li>
      
        <li class="covered" data-hits="116" data-linenumber="15">
          <span class="hits">116</span>
          
          <code class="ruby">    zipcode = zipcode.to_s</code>
        </li>
      
        <li class="covered" data-hits="116" data-linenumber="16">
          <span class="hits">116</span>
          
          <code class="ruby">    @@zipcode_hash ||= converted_zipcodes</code>
        </li>
      
        <li class="covered" data-hits="116" data-linenumber="17">
          <span class="hits">116</span>
          
          <code class="ruby">    @@zipcode_hash[zipcode]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  def Zipcode.valid?(zipcode)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="21">
          <span class="hits">5</span>
          
          <code class="ruby">    !!self.latlon(zipcode)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    def self.converted_zipcodes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">      parsed_file = CSV.read(File.expand_path(&quot;../us_zipcodes.txt&quot;, __FILE__), { :col_sep =&gt; &quot;\t&quot; })</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">      zipcode_hash = {}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">      parsed_file.each do |row|</code>
        </li>
      
        <li class="covered" data-hits="41722" data-linenumber="29">
          <span class="hits">41722</span>
          
          <code class="ruby">        zipcode = row[1]</code>
        </li>
      
        <li class="covered" data-hits="41722" data-linenumber="30">
          <span class="hits">41722</span>
          
          <code class="ruby">        lat = row[9].to_f</code>
        </li>
      
        <li class="covered" data-hits="41722" data-linenumber="31">
          <span class="hits">41722</span>
          
          <code class="ruby">        lon = row[10].to_f</code>
        </li>
      
        <li class="covered" data-hits="41722" data-linenumber="32">
          <span class="hits">41722</span>
          
          <code class="ruby">        zipcode_hash[zipcode] = {&#39;lat&#39;: lat, &#39;lon&#39;: lon}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">      zipcode_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="583c416ab17440806c5ebf0c7edbff50b09e2feb">
  <div class="header">
    <h3>spec/fixtures/data.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>8</b> relevant lines. 
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Ages adjusted for Springfield residents to average to 42</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Heights randomly set to generate a max of 142</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">def address_data</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="4">
          <span class="hits">3</span>
          
          <code class="ruby">  @address_data ||= StringIO.new &lt;&lt;-eos</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">name,address,city,age,height</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">Paul,15 Penny Lane,Liverpool,10,142</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">Michelle,600 Pennsylvania Avenue,Washington,12,1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">Marilyn,1313 Mockingbird Lane,Springfield,14,2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">Sherlock,221B Baker Street,London,16,123</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">Clark,66 Lois Lane,Smallville,18,141</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">Bart,742 Evergreen Terrace,Springfield,70,142</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">Paul,19 N Square,Boston,70,55.2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">Peter,66 Parker Lane,New York,74,11.5123</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">eos</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="15">
          <span class="hits">3</span>
          
          <code class="ruby">  @address_data.rewind</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="16">
          <span class="hits">3</span>
          
          <code class="ruby">  @address_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">def geo_data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  @geo_data ||= StringIO.new &lt;&lt;-eos</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">state,city,lat,lon</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">CA,San Francisco,37.727239,-123.032229</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">NY,&quot;New York&quot;,40.664274,-73.938500</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">CA,&quot;Los Angeles&quot;,34.019394,-118.410825</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">IL,Chicago,41.837551,-87.681844</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">TX,Houston,29.780472,-95.386342</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">PA,Philadelphia,40.009376,-75.133346</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">CA,&quot;San Jose&quot;,37.296867,-121.819306</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">MA,Boston,42.331960,-71.020173</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">WA,Seattle,47.620499,-122.350876</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">eos</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  @geo_data.rewind</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  @geo_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c42f66a681c48505c7e50e316688260dd06da79d">
  <div class="header">
    <h3>spec/lib/data_magic/config_field_types_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>34</b> relevant lines. 
      <span class="green"><b>34</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">describe &#39;DataMagic::Config #field_types&#39; do</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="4">
          <span class="hits">8</span>
          
          <code class="ruby">  let(:config) { DataMagic::Config.new(load_datayaml: false) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;returns empty if dictionary is empty&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    allow(config).to receive(:file_config).and_return([{&#39;name&#39; =&gt; &#39;one.csv&#39;}])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    allow(config).to receive(:dictionary).and_return({})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(config.field_types).to eq({})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;when no type is given&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(config).to receive(:file_config).and_return([{&#39;name&#39; =&gt; &#39;one.csv&#39;}])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(config).to receive(:dictionary).and_return({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">          &#39;name&#39; =&gt; {source:&#39;NAME_COLUMN&#39;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;defaults to string&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(config.field_types).to eq({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">          &#39;name&#39; =&gt; &#39;string&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;supports integers&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    allow(config).to receive(:file_config).and_return([{&#39;name&#39; =&gt; &#39;one.csv&#39;}])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    allow(config).to receive(:dictionary).and_return(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      IndifferentHash.new count:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">        {source:&#39;COUNT_COLUMN&#39;, type: &#39;integer&#39;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(config.field_types).to eq({&#39;count&#39; =&gt; &#39;integer&#39;})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;with float type&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;sets float mapping&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(config).to receive(:file_config).and_return([{&#39;name&#39; =&gt; &#39;one.csv&#39;}])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(config).to receive(:dictionary).and_return(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">        IndifferentHash.new percent:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">           {source:&#39;PERCENT_COLUMN&#39;, type: &#39;float&#39;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(config.field_types).to eq({&#39;percent&#39; =&gt; &#39;float&#39;})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can be excluded&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(config).to receive(:dictionary).and_return(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">        IndifferentHash.new id: {source:&#39;ID&#39;, type: &#39;integer&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">          percent: {source:&#39;PERCENT&#39;, type: &#39;float&#39;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(config).to receive(:file_config).and_return([</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        IndifferentHash.new({ name:&#39;one.csv&#39;, only: [&#39;id&#39;] })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      ])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(config.field_types).to eq({&#39;id&#39; =&gt; &#39;integer&#39;})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can be nested&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(config).to receive(:dictionary).and_return(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">        IndifferentHash.new id: {source:&#39;ID&#39;, type: &#39;integer&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">          percent: {source:&#39;PERCENT&#39;, type: &#39;float&#39;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(config).to receive(:file_config).and_return([</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        IndifferentHash.new({name:&#39;one.csv&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">            only: [&#39;id&#39;]}),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">        IndifferentHash.new({name:&#39;two.csv&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">            nest: {key: &#39;2012&#39;, contents: [&#39;percent&#39;]}})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      ])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(config.field_types).to eq({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">          &#39;id&#39; =&gt; &#39;integer&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">          &#39;2012.percent&#39; =&gt; &#39;float&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;supports location.lat and location.lon fields&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">    allow(config).to receive(:file_config).and_return([{&#39;name&#39; =&gt; &#39;one.csv&#39;}])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">    allow(config).to receive(:dictionary).and_return(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      IndifferentHash.new &#39;location.lat&#39;: {source:&#39;LAT_COLUMN&#39;, type: &#39;float&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">                          &#39;location.lon&#39;: {source:&#39;LON_COLUMN&#39;, type: &#39;float&#39;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(config.field_types).to eq(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">        &#39;location.lat&#39;=&gt;&#39;float&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">        &#39;location.lon&#39;=&gt;&#39;float&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d51bf473ab31d58e71e962bc8c987475de65f251">
  <div class="header">
    <h3>spec/lib/data_magic/config_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>90</b> relevant lines. 
      <span class="green"><b>90</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">describe DataMagic::Config do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/import_with_dictionary&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;detects data.yml files&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/cities_with_yml&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    config = DataMagic::Config.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(config.data[&quot;api&quot;]).to eq(&quot;cities&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &#39;slugification&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    it &#39;slugifies local paths&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      config = DataMagic::Config.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      slugified = config.clean_index(&#39;path/to/my_directory&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(slugified).to eq(&#39;my-directory&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    it &#39;slugifes s3 bucket names&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">      config = DataMagic::Config.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">      slugified = config.clean_index(&#39;s3://user:pass@my_bucket&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(slugified).to eq(&#39;my-bucket&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;s3&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;detects data.yaml&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;s3://mybucket&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">      fake_s3 = class_spy(&quot;Fake Aws::S3::Client&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">      fake_get_object_response = double(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        &quot;S3 response&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">        body: StringIO.new({ &#39;index&#39; =&gt; &#39;fake-index&#39; }.to_yaml),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">        isOK: true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        status: 200</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(fake_s3).to receive(:get_object)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        .with(bucket: &#39;mybucket&#39;, key: &#39;data.yaml&#39;, response_target: duck_type(:read))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">        .and_return(fake_get_object_response)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      config = DataMagic::Config.new(s3: fake_s3)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(config.s3).to eq(fake_s3)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(config.data[&quot;index&quot;]).to eq(&quot;fake-index&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;raises error if s3 errors&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;s3://mybucket&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">      fake_s3 = class_spy(&quot;Fake Aws::S3::Client&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(fake_s3).to receive(:get_object)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        .with(bucket: &#39;mybucket&#39;, key: &#39;data.yaml&#39;, response_target: duck_type(:read))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        .and_raise(RuntimeError)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">      expect {</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">        DataMagic::Config.new(s3: fake_s3)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      }.to raise_error(RuntimeError)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;create&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;works with zero args&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(DataMagic::Config.new).to_not be_nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can set s3 client&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      # TODO: mock s3</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">      s3_client = &quot;s3 client&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">      config = DataMagic::Config.new(s3: s3_client)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(config.s3).to eq(s3_client)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;when loaded&quot; do</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="73">
          <span class="hits">9</span>
          
          <code class="ruby">    let(:config) { DataMagic::Config.new }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">    after do</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="76">
          <span class="hits">8</span>
          
          <code class="ruby">      config.clear_all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;#scoped_index_name&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">      it &quot;includes environment prefix&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(config.scoped_index_name).to eq(&#39;test-city-data&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;has config data&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      default_config = {</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">        &quot;version&quot; =&gt; &quot;cities100-2010&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        &quot;index&quot; =&gt; &quot;city-data&quot;, &quot;api&quot; =&gt; &quot;cities&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">        &quot;files&quot; =&gt; [{ &quot;name&quot; =&gt; &quot;cities100.csv&quot; }],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">        &quot;options&quot; =&gt; {:search=&gt;&quot;dictionary_only&quot;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">        &quot;unique&quot; =&gt; [&quot;name&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">        &quot;data_path&quot; =&gt; &quot;./sample-data&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(config.data.keys).to include(&#39;dictionary&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">      dictionary = config.data.delete &#39;dictionary&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(dictionary.keys.sort).to eq %w(id code name state population</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">        location.lat location.lon land_area area.water).sort</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">      categories = config.data.delete &#39;categories&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(categories.keys.sort).to eq %w(general general2 general3 general4 general5 geographic).sort</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="101">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(config.data).to eq(default_config)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;has default page size&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(DataMagic::DEFAULT_PAGE_SIZE).to_not be_nil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(config.page_size).to eq(DataMagic::DEFAULT_PAGE_SIZE)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">    describe &quot;#update_indexed_config&quot; do # rename ... or do this in load_config or something</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;after loading config&quot; do</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="111">
          <span class="hits">4</span>
          
          <code class="ruby">        let(:fixture_path) { &quot;./spec/fixtures/import_with_dictionary&quot; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">        before do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="113">
          <span class="hits">3</span>
          
          <code class="ruby">          config.load_datayaml(fixture_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">        it &quot;should be true&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">          expect(config.update_indexed_config).to be true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">        it &quot;should set new data_path&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">          expect(config.data_path).to eq(fixture_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="122">
          <span class="hits">1</span>
          
          <code class="ruby">        it &quot;twice should be false&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">          config.update_indexed_config</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">          expect(config.update_indexed_config).to be false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">    describe &quot;when has a custom null_value&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">      it &#39;should have a default null value&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="131">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(config.null_value).to eq(&#39;NULL&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">      it &#39;should set null value field&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">        config.load_datayaml(&quot;./spec/fixtures/import_with_null_value&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(config.null_value).to eq(&#39;abc123&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;.calculated_field_list&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="142">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:config) { DataMagic::Config.new(load_datayaml: false) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;finds fields with &#39;calculate&#39; property&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(config).to receive(:dictionary).and_return(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">          one: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">            source: &#39;column1&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">            type: &#39;float&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">          },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">          two: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">            source: &#39;column2&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">            type: &#39;float&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">          },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">          all: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">                calculate: &#39;column1 or column2&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">                type: &#39;float&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">                description: &#39;something&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(config.calculated_field_list).to eq([&#39;all&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;.only_field_list&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="166">
          <span class="hits">3</span>
          
          <code class="ruby">    let(:config) { DataMagic::Config.new(load_datayaml: false) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="167">
          <span class="hits">1</span>
          
          <code class="ruby">    let(:simple_fields) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">      { &#39;one&#39; =&gt; &#39;column1&#39;, &#39;two&#39; =&gt; &#39;column2&#39;, &#39;three&#39; =&gt; &#39;column3&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">    let(:fields_with_dots) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">      { &#39;one&#39; =&gt; &#39;column1&#39;, &#39;two.a&#39; =&gt; &#39;column2a&#39;, &#39;two.b&#39; =&gt; &#39;column2b&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="174">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;selects a subset&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(config.only_field_list(%w(one two), simple_fields)).to eq(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">        &#39;one&#39; =&gt; &#39;column1&#39;, &#39;two&#39; =&gt; &#39;column2&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="180">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;selects fields with dots&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(config.only_field_list(%w(two), fields_with_dots)).to eq(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">        &#39;two.a&#39; =&gt; &#39;column2a&#39;, &#39;two.b&#39; =&gt; &#39;column2b&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="96bf5c8908f7fe8f297fdc325ad2a70a97b8bba4">
  <div class="header">
    <h3>spec/lib/data_magic/create_index_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>36</b> relevant lines. 
      <span class="green"><b>36</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;data_magic&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">describe &quot;DataMagic #init&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  before (:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/import_with_dictionary&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  after(:each) do</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="10">
          <span class="hits">7</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;with no options&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;creates index only once&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(DataMagic).to receive(:create_index).once</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.init</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;creates index&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.init</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(DataMagic.config.index_exists?).to be true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;does not re-create index with subsequent call to #import_with_dictionary&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(DataMagic).to receive(:create_index).once</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.init</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.import_with_dictionary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;with load_now: false&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;does not call #create_index&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(DataMagic).not_to receive(:create_index)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.init(load_now: false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;does not create index&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.init(load_now: false)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(DataMagic.config.index_exists?).to be false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;creates index with subsequent call to #import_with_dictionary&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.init(load_now: false)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.import_with_dictionary</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(DataMagic.config.index_exists?).to be true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;creates index with subsequent call to #import_csv&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/minimal&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.init(load_now: false)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">      data_str = &lt;&lt;-eos</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      a,b</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      1,2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      3,4</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      eos</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">      data = StringIO.new(data_str)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.import_csv(data)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(DataMagic.config.index_exists?).to be true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="1cf1f36cd0aa8727df731fff8c6c8cdf4e4cd9fd">
  <div class="header">
    <h3>spec/lib/data_magic/error_checker_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>145</b> relevant lines. 
      <span class="green"><b>145</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fixtures/data.rb&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">describe &#39;API errors&#39;, type: &#39;feature&#39; do</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="5">
          <span class="hits">24</span>
          
          <code class="ruby">  let(:errors)          {  DataMagic::ErrorChecker.check(params, options, config) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  let(:expected_errors) { [] }</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="7">
          <span class="hits">24</span>
          
          <code class="ruby">  let(:config)          { DataMagic.config }</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="8">
          <span class="hits">15</span>
          
          <code class="ruby">  let(:options)         { {} }</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="9">
          <span class="hits">8</span>
          
          <code class="ruby">  let(:params)          { {} }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  before :all do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/sample-data&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  after :all do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  RSpec.configure do |c|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    c.alias_it_should_behave_like_to :it_correctly, &#39;, it correctly&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  shared_examples &quot;returns an error&quot; do</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="25">
          <span class="hits">16</span>
          
          <code class="ruby">    it &quot;with the right content&quot; do</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="26">
          <span class="hits">16</span>
          
          <code class="ruby">      expect(errors).to eq expected_errors</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  shared_examples &quot;does not return an error&quot; do</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="31">
          <span class="hits">7</span>
          
          <code class="ruby">    it &quot;&quot; do</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="32">
          <span class="hits">7</span>
          
          <code class="ruby">      expect(errors).to eq []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;are returned&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="38">
          <span class="hits">23</span>
          
          <code class="ruby">      allow(config).to receive(:dictionary_only_search?).and_return(false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;when an unknown parameter is provided&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="42">
          <span class="hits">3</span>
          
          <code class="ruby">      let(:params) { { &quot;frog&quot; =&gt; &quot;toad&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">      let(:expected_errors) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        [{</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">          error: &#39;parameter_not_found&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">          message: &quot;The input parameter &#39;frog&#39; is not known in this dataset.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">          input: &#39;frog&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">        }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;and dictionary-only-search is on&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">        before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">          allow(config).to receive(:dictionary_only_search?).and_return(true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;returns an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;and dictionary-only-search is off&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;does not return an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;when an unknown parameter is provided that contains html tags&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="62">
          <span class="hits">3</span>
          
          <code class="ruby">      let(:params) { { &quot;&lt;b&gt;frog&lt;/b&gt;&quot; =&gt; &quot;toad&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">      let(:expected_errors) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        [{</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">             error: &#39;parameter_not_found&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">             message: &quot;The input parameter &#39;frog&#39; is not known in this dataset.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">             input: &#39;frog&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">         }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;and dictionary-only-search is on&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">        before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">          allow(config).to receive(:dictionary_only_search?).and_return(true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;returns an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;and dictionary-only-search is off&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;does not return an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;when an unknown field is specified in the field list&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="82">
          <span class="hits">3</span>
          
          <code class="ruby">      let(:options) { { fields: %w(state marjorie) } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">      let(:expected_errors) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">        [{</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">          error: &#39;field_not_found&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">          input: &#39;marjorie&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">          message: &quot;The input field &#39;marjorie&#39; (in the fields parameter) is not a field in this dataset.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;and dictionary-only-search is on&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">        before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">          allow(config).to receive(:dictionary_only_search?).and_return(true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;returns an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;and dictionary-only-search is off&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;does not return an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="101">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;when an unknown field is specified in the field list that contains html tags&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="102">
          <span class="hits">3</span>
          
          <code class="ruby">      let(:options) { { fields: %w(state &lt;b&gt;marjorie&lt;/b&gt;) } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">      let(:expected_errors) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">        [{</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">             error: &#39;field_not_found&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">             input: &#39;marjorie&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">             message: &quot;The input field &#39;marjorie&#39; (in the fields parameter) is not a field in this dataset.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">         }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;and dictionary-only-search is on&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">        before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">          allow(config).to receive(:dictionary_only_search?).and_return(true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;returns an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;and dictionary-only-search is off&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;does not return an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;when an unknown operator is used&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="122">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:params) { { &quot;population__brak&quot; =&gt; &quot;1200&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">      let(:expected_errors) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">        [{</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">          error: &#39;operator_not_found&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">          message: &quot;The input operator &#39;brak&#39; (appended to the parameter &#39;population&#39;) is not known or supported. (Known operators: range, ne, not)&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">          input: &#39;brak&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">          parameter: &#39;population&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">        }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="131">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;returns an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;when a value of the wrong type is provided for a field&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;providing a string for an integer&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="136">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:params) { { &quot;population&quot; =&gt; &quot;kevin&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">        let(:expected_errors) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">          [{</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">            error: &#39;parameter_type_error&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">            message: &quot;The parameter &#39;population&#39; expects a value of type integer, but received &#39;kevin&#39; which is a value of type string.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">            input: &#39;kevin&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">            parameter: &#39;population&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">            expected_type: &#39;integer&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">            input_type: &#39;string&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">          }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;returns an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">        context &quot;providing an string html tag for an integer&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="150">
          <span class="hits">2</span>
          
          <code class="ruby">          let(:params) { { &quot;population&quot; =&gt; &quot;&lt;b&gt;kevin&lt;/b&gt;&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">          let(:expected_errors) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">            [{</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">                 error: &#39;parameter_type_error&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">                 message: &quot;The parameter &#39;population&#39; expects a value of type integer, but received &#39;kevin&#39; which is a value of type string.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">                 input: &#39;kevin&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">                 parameter: &#39;population&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">                 expected_type: &#39;integer&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">                 input_type: &#39;string&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">             }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">          it_correctly &quot;returns an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;providing a float for an integer, with negation&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="167">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:params) { { &quot;population__not&quot; =&gt; &quot;-123.00&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">        let(:expected_errors) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">          [{</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">            error: &#39;parameter_type_error&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">            message: &quot;The parameter &#39;population__not&#39; expects a value of type integer, but received &#39;-123.00&#39; which is a value of type float.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">            input: &#39;-123.00&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">            parameter: &#39;population__not&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">            expected_type: &#39;integer&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">            input_type: &#39;float&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">          }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="178">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;returns an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;providing a string html tag for an integer, with negation&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="182">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:params) { { &quot;population__not&quot; =&gt; &quot;&lt;b&gt;-123.00&lt;/b&gt;&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="183">
          <span class="hits">1</span>
          
          <code class="ruby">        let(:expected_errors) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">          [{</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="185">
          <span class="hits">1</span>
          
          <code class="ruby">               error: &#39;parameter_type_error&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">               message: &quot;The parameter &#39;population__not&#39; expects a value of type integer, but received &#39;-123.00&#39; which is a value of type string.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">               input: &#39;-123.00&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">               parameter: &#39;population__not&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">               expected_type: &#39;integer&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">               input_type: &#39;string&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">           }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;returns an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="197">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;when a value of the correct type is provided for a field&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="198">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;providing a comma-separated list of integers for an integer field&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="199">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:params) { { &quot;population&quot; =&gt; &quot;10,20,30&quot;} }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="200">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;does not return an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="204">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;when a range is specified&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="205">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;in the wrong format&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="206">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:params) { { &quot;population__range&quot; =&gt; &quot;kevin..3&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="207">
          <span class="hits">1</span>
          
          <code class="ruby">        let(:expected_errors) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">          [{</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="209">
          <span class="hits">1</span>
          
          <code class="ruby">            error: &#39;range_format_error&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">            message: &quot;The range &#39;kevin..3&#39; supplied to parameter &#39;population&#39; isn&#39;t in the correct format.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">            input: &#39;kevin..3&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">            parameter: &#39;population&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">          }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="215">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;returns an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;in the wrong format with html tags&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="219">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:params) { { &quot;population__range&quot; =&gt; &quot;&lt;b&gt;kevin&lt;/b&gt;..3&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="220">
          <span class="hits">1</span>
          
          <code class="ruby">        let(:expected_errors) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">          [{</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="222">
          <span class="hits">1</span>
          
          <code class="ruby">               error: &#39;range_format_error&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">               message: &quot;The range &#39;kevin..3&#39; supplied to parameter &#39;population&#39; isn&#39;t in the correct format.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">               input: &#39;kevin..3&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">               parameter: &#39;population&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">           }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;returns an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="231">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;in the right format&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="232">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:params) { { &quot;population__range&quot; =&gt; &quot;2..3&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;does not return an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="237">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;when multiple errors occur&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="238">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:params)  { { &quot;population__range&quot; =&gt; &quot;kevin..3&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="239">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:options) { { fields: %w(state frog marjorie) } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="240">
          <span class="hits">1</span>
          
          <code class="ruby">      let(:expected_errors) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">        [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">          {</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="243">
          <span class="hits">1</span>
          
          <code class="ruby">            error: &#39;field_not_found&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">            message: &quot;The input field &#39;frog&#39; (in the fields parameter) is not a field in this dataset.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">            input: &#39;frog&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">          }, {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">            error: &#39;field_not_found&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">            message: &quot;The input field &#39;marjorie&#39; (in the fields parameter) is not a field in this dataset.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">            input: &#39;marjorie&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">          }, {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">            error: &#39;range_format_error&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">            message: &quot;The range &#39;kevin..3&#39; supplied to parameter &#39;population&#39; isn&#39;t in the correct format.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">            input: &#39;kevin..3&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">            parameter: &#39;population&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">        ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="258">
          <span class="hits">1</span>
          
          <code class="ruby">      before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="259">
          <span class="hits">1</span>
          
          <code class="ruby">        allow(config).to receive(:dictionary_only_search?).and_return(true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">      # NOTE: This currently also asserts the ordering of errors in the JSON</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">      # response, which it shouldn&#39;t, because that doesn&#39;t matter.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="263">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;returns an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="266">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;when multiple errors occur with html tags&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="267">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:params)  { { &quot;population__range&quot; =&gt; &quot;&lt;b&gt;kevin&lt;/b&gt;..3&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="268">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:options) { { fields: %w(state &lt;b&gt;frog&lt;/b&gt; &lt;b&gt;marjorie&lt;/b&gt;) } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="269">
          <span class="hits">1</span>
          
          <code class="ruby">      let(:expected_errors) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">        [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">            {</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="272">
          <span class="hits">1</span>
          
          <code class="ruby">                error: &#39;field_not_found&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">                message: &quot;The input field &#39;frog&#39; (in the fields parameter) is not a field in this dataset.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">                input: &#39;frog&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">            }, {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">                error: &#39;field_not_found&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">                message: &quot;The input field &#39;marjorie&#39; (in the fields parameter) is not a field in this dataset.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">                input: &#39;marjorie&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">            }, {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">                error: &#39;range_format_error&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">                message: &quot;The range &#39;kevin..3&#39; supplied to parameter &#39;population&#39; isn&#39;t in the correct format.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">                input: &#39;kevin..3&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">                parameter: &#39;population&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">        ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="287">
          <span class="hits">1</span>
          
          <code class="ruby">      before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="288">
          <span class="hits">1</span>
          
          <code class="ruby">        allow(config).to receive(:dictionary_only_search?).and_return(true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">      # NOTE: This currently also asserts the ordering of errors in the JSON</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">      # response, which it shouldn&#39;t, because that doesn&#39;t matter.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="292">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;returns an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="295">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;when a distance is supplied&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="296">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;and no zip&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="297">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:options) { { distance: &quot;4&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="298">
          <span class="hits">1</span>
          
          <code class="ruby">        let(:expected_errors) {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">          [{</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="300">
          <span class="hits">1</span>
          
          <code class="ruby">            error: &#39;distance_error&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">            message: &quot;Use of the &#39;distance&#39; parameter also requires a &#39;zip&#39; parameter.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">          }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="304">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;returns an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="309">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;when a zipcode is supplied&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="311">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;when an invalid zipcode is provided&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="312">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:options) { { zip: &#39;00002&#39;, distance: &quot;4&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="313">
          <span class="hits">1</span>
          
          <code class="ruby">        let(:expected_errors) {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">          [{</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="315">
          <span class="hits">1</span>
          
          <code class="ruby">            error: &#39;zipcode_error&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">            message: &quot;The provided zipcode, &#39;00002&#39;, is not valid.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">            input: &#39;00002&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">            parameter: &#39;zip&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">          }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="321">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;returns an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="324">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;when an invalid zipcode wrapped in html tag is provided&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="325">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:options) { { zip: &#39;&lt;b&gt;00002&lt;/b&gt;&#39;, distance: &quot;4&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="326">
          <span class="hits">1</span>
          
          <code class="ruby">        let(:expected_errors) {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">          [{</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="328">
          <span class="hits">1</span>
          
          <code class="ruby">               error: &#39;zipcode_error&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">               message: &quot;The provided zipcode, &#39;00002&#39;, is not valid.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">               input: &#39;00002&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby">               parameter: &#39;zip&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">           }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="334">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;returns an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="337">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;when a valid zipcode is provided&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="338">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:params) { { &quot;zip&quot; =&gt; &#39;94607&#39; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="339">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;does not return an error&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ca8f658de1ed4cbb60e7dccd841652694e37bacd">
  <div class="header">
    <h3>spec/lib/data_magic/example_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>15</b> relevant lines. 
      <span class="green"><b>15</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">describe Example do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  let(:hash) do</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="5">
          <span class="hits">5</span>
          
          <code class="ruby">    { name: &#39;foo&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">      description: &#39;interesting thing&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">      params: &#39;a=1&amp;b=something&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">      endpoint: &#39;api&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="10">
          <span class="hits">6</span>
          
          <code class="ruby">  subject(:e) { Example.new(hash) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;has a name&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(e.name).to eq(hash[:name])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;has a description&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(e.description).to eq(hash[:description])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;has a params&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(e.params).to eq(hash[:params])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;has an endpoint&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(e.endpoint).to eq(hash[:endpoint])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;has a link&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(e.link).to eq(&quot;/v1/#{e.endpoint}?#{e.params}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d232bb8f62a2e00e09f9324db3d895d9c92c3072">
  <div class="header">
    <h3>spec/lib/data_magic/import_csv_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>17</b> relevant lines. 
      <span class="green"><b>17</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;data_magic&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">describe &quot;DataMagic #import_csv&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  before do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="6">
          <span class="hits">2</span>
          
          <code class="ruby">    ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/minimal&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="7">
          <span class="hits">2</span>
          
          <code class="ruby">    DataMagic.init(load_now: false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  after do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="10">
          <span class="hits">2</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    #expect(DataMagic.client.indices.get(index: &#39;_all&#39;)).to be_empty</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;throws errors for bad format&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    data = StringIO.new(&quot;not csv format&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="16">
          <span class="hits">2</span>
          
          <code class="ruby">    expect{DataMagic.import_csv(data)}.to raise_error(DataMagic::InvalidData)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;reads file and reports number of rows and headers&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    data_str = &lt;&lt;-eos</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">a,b</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">1,2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">3,4</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">eos</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    data = StringIO.new(data_str)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    num_rows, fields = DataMagic.import_csv(data)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(num_rows).to be(2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(fields).to eq([&#39;a&#39;, &#39;b&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e7415348c27d36dbc608a7841bdd3f2356b64dd9">
  <div class="header">
    <h3>spec/lib/data_magic/import_with_delta_file_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>48</b> relevant lines. 
      <span class="green"><b>48</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;data_magic&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">describe &quot;delta update&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  before :example do</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="7">
          <span class="hits">9</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="8">
          <span class="hits">9</span>
          
          <code class="ruby">    ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/nested_delta_files&#39;</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="9">
          <span class="hits">9</span>
          
          <code class="ruby">    DataMagic.config = DataMagic::Config.new</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="10">
          <span class="hits">9</span>
          
          <code class="ruby">    DataMagic.import_with_dictionary</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="11">
          <span class="hits">9</span>
          
          <code class="ruby">    DataMagic.import_with_delta({delta_original: &#39;latest-school-data.csv&#39;, delta_update: &#39;latest-school-data_update1.csv&#39;})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  after :example do</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="14">
          <span class="hits">9</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="16">
          <span class="hits">8</span>
          
          <code class="ruby">  let(:query)   { {} }</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="17">
          <span class="hits">9</span>
          
          <code class="ruby">  let(:sort)    { nil }</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="18">
          <span class="hits">10</span>
          
          <code class="ruby">  let(:result)  { DataMagic.search(query, sort: sort) }</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="19">
          <span class="hits">4</span>
          
          <code class="ruby">  let(:first)   { result[&#39;results&#39;].first }</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="20">
          <span class="hits">25</span>
          
          <code class="ruby">  let(:id_one)   { result[&#39;results&#39;].find { |item| item[&#39;id&#39;] == &#39;1&#39; } }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="21">
          <span class="hits">5</span>
          
          <code class="ruby">  let(:total)   { result[&#39;metadata&#39;][&#39;total&#39;] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;updates one document per unique id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(total).to eq(11)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;updates root document :delta_only fields&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(id_one[&#39;id&#39;]).to eq(&#39;1&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(id_one[&#39;under_investigation&#39;]).to eq(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;does not update root document fields not specified in :delta_only&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(id_one[&#39;name&#39;]).to eq(&#39;Reichert University&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;updates nested documents per unique id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(id_one[&#39;latest&#39;]).to_not be_nil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(id_one[&#39;latest&#39;][&#39;earnings&#39;][&#39;6_yrs_after_entry&#39;][&#39;median&#39;]).to eq(30000)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;does not update nested documents in non-delta files&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(id_one[&#39;id&#39;]).to eq(&#39;1&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(id_one[&#39;2013&#39;]).to_not be_nil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(id_one[&#39;2013&#39;][&#39;earnings&#39;][&#39;6_yrs_after_entry&#39;][&#39;median&#39;]).to eq(26318)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;can import a subset of fields&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;and when searching for a field value&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="49">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:query) { {zipcode: &quot;35762&quot;} }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      it &quot;and doesn&#39;t find column&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(total).to eq(0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;and doesn&#39;t include extra field&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(first[&#39;zipcode&#39;]).to be(nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;when searching on a nested field&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="60">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:query) { { &#39;latest.earnings.6_yrs_after_entry.median&#39; =&gt; 30000 } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can find the correct results&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(total).to eq(1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(first[&#39;latest&#39;][&#39;earnings&#39;][&#39;6_yrs_after_entry&#39;]).to eq({&quot;percent_gt_25k&quot;=&gt;0.53, &quot;median&quot;=&gt;30000})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;when sorting by a nested field&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="68">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:sort) { &#39;latest.earnings.6_yrs_after_entry.median&#39; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can find the right first result&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(total).to eq(11)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(first[&#39;latest&#39;][&#39;earnings&#39;][&#39;6_yrs_after_entry&#39;]).to eq({&quot;percent_gt_25k&quot;=&gt;0.1, &quot;median&quot;=&gt;1900})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="3f77fe3eff45c463a743c173a867dbaad6c3b5c3">
  <div class="header">
    <h3>spec/lib/data_magic/import_with_dictionary_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>123</b> relevant lines. 
      <span class="green"><b>123</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">describe &quot;unique key(s)&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before :example do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="5">
          <span class="hits">3</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="6">
          <span class="hits">3</span>
          
          <code class="ruby">    ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/import_with_dictionary&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  after :example do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="9">
          <span class="hits">3</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;duplicates records with no unique keys&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    DataMagic.config = DataMagic::Config.new</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="14">
          <span class="hits">3</span>
          
          <code class="ruby">    2.times { DataMagic.import_with_dictionary }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    result = DataMagic.search({})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(result[&#39;metadata&#39;][&#39;total&#39;]).to eq(200)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;loads records once by state&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    DataMagic.config = DataMagic::Config.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    DataMagic.config.data[&#39;unique&#39;] = [&#39;state&#39;]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="22">
          <span class="hits">3</span>
          
          <code class="ruby">    2.times { DataMagic.import_with_dictionary }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    result = DataMagic.search({})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(result[&#39;metadata&#39;][&#39;total&#39;]).to eq(35)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;loads records once by city&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    DataMagic.config = DataMagic::Config.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    DataMagic.config.data[&#39;unique&#39;] = [&#39;name&#39;]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="30">
          <span class="hits">3</span>
          
          <code class="ruby">    2.times { DataMagic.import_with_dictionary }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    result = DataMagic.search({})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(result[&#39;metadata&#39;][&#39;total&#39;]).to eq(100)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">describe &quot;DataMagic #import_with_dictionary&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  let(:expected) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="39">
          <span class="hits">6</span>
          
          <code class="ruby">      &quot;metadata&quot; =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">        &quot;total&quot; =&gt; 1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        &quot;page&quot; =&gt; 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">        &quot;per_page&quot; =&gt; DataMagic::DEFAULT_PAGE_SIZE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      &quot;results&quot; =&gt; 	[]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;with common options&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    before(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/import_with_dictionary&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    after(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can get list of imported csv files&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">      file_list = [&quot;./spec/fixtures/import_with_dictionary/cities50.csv&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">                   &quot;./spec/fixtures/import_with_dictionary/cities51-100.csv&quot;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(DataMagic.config.files).to eq(file_list)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can get index name from api endpoint&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(DataMagic.config.find_index_for(&#39;cities&#39;)).to eq(&#39;city-data&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;indexes files with yaml mapping&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">      result = DataMagic.search({ name: &quot;Chicago&quot; }, api: &#39;cities&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">      expected[&quot;results&quot;] = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">        { &quot;state&quot; =&gt; &quot;IL&quot;, &quot;name&quot; =&gt; &quot;Chicago&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">          &quot;population&quot; =&gt; &quot;2695598&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">          &quot;latitude&quot; =&gt; &quot;41.837551&quot;, &quot;longitude&quot; =&gt; &quot;-87.681844&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">          &quot;category&quot; =&gt; &quot;top50&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;indexes rows from all the files&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">      result = DataMagic.search({}, api: &#39;cities&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result[&#39;metadata&#39;][&#39;total&#39;]).to eq(100)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;adds column with additional field data&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">      result = DataMagic.search({ category: &quot;top50&quot; }, api: &#39;cities&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result[&#39;metadata&#39;][&#39;total&#39;]).to eq(50)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;with errors&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      # This disables threading, and has the thread proc exec in main thread</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(Thread).to receive(:new).and_yield</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/import_with_errors&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">    after do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;raises an error with invalid type&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">      expect do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">        DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">      end.to raise_error(DataMagic::InvalidDictionary)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;with options&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">    before(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/import_with_options&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">    after(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;&#39;columns: all&#39; indexed all columns and apply dictionary mapping to some&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">      result = DataMagic.search({ GEOID: &quot;3651000&quot; }, api: &#39;cities&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">      expected[&quot;results&quot;] = [{ &quot;state&quot; =&gt; &quot;NY&quot;, &quot;GEOID&quot; =&gt; &quot;3651000&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">                               &quot;ANSICODE&quot; =&gt; &quot;2395220&quot;, &quot;name&quot; =&gt; &quot;New York&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">                               &quot;population&quot; =&gt; &quot;8175133&quot;, &quot;year&quot; =&gt; 2010 }]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;&#39;limit_files: 1&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">      it &quot;#config.files is of length 1&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(DataMagic.config.files.length).to eq(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="131">
          <span class="hits">1</span>
          
          <code class="ruby">      it &quot;indexes just one file&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="132">
          <span class="hits">1</span>
          
          <code class="ruby">        result = DataMagic.search({}, api: &#39;cities&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result[&#39;metadata&#39;][&#39;total&#39;]).to eq(3)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;&#39;rows: 2&#39; indexes just 3 rows&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">      result = DataMagic.search({}, api: &#39;cities&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result[&#39;metadata&#39;][&#39;total&#39;]).to eq(3)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;with option import: all&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">    before(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/import_with_options&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">    after(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can index all columns and apply dictionary mapping to some&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">      result = DataMagic.search({ GEOID: &quot;3651000&quot; }, api: &#39;cities&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">      expected[&quot;results&quot;] = [{ &quot;state&quot; =&gt; &quot;NY&quot;, &quot;GEOID&quot; =&gt; &quot;3651000&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">                               &quot;ANSICODE&quot; =&gt; &quot;2395220&quot;, &quot;name&quot; =&gt; &quot;New York&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">                               &quot;population&quot; =&gt; &quot;8175133&quot;, &quot;year&quot; =&gt; 2010 }]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;with option import: all&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="163">
          <span class="hits">1</span>
          
          <code class="ruby">    before(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/import_with_options&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">    after(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="169">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can index all columns and apply dictionary mapping to some&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="172">
          <span class="hits">1</span>
          
          <code class="ruby">      result = DataMagic.search({ GEOID: &quot;3651000&quot; }, api: &#39;cities&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">      expected[&quot;results&quot;] = [{ &quot;state&quot; =&gt; &quot;NY&quot;, &quot;GEOID&quot; =&gt; &quot;3651000&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">                               &quot;ANSICODE&quot; =&gt; &quot;2395220&quot;, &quot;name&quot; =&gt; &quot;New York&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">                               &quot;population&quot; =&gt; &quot;8175133&quot;, &quot;year&quot; =&gt; 2010 }]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="176">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="180">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;with BOM (byte order mark)&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">    before(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="182">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="183">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/bom&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="184">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="186">
          <span class="hits">1</span>
          
          <code class="ruby">    after(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="189">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can index all columns and apply dictionary mapping to some&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">      result = DataMagic.search({ id: &quot;100654&quot; }, api: &#39;test&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">      expected[&quot;results&quot;] = [{ &quot;id&quot; =&gt; &quot;100654&quot;, &quot;value&quot; =&gt; &quot;00100200&quot; }]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;with null value&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="197">
          <span class="hits">1</span>
          
          <code class="ruby">    before(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="198">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/import_with_null_value&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="200">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="202">
          <span class="hits">1</span>
          
          <code class="ruby">    after(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="203">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="206">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;should change null values to nil&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="207">
          <span class="hits">1</span>
          
          <code class="ruby">      result = DataMagic.search({ ANSICODE: &quot;2395220&quot; }, api: &#39;cities&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="208">
          <span class="hits">1</span>
          
          <code class="ruby">      expected[&quot;results&quot;] = [{ &quot;state&quot; =&gt; &quot;NY&quot;, &quot;GEOID&quot; =&gt; nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">                               &quot;ANSICODE&quot; =&gt; &quot;2395220&quot;, &quot;name&quot; =&gt; &quot;New York&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">                               &quot;population&quot; =&gt; &quot;8175133&quot; }]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="211">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5fff33c30704d50a8417dea210eba5f9b58f4c9c">
  <div class="header">
    <h3>spec/lib/data_magic/import_with_nested_files_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>43</b> relevant lines. 
      <span class="green"><b>43</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;data_magic&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">describe &quot;unique key(s)&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  before :example do</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="7">
          <span class="hits">7</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="8">
          <span class="hits">7</span>
          
          <code class="ruby">    ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/nested_files&#39;</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="9">
          <span class="hits">7</span>
          
          <code class="ruby">    DataMagic.config = DataMagic::Config.new</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="10">
          <span class="hits">7</span>
          
          <code class="ruby">    DataMagic.import_with_dictionary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  after :example do</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="13">
          <span class="hits">7</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="15">
          <span class="hits">6</span>
          
          <code class="ruby">  let(:query)   { {} }</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="16">
          <span class="hits">7</span>
          
          <code class="ruby">  let(:sort)    { nil }</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="17">
          <span class="hits">8</span>
          
          <code class="ruby">  let(:result)  { DataMagic.search(query, sort: sort) }</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="18">
          <span class="hits">4</span>
          
          <code class="ruby">  let(:first)   { result[&#39;results&#39;].first }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="19">
          <span class="hits">5</span>
          
          <code class="ruby">  let(:id_one)   { result[&#39;results&#39;].find { |item| item[&#39;id&#39;] == &#39;1&#39; } }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="20">
          <span class="hits">5</span>
          
          <code class="ruby">  let(:total)   { result[&#39;metadata&#39;][&#39;total&#39;] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;creates one document per unique id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(total).to eq(11)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;nests documents per unique id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(id_one[&#39;id&#39;]).to eq(&#39;1&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(id_one[&#39;2013&#39;]).to_not be_nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;root document contains special &#39;only&#39; fields&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(id_one[&#39;id&#39;]).to eq(&#39;1&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(id_one[&#39;name&#39;]).to eq(&#39;Reichert University&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(id_one[&#39;city&#39;]).to eq(&#39;Normal&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(id_one[&#39;state&#39;]).to eq(&#39;AL&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;can import a subset of fields&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;and when searching for a field value&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="40">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:query) { {zipcode: &quot;35762&quot;} }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      it &quot;and doesn&#39;t find column&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(total).to eq(0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;and doesn&#39;t include extra field&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(first[&#39;zipcode&#39;]).to be(nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;when searching on a nested field&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="51">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:query) { { &#39;2013.earnings.6_yrs_after_entry.median&#39; =&gt; 26318 } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can find the correct results&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(total).to eq(1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(first[&#39;2013&#39;][&#39;earnings&#39;][&#39;6_yrs_after_entry&#39;]).to eq({&quot;percent_gt_25k&quot;=&gt;0.53, &quot;median&quot;=&gt;26318})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;when sorting by a nested field&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="59">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:sort) { &#39;2013.earnings.6_yrs_after_entry.median&#39; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can find the right first result&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(total).to eq(11)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(first[&#39;2013&#39;][&#39;earnings&#39;][&#39;6_yrs_after_entry&#39;]).to eq({&quot;percent_gt_25k&quot;=&gt;0.09, &quot;median&quot;=&gt;1836})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="57de3292e638f0c2081836c231c27c2480573f90">
  <div class="header">
    <h3>spec/lib/data_magic/import_without_data_yaml_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>34</b> relevant lines. 
      <span class="green"><b>34</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;data_magic&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">describe &quot;DataMagic #import_without_data_yaml&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;without ALLOW_MISSING_YML&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;not found locally raises error&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/cities_without_yml&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      expect {</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">        DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      }.to raise_error(IOError, &quot;No data.y?ml found at ./spec/fixtures/cities_without_yml. Did you mean to define ALLOW_MISSING_YML environment variable?&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;not found on s3 raises error&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;s3://mybucket&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">      fake_s3 = Aws::S3::Client.new(stub_responses: true)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      fake_s3.stub_responses(:get_object, Aws::S3::Errors::NoSuchKey.new(Seahorse::Client::RequestContext, &#39;Fake Error&#39;))</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      expect {</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">        config = DataMagic::Config.new(s3: fake_s3)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      }.to raise_error(IOError, &quot;No data.y?ml found at s3://mybucket. Did you mean to define ALLOW_MISSING_YML environment variable?&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;with ALLOW_MISSING_YML&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    let (:expected) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">        &quot;metadata&quot; =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">          &quot;total&quot; =&gt; 1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">          &quot;page&quot; =&gt; 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">          &quot;per_page&quot; =&gt; DataMagic::DEFAULT_PAGE_SIZE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">        &quot;results&quot; =&gt; 	[]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    before(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;ALLOW_MISSING_YML&#39;] = &#39;allow&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/cities_without_yml&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    after(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;ALLOW_MISSING_YML&#39;] = &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can get list of imported csv files&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      file_list = [</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">        &quot;./spec/fixtures/cities_without_yml/cities50.csv&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">        &quot;./spec/fixtures/cities_without_yml/cities51-100.csv&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">        &quot;./spec/fixtures/cities_without_yml/more.csv&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(DataMagic.config.files.sort).to eq(file_list)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can get index name from api endpoint&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(DataMagic.config.find_index_for(&#39;cities-without-yml&#39;)).to eq(&#39;cities-without-yml&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;indexes files with yaml mapping&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">      result = DataMagic.search({NAME: &quot;Chicago&quot;}, api: &#39;cities-without-yml&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">      expected[&quot;results&quot;] = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">          &quot;USPS&quot;=&gt;&quot;IL&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">          &quot;GEOID&quot;=&gt;&quot;1714000&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">          &quot;ANSICODE&quot;=&gt;&quot;00428803&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">          &quot;NAME&quot;=&gt;&quot;Chicago&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">          &quot;LSAD&quot;=&gt;&quot;25&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">          &quot;FUNCSTAT&quot;=&gt;&quot;A&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">          &quot;POP10&quot;=&gt;&quot;2695598&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">          &quot;HU10&quot;=&gt;&quot;1194337&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">          &quot;ALAND&quot;=&gt;&quot;589571105&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">          &quot;AWATER&quot;=&gt;&quot;16781658&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">          &quot;ALAND_SQMI&quot;=&gt;&quot;227.635&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">          &quot;AWATER_SQMI&quot;=&gt;&quot;6.479&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">          &quot;INTPTLAT&quot;=&gt;&quot;41.837551&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">          &quot;INTPTLONG&quot;=&gt;&quot;-87.681844&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="eb4c367899f225d615de147bac4192ae09c830b6">
  <div class="header">
    <h3>spec/lib/data_magic/index/document_builder_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>177</b> relevant lines. 
      <span class="green"><b>177</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;data_magic&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;hashie&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">describe DataMagic::Index::DocumentBuilder do</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="6">
          <span class="hits">26</span>
          
          <code class="ruby">  let(:config)     { DataMagic::Config.new(load_datayaml: false) }</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="7">
          <span class="hits">20</span>
          
          <code class="ruby">  let(:fields)     { {} }</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="8">
          <span class="hits">21</span>
          
          <code class="ruby">  let(:options)    { {} }</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="9">
          <span class="hits">25</span>
          
          <code class="ruby">  let(:additional) { {} }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  let(:builder_data) {</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="11">
          <span class="hits">24</span>
          
          <code class="ruby">    double(&#39;builder data&#39;, {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      new_field_names: fields,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      options: options,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      additional_data: additional</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="17">
          <span class="hits">25</span>
          
          <code class="ruby">  let(:document)   { DataMagic::Index::DocumentBuilder.build(subject, builder_data, config) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  RSpec.configure do |c|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    c.alias_it_should_behave_like_to :it_correctly, &#39;correctly:&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  shared_examples &quot;creates a document&quot; do</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="24">
          <span class="hits">24</span>
          
          <code class="ruby">    it &quot;with fields&quot; do</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="25">
          <span class="hits">24</span>
          
          <code class="ruby">      expect(document).to eql expected_document</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;with no field mapping&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    describe &quot;strings&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="31">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ city: &#39;New York&#39;, state: &#39;NY&#39; }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="32">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document) {{ &#39;city&#39; =&gt; &#39;New York&#39;, &#39;state&#39; =&gt; &#39;NY&#39; }}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;with custom null_value&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    describe &quot;a single null_value mapping&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">      before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">        allow(config).to receive(:null_value).and_return([&quot;NULL&quot;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="44">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ name: &#39;Smithville&#39;, sometimesNULL: &#39;NULL&#39;  }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="45">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document) {{ &#39;name&#39; =&gt; &#39;Smithville&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">                                 &#39;sometimesNULL&#39; =&gt; nil }}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    describe &quot;multiple null_value mappings&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">      before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">        allow(config).to receive(:null_value).and_return([&quot;NULL&quot;,&quot;CustomNull&quot;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="55">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ name: &#39;Smithville&#39;, maybeNull: &#39;CustomNull&#39;, sometimesNULL: &#39;NULL&#39;  }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="56">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document) {{ &#39;name&#39; =&gt; &#39;Smithville&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">                                 &#39;maybeNull&#39; =&gt; nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">                                 &#39;sometimesNULL&#39; =&gt; nil }}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;with type mapping&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    describe &quot;integer&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">      before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">        allow(config).to receive(:csv_column_type).with(:size).and_return(&#39;integer&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="69">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ size: &#39;45&#39; }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="70">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document) {{ &#39;size&#39; =&gt; 45}}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    describe &quot;with name type&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">      before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">        config.dictionary = { city: { source: &#39;CITY&#39;, type: &#39;name&#39; } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="78">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ city: &#39;New York&#39; }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="79">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document) {{ &#39;city&#39; =&gt; &#39;New York&#39;, &#39;_city&#39; =&gt; &#39;new york&#39;}}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">    describe &quot;multiple types&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">      before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">        allow(config).to receive(:csv_column_type).with(:population).and_return(&#39;integer&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">        allow(config).to receive(:csv_column_type).with(:elevation).and_return(&#39;float&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">        allow(config).to receive(:csv_column_type).with(:name).and_return(&#39;string&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="89">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ name: &#39;Smithville&#39;, population: &#39;45&#39;, elevation: &#39;20.5&#39;  }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="90">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document) {{ &#39;name&#39; =&gt; &#39;Smithville&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">                                  &#39;population&#39; =&gt; 45,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">                                  &#39;elevation&#39; =&gt; 20.5 }}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">    describe &quot;float expressions&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">      before do</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="98">
          <span class="hits">6</span>
          
          <code class="ruby">        allow(config).to receive(:csv_column_type).with(:one).and_return(&#39;float&#39;)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="99">
          <span class="hits">6</span>
          
          <code class="ruby">        allow(config).to receive(:csv_column_type).with(:two).and_return(&#39;float&#39;)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="100">
          <span class="hits">6</span>
          
          <code class="ruby">        allow(config).to receive(:csv_column_type).with(:one_or_two).and_return(&#39;float&#39;)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="101">
          <span class="hits">6</span>
          
          <code class="ruby">        allow(config).to receive(:dictionary).and_return(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">          one_or_two: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">            calculate: &#39;one or two&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">            type: &#39;float&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">            description: &#39;something&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">          })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;with second value NULL&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="109">
          <span class="hits">3</span>
          
          <code class="ruby">        subject {{ one: &#39;0.12&#39;, two: &#39;NULL&#39; }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="110">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:expected_document)  { { &#39;one&#39; =&gt; 0.12, &#39;two&#39; =&gt; nil, &#39;one_or_two&#39; =&gt; 0.12  } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">        it &quot;reports calculated fields&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">          expect(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">            DataMagic::Index::DocumentBuilder.send(:calculated_fields,subject, config)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">          ).to eq(&#39;one_or_two&#39; =&gt; 0.12)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;with first value NULL&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="120">
          <span class="hits">2</span>
          
          <code class="ruby">        subject {{ one: &#39;NULL&#39;, two: &#39;0.45&#39; }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="121">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:expected_document)  { { &#39;one&#39; =&gt; nil, &#39;two&#39; =&gt; 0.45, &#39;one_or_two&#39; =&gt; 0.45 } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="122">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;and zero evaluates to false&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="126">
          <span class="hits">2</span>
          
          <code class="ruby">        subject {{ one: &#39;0.0&#39;, two: &#39;0.45&#39; }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="127">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:expected_document)  { { &#39;one&#39; =&gt; 0.0, &#39;two&#39; =&gt; 0.45, &#39;one_or_two&#39; =&gt; 0.45 } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="131">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;and zero evaluates to false and stays zero&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="132">
          <span class="hits">2</span>
          
          <code class="ruby">        subject {{ one: &#39;0.0&#39;, two: &#39;0.0&#39; }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="133">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:expected_document)  { { &#39;one&#39; =&gt; 0.0, &#39;two&#39; =&gt; 0.0, &#39;one_or_two&#39; =&gt; 0.0 } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">      context &quot;and zero or nil equals zero&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="138">
          <span class="hits">2</span>
          
          <code class="ruby">        subject {{ one: &#39;0.0&#39;, two: nil }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="139">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:expected_document)  { { &#39;one&#39; =&gt; 0.0, &#39;two&#39; =&gt; nil, &#39;one_or_two&#39; =&gt; nil } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">        it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;boolean expressions with integer inputs&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="147">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(config).to receive(:csv_column_type).with(:one).and_return(&#39;integer&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="148">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(config).to receive(:csv_column_type).with(:two).and_return(&#39;integer&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="149">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(config).to receive(:csv_column_type).with(:one_or_two).and_return(&#39;boolean&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="150">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(config).to receive(:dictionary).and_return(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">        one_or_two: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">          calculate: &#39;one or two&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">          type: &#39;boolean&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">          description: &#39;something&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">        })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;&#39;0 or 33&#39; evaluate as true&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="159">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ one: 0, two: 33 }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="160">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document)  { { &#39;one&#39; =&gt; 0, &#39;two&#39; =&gt; 33, &#39;one_or_two&#39; =&gt; true } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;0 evaluates as false&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="165">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ one: 0, two: 0 }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="166">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document)  { { &#39;one&#39; =&gt; 0, &#39;two&#39; =&gt; 0, &#39;one_or_two&#39; =&gt; false } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="167">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;boolean expressions with float inputs&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="172">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="173">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(config).to receive(:csv_column_type).with(:one).and_return(&#39;float&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="174">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(config).to receive(:csv_column_type).with(:two).and_return(&#39;float&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="175">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(config).to receive(:csv_column_type).with(:one_or_two).and_return(&#39;boolean&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="176">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(config).to receive(:dictionary).and_return(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">        one_or_two: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">          calculate: &#39;one or two&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">          type: &#39;boolean&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">          description: &#39;something&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">        })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="184">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;&#39;0.0 or 33.0&#39; evaluate as true&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="185">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ one: 0.0, two: 33.0 }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="186">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document)  { { &#39;one&#39; =&gt; 0.0, &#39;two&#39; =&gt; 33.0, &#39;one_or_two&#39; =&gt; true } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;0.0 evaluates as false&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="191">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ one: 0.0, two: 0.0 }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="192">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document)  { { &#39;one&#39; =&gt; 0.0, &#39;two&#39; =&gt; 0.0, &#39;one_or_two&#39; =&gt; false } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;with column name mapping&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="200">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="201">
          <span class="hits">1</span>
          
          <code class="ruby">      config.dictionary = { name: &#39;NAME&#39;, state: &#39;STABBR&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="203">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:fields) { config.field_mapping }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="204">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;with second value NULL&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="205">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ NAME: &#39;foo&#39;, STABBR:&#39;MA&#39; }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="206">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document)  { { &#39;name&#39; =&gt; &#39;foo&#39;, &#39;state&#39; =&gt; &#39;MA&#39;  } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="207">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="211">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;integer expressions&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="212">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="213">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(config).to receive(:csv_column_type).with(:one).and_return(&#39;integer&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="214">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(config).to receive(:csv_column_type).with(:two).and_return(&#39;integer&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="215">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(config).to receive(:csv_column_type).with(:one_or_two).and_return(&#39;integer&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="216">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(config).to receive(:dictionary).and_return(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">        one_or_two: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">          calculate: &#39;one or two&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">          type: &#39;integer&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">          description: &#39;a whole number&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">        })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="223">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;zero evaluates to false&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="224">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ one: &#39;0&#39;, two: &#39;4&#39; }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="225">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document)  { { &#39;one&#39; =&gt; 0, &#39;two&#39; =&gt; 4, &#39;one_or_two&#39; =&gt; 4 } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="226">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="229">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;zero evaluates to false and stays zero&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="230">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ one: &#39;0&#39;, two: &#39;0&#39; }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="231">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document)  { { &#39;one&#39; =&gt; 0, &#39;two&#39; =&gt; 0, &#39;one_or_two&#39; =&gt; 0 } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="232">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="235">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;with options[:only]&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="236">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="237">
          <span class="hits">2</span>
          
          <code class="ruby">      config.dictionary = { id: &#39;ID&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">                            state: &#39;STABBR&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">                            city: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">                              source: &#39;CITY&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">                              type: &#39;name&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">                            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">                          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="245">
          <span class="hits">3</span>
          
          <code class="ruby">    let(:fields) { config.field_mapping }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="247">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;specify two vanilla columns&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="248">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:options) {{ only: %w[id state] }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="249">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ ID: &#39;ABC&#39;, STABBR: &#39;NY&#39;, CITY: &#39;New York&#39; }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="250">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document) {{ &#39;id&#39; =&gt; &#39;ABC&#39;, &#39;state&#39; =&gt; &#39;NY&#39;}}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="251">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="254">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;specify name column&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="255">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:options) {{ only: %w[city] }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="256">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ ID: &#39;ABC&#39;, STABBR: &#39;NY&#39;, CITY: &#39;New York&#39; }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="257">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document) {{ &#39;city&#39; =&gt; &#39;New York&#39;, &#39;_city&#39; =&gt; &#39;new york&#39;}}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="258">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="262">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;with options[:nest]&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="263">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="264">
          <span class="hits">1</span>
          
          <code class="ruby">      config.dictionary = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">          id: &#39;ID&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">          state: &#39;STABBR&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">          city: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">              source: &#39;CITY&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">              type: &#39;name&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="273">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:fields) { config.field_mapping }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="275">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;specify nested columns&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="276">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:options) {{ nest: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">          &#39;key&#39; =&gt; &#39;loc&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">          &#39;contents&#39; =&gt; %w[state city _city]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">      } }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="280">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ ID: &#39;ABC&#39;, STABBR: &#39;NY&#39;, CITY: &#39;New York&#39; }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="281">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document) {{&#39;loc&#39; =&gt; { &#39;state&#39; =&gt; &#39;NY&#39;, &#39;city&#39; =&gt; &#39;New York&#39;, &#39;_city&#39; =&gt; &#39;new york&#39;}, &#39;id&#39; =&gt; &#39;ABC&#39;}}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="282">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="286">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;with both options[:only] and options[:nest]&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="287">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="288">
          <span class="hits">1</span>
          
          <code class="ruby">      config.dictionary = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">          id: &#39;ID&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">          state: &#39;STABBR&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">          zipcode: &#39;ZIPCODE&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">          under_investigation: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">              source:&#39;HCM2&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby">              type: &#39;integer&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">          },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">          city: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">              source: &#39;CITY&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">              type: &#39;name&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="302">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:fields) { config.field_mapping }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="304">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;specify only AND nested columns&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="305">
          <span class="hits">1</span>
          
          <code class="ruby">      let(:options) {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="307">
          <span class="hits">1</span>
          
          <code class="ruby">          only: %w[under_investigation],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">          nest: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">            &#39;key&#39; =&gt; &#39;loc&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">            &#39;contents&#39; =&gt; %w[state city]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="314">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ ID: &#39;ABC&#39;, STABBR: &#39;NY&#39;,CITY: &#39;New York&#39;, ZIPCODE: &#39;10001&#39;, HCM2: 1 }}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="315">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document) {{&#39;under_investigation&#39; =&gt; 1, &#39;loc&#39; =&gt; { &#39;state&#39; =&gt; &#39;NY&#39;, &#39;city&#39; =&gt; &#39;New York&#39;}, &#39;id&#39; =&gt; &#39;ABC&#39;}}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="316">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="320">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;boolean expressions&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="321">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="322">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(config).to receive(:csv_column_type).with(:accredited).and_return(&#39;boolean&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="325">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;the value is the string &#39;true&#39;&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="326">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ accredited: &#39;true&#39;}}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="327">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document) {{ &#39;accredited&#39; =&gt; true }}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="328">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="331">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;the value is the string &#39;false&#39;&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="332">
          <span class="hits">2</span>
          
          <code class="ruby">      subject {{ accredited: &#39;false&#39;}}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="333">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_document) {{ &#39;accredited&#39; =&gt; false }}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="334">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;creates a document&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="2fa7f97e46e2f79f242b8ed8d565af54f969a202">
  <div class="header">
    <h3>spec/lib/data_magic/index/document_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>37</b> relevant lines. 
      <span class="green"><b>37</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;data_magic&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">describe DataMagic::Index::Document do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  before do</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="6">
          <span class="hits">8</span>
          
          <code class="ruby">    allow(DataMagic).to receive(:config).and_return(config)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="9">
          <span class="hits">9</span>
          
          <code class="ruby">  let(:document) { DataMagic::Index::Document.new(data) }</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="10">
          <span class="hits">9</span>
          
          <code class="ruby">  let(:config) { DataMagic::Config.new() }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="11">
          <span class="hits">5</span>
          
          <code class="ruby">  let(:data) { {} }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  context &#39;when configured without any unique keys&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="15">
          <span class="hits">2</span>
          
          <code class="ruby">      config.data[&#39;unique&#39;] = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    it &#39;id should be nil&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(document.id).to be(nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    it &#39;id should not be empty though&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(document.id_empty?).to be_falsey</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  context &#39;when configured with the default keys&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    context &#39;and there is no data&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">      it &#39;id should be an empty string&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(document.id).to eq(&#39;&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">      it &#39;id should be considered empty&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(document.id_empty?).to be_truthy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    context &#39;when there is data&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">      let(:data) {</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="40">
          <span class="hits">2</span>
          
          <code class="ruby">        {&quot;name&quot; =&gt; &quot;foo&quot;, &quot;state&quot;=&gt;&quot;MA&quot;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">      it &#39;id should be the value for the name key&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(document.id).to eq(&#39;foo&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">      it &#39;id should not be considered empty&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(document.id_empty?).to be_falsey</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  context &#39;with custom id configuration&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    let(:data) {</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="55">
          <span class="hits">2</span>
          
          <code class="ruby">      {&quot;name&quot; =&gt; &quot;foo&quot;, &quot;state&quot;=&gt;&quot;MA&quot;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="59">
          <span class="hits">2</span>
          
          <code class="ruby">      config.data[&#39;unique&#39;] = [&#39;name&#39;, &#39;state&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">    it &#39;id should build the right id for the data&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(document.id).to eq(&#39;foo:MA&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">    it &#39;id should not be considered empty&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(document.id_empty?).to be_falsey</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f0fc33dfe802bb35ff687f50cc9ae181ef002297">
  <div class="header">
    <h3>spec/lib/data_magic/index/event_logger_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>25</b> relevant lines. 
      <span class="green"><b>25</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;data_magic&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">describe DataMagic::Index::EventLogger do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  let(:event_logger) {</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="6">
          <span class="hits">3</span>
          
          <code class="ruby">    l = DataMagic::Index::EventLogger.new</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="7">
          <span class="hits">3</span>
          
          <code class="ruby">    allow(l).to receive(:logger).and_return(logger)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="8">
          <span class="hits">3</span>
          
          <code class="ruby">    l</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="11">
          <span class="hits">4</span>
          
          <code class="ruby">  let(:logger) { double(&#39;logger&#39;) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  context &#39;when triggering an event with only a message argument&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    it &#39;logs the message with the right level&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(logger).to receive(:info).with(&#39;hey!&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      event_logger.trigger(&#39;info&#39;, &#39;hey!&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(logger).to receive(:debug).with(&#39;what happened?&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">      event_logger.trigger(&#39;debug&#39;, &#39;what happened?&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(logger).to receive(:warn).with(&#39;dude? everything ok?&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">      event_logger.trigger(&#39;warn&#39;, &#39;dude? everything ok?&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(logger).to receive(:error).with(&#39;FIRE IN THE HOLE!&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      event_logger.trigger(&#39;error&#39;, &#39;FIRE IN THE HOLE!&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  context &#39;when triggering an event with a message and an object&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    it &#39;logs as a key value pair with an inspection of the object&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(logger).to receive(:info).with(&quot;foo: {:wild=&gt;\&quot;bar\&quot;}&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">      event_logger.trigger(&#39;info&#39;, &#39;foo&#39;, {wild: &#39;bar&#39;})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    it &#39;will shorten the object inspection when provided a limit&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(logger).to receive(:warn).with(&quot;foo: {:wild&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">      event_logger.trigger(&#39;warn&#39;, &#39;foo&#39;, {wild: &#39;bar&#39;}, 5)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c897101e5d90cdd1bbb2e71668d002476b9adc2a">
  <div class="header">
    <h3>spec/lib/data_magic/index/importer_spec.rb</h3>
    <h4><span class="yellow">86.67 %</span> covered</h4>
    <div>
      <b>15</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;data_magic&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">describe &quot;DataMagic::Index::Importer&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/minimal&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    DataMagic.init(load_now: false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  after do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;indexes in parallel based on NPROCS&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    stub_const(&#39;ENV&#39;, { &#39;NPROCS&#39; =&gt; &#39;2&#39; })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    data_str = &lt;&lt;-eos</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">a,b</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">1,2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">3,4</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">eos</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    data = StringIO.new(data_str)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    num_rows, fields = DataMagic.import_csv(data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    expect(num_rows).to be(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    expect(fields).to eq([&#39;a&#39;, &#39;b&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="1965cfdcba8558120fbe2c8e98816481b76c05ed">
  <div class="header">
    <h3>spec/lib/data_magic/index/repository_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>44</b> relevant lines. 
      <span class="green"><b>44</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;data_magic&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">describe DataMagic::Index::Repository do</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="5">
          <span class="hits">7</span>
          
          <code class="ruby">  let(:repository) { DataMagic::Index::Repository.new(super_client, document) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="7">
          <span class="hits">7</span>
          
          <code class="ruby">  let(:super_client) { double(&#39;super client&#39;, {index_name: &#39;index&#39;, nested_partial?: false}) }</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="8">
          <span class="hits">7</span>
          
          <code class="ruby">  let(:document) { double(&#39;document&#39;, {id: &#39;id&#39;, data: &#39;data&#39;}) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  context &#39;when super client is creating&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="12">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(super_client).to receive(:creating?).and_return(true)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="13">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(super_client).to receive(:index)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    it &#39;#save creates an index&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(super_client).to receive(:index).with({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">        index: &#39;index&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        id: &#39;id&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">        type: &#39;document&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">        body: &#39;data&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">        timeout: &#39;5m&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      })</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">      repository.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    it &#39;#save will not be skipped when successful&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">      repository.save</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(repository.skipped?).to be_falsey</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  context &#39;when super client is not creating&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="35">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(super_client).to receive(:creating?).and_return(false)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="36">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(super_client).to receive(:allow_skips?)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="37">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(super_client).to receive(:update)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    it &#39;#save updates an index&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(super_client).to receive(:update).with({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">        index: &#39;index&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">        id: &#39;id&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        type: &#39;document&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">        body: {doc: &#39;data&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">        timeout: &#39;5m&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      })</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">      repository.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">    it &#39;#save will not be skipped when successful&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">      repository.save</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(repository.skipped?).to be_falsey</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  context &#39;when super client is not creating, not skipping and an error is raised&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(super_client).to receive(:creating?).and_return(false)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(super_client).to receive(:allow_skips?).and_return(false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">    it &#39;#save raises an error&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(super_client).to receive(:update).and_raise(Elasticsearch::Transport::Transport::Errors::NotFound)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">      expect {</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">        repository.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      }.to raise_error(Elasticsearch::Transport::Transport::Errors::NotFound)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  context &#39;when super client is not creating, skipping and an error is raised&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(super_client).to receive(:creating?).and_return(false)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(super_client).to receive(:allow_skips?).and_return(true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">    it &#39;#save marks the repository as skipped&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">      allow(super_client).to receive(:update).and_raise(Elasticsearch::Transport::Transport::Errors::NotFound)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">      expect {</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">        repository.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      }.not_to raise_error</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(repository.skipped?).to eq(true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="81b8a5b5a27d7dec7688b43dd4b7fbba0f64328d">
  <div class="header">
    <h3>spec/lib/data_magic/name_type_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>25</b> relevant lines. 
      <span class="green"><b>25</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;data_magic&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">describe &quot;DataMagic name types&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  before :example do</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="7">
          <span class="hits">4</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="8">
          <span class="hits">4</span>
          
          <code class="ruby">    ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/types&#39;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="9">
          <span class="hits">4</span>
          
          <code class="ruby">    DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  after :example do</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="12">
          <span class="hits">4</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;can search for one word&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    response = DataMagic.search({&#39;city.name&#39; =&gt; &#39;New&#39;}, fields:[&#39;city.name&#39;])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="17">
          <span class="hits">2</span>
          
          <code class="ruby">    results = response[&#39;results&#39;].sort {|a,b| a[&#39;city.name&#39;] &lt;=&gt; b[&#39;city.name&#39;]}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(results).to eq(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      [{&quot;city.name&quot;=&gt;&quot;New Orleans&quot;}, {&quot;city.name&quot;=&gt;&quot;New York&quot;}])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;can search for multiple words&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    response = DataMagic.search({&#39;city.name&#39; =&gt; &#39;New York&#39;}, fields:[&#39;city.name&#39;])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    results = response[&#39;results&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(results).to eq(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      [{&quot;city.name&quot;=&gt;&quot;New York&quot;}])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;can search for partial words&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    response = DataMagic.search({&#39;city.name&#39; =&gt; &#39;S Fran&#39;}, fields:[&#39;city.name&#39;])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    results = response[&#39;results&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(results).to eq(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      [{&quot;city.name&quot;=&gt;&quot;San Francisco&quot;}])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;is not case sensitive&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    response = DataMagic.search({&#39;city.name&#39; =&gt; &#39;nEW&#39;}, fields:[&#39;city.name&#39;])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="38">
          <span class="hits">2</span>
          
          <code class="ruby">    results = response[&#39;results&#39;].sort {|a,b| a[&#39;city.name&#39;] &lt;=&gt; b[&#39;city.name&#39;]}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(results).to eq(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      [{&quot;city.name&quot;=&gt;&quot;New Orleans&quot;}, {&quot;city.name&quot;=&gt;&quot;New York&quot;}])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="cbb5157f074f3dbfbe053bb664eeed92603ae518">
  <div class="header">
    <h3>spec/lib/data_magic/query_builder_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>123</b> relevant lines. 
      <span class="green"><b>123</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;data_magic&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;hashie&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">describe DataMagic::QueryBuilder do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  before :example do</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="8">
          <span class="hits">38</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="9">
          <span class="hits">38</span>
          
          <code class="ruby">    DataMagic.client</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="10">
          <span class="hits">38</span>
          
          <code class="ruby">    ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/minimal&#39;</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="11">
          <span class="hits">38</span>
          
          <code class="ruby">    DataMagic.config = DataMagic::Config.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  after :example do</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="15">
          <span class="hits">38</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  RSpec.configure do |c|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    c.alias_it_should_behave_like_to :it_correctly, &#39;correctly:&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="22">
          <span class="hits">15</span>
          
          <code class="ruby">  let(:expected_meta) { { post_es_response: {}, from: 0, size: 20, _source: {:exclude=&gt;[&quot;_*&quot;]}} }</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="23">
          <span class="hits">27</span>
          
          <code class="ruby">  let(:options) { {} }</code>
        </li>
      
        <li class="covered" data-hits="39" data-linenumber="24">
          <span class="hits">39</span>
          
          <code class="ruby">  let(:query_hash) { DataMagic::QueryBuilder.from_params(subject, options, DataMagic.config) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  shared_examples &quot;builds a query&quot; do</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="27">
          <span class="hits">19</span>
          
          <code class="ruby">    it &quot;with a query section&quot; do</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="28">
          <span class="hits">19</span>
          
          <code class="ruby">      expect(query_hash[:query]).to eql expected_query</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="30">
          <span class="hits">19</span>
          
          <code class="ruby">    it &quot;with query metadata&quot; do</code>
        </li>
      
        <li class="covered" data-hits="117" data-linenumber="31">
          <span class="hits">117</span>
          
          <code class="ruby">      expect(query_hash.reject { |k, _| k == :query }).to eql expected_meta</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;can issue a blank query&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="36">
          <span class="hits">3</span>
          
          <code class="ruby">    subject { {} }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="37">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:expected_query) { { match_all: {} } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;can exact match on a field&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="42">
          <span class="hits">3</span>
          
          <code class="ruby">    subject { { zipcode: &quot;35762&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="43">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:expected_query) { { match: { &quot;zipcode&quot; =&gt; &quot;35762&quot; } } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;can exact match on a nested field&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="48">
          <span class="hits">3</span>
          
          <code class="ruby">    subject { { &#39;school.zip&#39;: &quot;35762&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="49">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:expected_query) { { match: { &quot;school.zip&quot; =&gt; &quot;35762&quot; } } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;can case-insensitive match on a field&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="55">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(DataMagic.config).to receive(:field_type).with(:city).and_return(&quot;name&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="57">
          <span class="hits">3</span>
          
          <code class="ruby">    subject { { city: &quot;new YORK&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="58">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:expected_query) { { wildcard: { &quot;_city&quot; =&gt; { value: &quot;new* york*&quot; } } } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">    it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;can exact match from a list of integers&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="64">
          <span class="hits">2</span>
          
          <code class="ruby">      allow(DataMagic.config).to receive(:field_type).with(:age).and_return(&quot;integer&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="66">
          <span class="hits">3</span>
          
          <code class="ruby">    subject { { age: &#39;10,20,40&#39; } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="67">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:expected_query) { { terms: { age: [10,20,40] } } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">    it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;can search within a location&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="72">
          <span class="hits">3</span>
          
          <code class="ruby">    subject { {} }</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="73">
          <span class="hits">3</span>
          
          <code class="ruby">    let(:options) { { zip: &quot;94132&quot;, distance: &quot;30mi&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    let(:expected_query) do {</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">          geo_distance: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">            field: &quot;coords&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">            distance: &quot;30mi&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">            location: { lat: 37.7211, lon: -122.4754 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;can handle pagination&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="85">
          <span class="hits">3</span>
          
          <code class="ruby">    subject { {} }</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="86">
          <span class="hits">3</span>
          
          <code class="ruby">    let(:options) { { page: 3, per_page: 11 } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="87">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:expected_query) { { match_all: {} } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="88">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:expected_meta)  { { post_es_response: {}, from: 33, size: 11, _source: {:exclude=&gt;[&quot;_*&quot;]} }}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">    it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;limits maximum page size&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="93">
          <span class="hits">3</span>
          
          <code class="ruby">    subject { {} }</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="94">
          <span class="hits">3</span>
          
          <code class="ruby">    let(:options) { { page: 0, per_page: 2000 } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="95">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:expected_query) { { match_all: {} } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="96">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:expected_meta)  { { post_es_response: {}, from: 0, size: 100, _source: {:exclude=&gt;[&quot;_*&quot;]} }}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;can specify fields to return&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="101">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="102">
          <span class="hits">2</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/school_names&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="103">
          <span class="hits">2</span>
          
          <code class="ruby">      DataMagic.config = DataMagic::Config.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="105">
          <span class="hits">3</span>
          
          <code class="ruby">    subject { {} }</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="106">
          <span class="hits">3</span>
          
          <code class="ruby">    let(:options) { { fields: [&quot;id&quot; ,&quot;school.name&quot;] } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="107">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:expected_query) { { match_all: {} } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">    let(:expected_meta)  do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">      { </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">        post_es_response: {},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        from: 0, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">        size: 20, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">        _source: false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">        fields: [&quot;id&quot; ,&quot;school.name&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">    it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;can specify sort order&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="121">
          <span class="hits">3</span>
          
          <code class="ruby">    subject { {} }</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="122">
          <span class="hits">3</span>
          
          <code class="ruby">    let(:options) { { sort: &quot;population:asc&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="123">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:expected_query) { { match_all: {} } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">    let(:expected_meta)  do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">      { </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">        post_es_response: {},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">        from: 0, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">        size: 20, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">        _source: {:exclude=&gt;[&quot;_*&quot;]},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">        sort: [{ &quot;population&quot; =&gt; { order: &quot;asc&quot; } }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby">    it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;can sort by multiple fields&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="137">
          <span class="hits">3</span>
          
          <code class="ruby">    subject { {} }</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="138">
          <span class="hits">3</span>
          
          <code class="ruby">    let(:options) { { sort: &quot;state:desc, population:asc,name&quot; } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="139">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:expected_query) { { match_all: {} } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">    let(:expected_meta)  do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">      { </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">        post_es_response: {},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">        from: 0, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">        size: 20, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">        _source: {:exclude=&gt;[&quot;_*&quot;]},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">        sort: [{ &#39;state&#39; =&gt; { order: &#39;desc&#39; } },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">               { &quot;population&quot; =&gt; { order: &quot;asc&quot; } },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">               { &#39;name&#39; =&gt; { order: &#39;asc&#39; } }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">    it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;can search using the __range operator&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;that is open-ended (left-hand side)&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="156">
          <span class="hits">3</span>
          
          <code class="ruby">      subject { { age__range: &#39;10..&#39; } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="157">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_query) { { or: [{ range: { age: { gte: 10 } } }] } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;that is open-ended (right-hand side)&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="162">
          <span class="hits">3</span>
          
          <code class="ruby">      subject { { age__range: &#39;..10&#39; } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="163">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_query) { { or: [{ range: { age: { lte: 10 } } }] } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="167">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;that is closed&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="168">
          <span class="hits">3</span>
          
          <code class="ruby">      subject { { age__range: &#39;10..20&#39; } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="169">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_query) { { or: [{ range: { age: { gte:10, lte: 20 } } }] } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;that has multiple ranges&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="174">
          <span class="hits">3</span>
          
          <code class="ruby">      subject { { age__range: &#39;10..20,30..40&#39; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby">      let(:expected_query) do {</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="176">
          <span class="hits">1</span>
          
          <code class="ruby">            or: [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">              { range: { age: { gte: 10, lte: 20 } } },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">              { range: { age: { gte: 30, lte: 40 } } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">            ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">         }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="182">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="186">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &#39;converts values to the correct type&#39; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="187">
          <span class="hits">3</span>
          
          <code class="ruby">    subject { { population__range: &#39;1000..&#39; } }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="188">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:expected_query){ { or: [ { range: { population: { gte: 1000 } } } ] } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="189">
          <span class="hits">1</span>
          
          <code class="ruby">    it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &#39;negates values&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">    let(:expected_query) do {</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="194">
          <span class="hits">2</span>
          
          <code class="ruby">      bool: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">        filter: [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">          { bool:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">            { must_not: [{ terms: {&quot;state&quot;=&gt;[&quot;CA&quot;]} }]}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">        ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="203">
          <span class="hits">1</span>
          
          <code class="ruby">    context &#39;with &quot;__ne&quot;&#39; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="204">
          <span class="hits">3</span>
          
          <code class="ruby">      subject { { state__ne: &#39;CA&#39; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="205">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="207">
          <span class="hits">1</span>
          
          <code class="ruby">    context &#39;with &quot;__not&quot;&#39; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="208">
          <span class="hits">3</span>
          
          <code class="ruby">      subject { { state__not: &#39;CA&#39; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="209">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="213">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &#39;allows matching and negation of the different fields&#39; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="214">
          <span class="hits">3</span>
          
          <code class="ruby">    subject { { name: &#39;San Francisco&#39;, state__ne: &#39;CA&#39; } }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="215">
          <span class="hits">1</span>
          
          <code class="ruby">    let(:expected_query) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">        { bool:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">          { filter: [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">              { bool:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">                  {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">                    must: [{:match=&gt;{&quot;name&quot;=&gt;&quot;San Francisco&quot;}}],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">                    must_not: [{:terms=&gt;{&quot;state&quot;=&gt;[&quot;CA&quot;]}}]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">                  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">              }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">            ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">    it_correctly &quot;builds a query&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7f57aa44ce5e0a5161da83002f3bc841cc162f87">
  <div class="header">
    <h3>spec/lib/data_magic/search_name_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>76</b> relevant lines. 
      <span class="green"><b>76</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;data_magic&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">describe &quot;DataMagic intuitive search&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  before :example do</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="8">
          <span class="hits">20</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="9">
          <span class="hits">20</span>
          
          <code class="ruby">    ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/school_names&#39;</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="10">
          <span class="hits">20</span>
          
          <code class="ruby">    DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  after :example do</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="13">
          <span class="hits">20</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  RSpec.configure do |c|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    c.alias_it_should_behave_like_to :it_correctly, &#39;correctly:&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="20">
          <span class="hits">8</span>
          
          <code class="ruby">  let(:expected_meta) {{&quot;metadata&quot;=&gt;{&quot;total&quot;=&gt;1, &quot;page&quot;=&gt;0, &quot;per_page&quot;=&gt;20}}}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  let(:expected_match) { &quot;&quot; }</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="22">
          <span class="hits">19</span>
          
          <code class="ruby">  let(:response) {  DataMagic.search(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">                    {&#39;school.name&#39; =&gt; subject}, fields:[&#39;school.name&#39;]) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;full request&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="26">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:response) {  DataMagic.search({id: 1}) }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="27">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:expected_match) { [{&quot;id&quot;=&gt;&quot;1&quot;, &quot;school&quot;=&gt;{&quot;state&quot;=&gt;&quot;AL&quot;, &quot;name&quot;=&gt;&quot;Stillman College&quot;}}]}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;provides expected document&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(response[&#39;results&#39;]).to eql expected_match</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;sort&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">     shared_examples &quot;returns&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">       it &quot;sorted results &quot; do</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="36">
          <span class="hits">10</span>
          
          <code class="ruby">         expect(response[&#39;results&#39;].map { |i| i[&#39;school.name&#39;] })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">                 .to eql expected_match</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">       end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">     end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">     context &quot;with list of names&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="42">
          <span class="hits">2</span>
          
          <code class="ruby">       let(:response) {  DataMagic.search({}, fields:[&#39;school.name&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">                          sort: &#39;school.name&#39;) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">                          # fields:[&#39;name&#39;],</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">       let(:expected_match) {</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">         csv_path = File.expand_path(&quot;../../fixtures/school_names/school_names.csv&quot;, __dir__)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">         data = CSV.read(csv_path).slice(1..-1)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="48">
          <span class="hits">10</span>
          
          <code class="ruby">         data.map { |row| row[2] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">                   .sort.slice(0,20)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">       }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">       it_correctly &quot;returns&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">     end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">   context &quot;basic search&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    shared_examples &quot;finds&quot; do</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="58">
          <span class="hits">9</span>
          
          <code class="ruby">      it &quot;correct results &quot; do</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="59">
          <span class="hits">9</span>
          
          <code class="ruby">        expect(response[&#39;results&#39;]</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="60">
          <span class="hits">13</span>
          
          <code class="ruby">                .map { |i| i[&#39;school.name&#39;] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">                .sort )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">                .to eql expected_match</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="64">
          <span class="hits">9</span>
          
          <code class="ruby">      it &quot;correct metadata&quot; do</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="65">
          <span class="hits">27</span>
          
          <code class="ruby">        expect(response.reject { |k, _| k == &#39;results&#39; }).to eql expected_meta</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;for exact match&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="70">
          <span class="hits">3</span>
          
          <code class="ruby">      subject { &#39;New York University&#39; }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="71">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_match) { [&#39;New York University&#39;] }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;finds&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;for exact match (case insensitive)&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="75">
          <span class="hits">3</span>
          
          <code class="ruby">      subject { &#39;new YORK UniverSity&#39; }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="76">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_match) { [&#39;New York University&#39;] }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;finds&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;for exact match (case insensitive)&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="81">
          <span class="hits">3</span>
          
          <code class="ruby">      subject { &#39;new YORK UniverSity&#39; }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="82">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_match) { [&#39;New York University&#39;] }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;finds&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;by prefix&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="87">
          <span class="hits">3</span>
          
          <code class="ruby">      subject { &#39;Still&#39; }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="88">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_match) { [&#39;Stillman College&#39;] }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;finds&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;by prefix (case insensitive)&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="93">
          <span class="hits">3</span>
          
          <code class="ruby">      subject { &#39;still&#39; }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="94">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_match) { [&#39;Stillman College&#39;] }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;finds&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;by prefix in the middle of the name&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="99">
          <span class="hits">3</span>
          
          <code class="ruby">      subject { &#39;Phoenix&#39; }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="100">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_meta) {{&quot;metadata&quot;=&gt;{&quot;total&quot;=&gt;3, &quot;page&quot;=&gt;0, &quot;per_page&quot;=&gt;20}}}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="101">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_match) { [&#39;Phoenix College&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">                              &#39;University of Phoenix-Online Campus&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">                              &quot;University of Phoenix-Phoenix Campus&quot;] }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;finds&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;with words in the wrong order&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="108">
          <span class="hits">3</span>
          
          <code class="ruby">      subject { &#39;University New York&#39; }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="109">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_match) { [&#39;New York University&#39;] }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;finds&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;partial word after dash&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="114">
          <span class="hits">3</span>
          
          <code class="ruby">      subject { &#39;berk&#39; }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="115">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_meta) {{&quot;metadata&quot;=&gt;{&quot;total&quot;=&gt;3, &quot;page&quot;=&gt;0, &quot;per_page&quot;=&gt;20}}}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="116">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_match) { [&#39;Berk Trade and Business School&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">                              &#39;Berklee College of Music&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">                              &#39;University of California-Berkeley&#39;] }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;finds&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="122">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;words separated by dash&quot; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="123">
          <span class="hits">3</span>
          
          <code class="ruby">      subject { &#39;phoenix online&#39; }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="124">
          <span class="hits">2</span>
          
          <code class="ruby">      let(:expected_match) { [&#39;University of Phoenix-Online Campus&#39;] }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">      it_correctly &quot;finds&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">  # TO DO</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">  # &quot;pheonix&quot; (mis-spelling) should probably work</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">  # &quot;phoenix college&quot; should also probably return &quot;university of phoenix&quot; --- since college is a synonym for unversity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ec59512575be415b9557a0a2edd07c90eace8194">
  <div class="header">
    <h3>spec/lib/data_magic/search_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>181</b> relevant lines. 
      <span class="green"><b>181</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;data_magic&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fixtures/data.rb&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">describe &quot;DataMagic #search&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  let (:expected) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="8">
          <span class="hits">9</span>
          
          <code class="ruby">      &quot;metadata&quot; =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">        &quot;total&quot; =&gt; 1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">        &quot;page&quot; =&gt; 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">        &quot;per_page&quot; =&gt; DataMagic::DEFAULT_PAGE_SIZE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      &quot;results&quot; =&gt; 	[]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;with terms&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    describe &quot;as strings&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">      before (:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">        ENV[&#39;DATA_PATH&#39;] = &#39;./no-data&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">        ENV[&#39;ALLOW_MISSING_YML&#39;] = &#39;allow&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">        DataMagic.init(load_now: false)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">        num_rows, fields = DataMagic.import_csv(address_data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      after(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">        ENV[&#39;ALLOW_MISSING_YML&#39;] = &#39;&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">        DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">      it &quot;can find document with one attribute&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">        result = DataMagic.search({name: &quot;Marilyn&quot;})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">        expected[&quot;results&quot;] = [{&quot;name&quot; =&gt; &quot;Marilyn&quot;, &quot;address&quot; =&gt; &quot;1313 Mockingbird Lane&quot;, &quot;city&quot; =&gt; &quot;Springfield&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">                                &quot;age&quot; =&gt; &quot;14&quot;, &quot;height&quot; =&gt; &quot;2&quot;}]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">      it &quot;can find document with multiple search terms&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">        result = DataMagic.search({name: &quot;Paul&quot;, city:&quot;Liverpool&quot;})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">        expected[&quot;results&quot;] = [{&quot;name&quot; =&gt; &quot;Paul&quot;, &quot;address&quot; =&gt; &quot;15 Penny Lane&quot;, &quot;city&quot; =&gt; &quot;Liverpool&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">                                &quot;age&quot; =&gt; &quot;10&quot;, &quot;height&quot; =&gt; &quot;142&quot;}]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">      it &quot;can find a document with a set of values delimited by commas&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">        result = DataMagic.search({name: &quot;Paul,Marilyn&quot;})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">        expected[&#39;metadata&#39;][&quot;total&quot;] = 3</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result[&quot;results&quot;]).to include({&quot;name&quot; =&gt; &quot;Marilyn&quot;, &quot;address&quot; =&gt; &quot;1313 Mockingbird Lane&quot;, &quot;city&quot; =&gt; &quot;Springfield&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">                                              &quot;age&quot; =&gt; &quot;14&quot;, &quot;height&quot; =&gt; &quot;2&quot;})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result[&quot;results&quot;]).to include({&quot;name&quot; =&gt; &quot;Paul&quot;, &quot;address&quot; =&gt; &quot;15 Penny Lane&quot;, &quot;city&quot; =&gt; &quot;Liverpool&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">                                              &quot;age&quot; =&gt; &quot;10&quot;, &quot;height&quot; =&gt; &quot;142&quot;})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result[&quot;results&quot;]).to include({&quot;name&quot; =&gt; &quot;Paul&quot;, &quot;address&quot; =&gt; &quot;19 N Square&quot;, &quot;city&quot; =&gt; &quot;Boston&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">                                              &quot;age&quot; =&gt; &quot;70&quot;, &quot;height&quot; =&gt; &quot;55.2&quot;})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">      describe &quot;returning attributes with a dictionary&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">        before(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">          DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">          ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/import_with_dictionary&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">          DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">        after(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">          DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">        it &quot;can return a single attribute&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">          result = DataMagic.search({state: &quot;NY&quot;}, fields:[:population])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">          expected[&quot;results&quot;] = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">            {&quot;population&quot;=&gt;&quot;210565&quot;}, {&quot;population&quot;=&gt;&quot;261310&quot;}, {&quot;population&quot;=&gt;&quot;8175133&quot;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">          ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">          expected[&#39;metadata&#39;][&quot;total&quot;] = 3</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">          DataMagic.logger.info &quot;======= EXPECTED: #{expected.inspect}&quot;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="73">
          <span class="hits">4</span>
          
          <code class="ruby">          result[&quot;results&quot;] = result[&quot;results&quot;].sort_by { |k| k[&quot;population&quot;] }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">          expect(result).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">        it &quot;can return a subset of attributes&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">          result = DataMagic.search({state: &quot;NY&quot;}, fields:[:population, :state])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">          expected[&quot;results&quot;] = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">            {&quot;state&quot;=&gt;&quot;NY&quot;, &quot;population&quot;=&gt;&quot;210565&quot;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">            {&quot;state&quot;=&gt;&quot;NY&quot;, &quot;population&quot;=&gt;&quot;261310&quot;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">            {&quot;state&quot;=&gt;&quot;NY&quot;, &quot;population&quot;=&gt;&quot;8175133&quot;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">          ]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="84">
          <span class="hits">4</span>
          
          <code class="ruby">          result[&quot;results&quot;] = result[&quot;results&quot;].sort_by { |k| k[&quot;population&quot;] }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">          expected[&#39;metadata&#39;][&quot;total&quot;] = 3</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">          expect(result).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">      describe &quot;supports pagination&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">        before(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">          DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">          ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/import_with_dictionary&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">          DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">        after(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">          DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="101">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:result_1) { DataMagic.search({ state: &quot;TX&quot; }, page:1, per_page: 3) }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="102">
          <span class="hits">2</span>
          
          <code class="ruby">        let(:result_2) { DataMagic.search({}, page:1) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">        it &quot;can specify both page and page size&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">          expect(result_1[&#39;metadata&#39;][&quot;per_page&quot;]).to eq(3)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">          expect(result_1[&#39;metadata&#39;][&quot;page&quot;]).to eq(1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">          expect(result_1[&quot;results&quot;].length).to eq(3)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">        it &quot;can use a default page size&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">          expect(result_2[&#39;metadata&#39;][&quot;per_page&quot;]).to eq(DataMagic::DEFAULT_PAGE_SIZE)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">          expect(result_2[&#39;metadata&#39;][&quot;page&quot;]).to eq(1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">          expect(result_2[&quot;results&quot;].length).to eq(20)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">    describe &quot;with mapping&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">      before (:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">        ENV[&#39;DATA_PATH&#39;]=&quot;./no-data&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">        DataMagic.init(load_now: false)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="122">
          <span class="hits">1</span>
          
          <code class="ruby">        options = {}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">        options[:fields] = {name: &#39;person_name&#39;, address: &#39;street&#39;}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">        options[:override_dictionary] = {}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">        num_rows, fields = DataMagic.import_csv(address_data, options)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(fields.sort).to eq(options[:fields].values.sort)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">      after(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">        DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="132">
          <span class="hits">1</span>
          
          <code class="ruby">      it &quot;can find an attribute from an imported file&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby">        result = DataMagic.search({person_name: &quot;Marilyn&quot; })</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">        expected[&quot;results&quot;] = [{&quot;person_name&quot; =&gt; &quot;Marilyn&quot;, &quot;street&quot; =&gt; &quot;1313 Mockingbird Lane&quot;}]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;with numeric data&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">    before (:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/numeric_data&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;ALLOW_MISSING_YML&#39;] = &#39;allow&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.init(load_now: false)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">      num_rows, fields = DataMagic.import_csv(address_data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">    after(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">        DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">        ENV[&#39;ALLOW_MISSING_YML&#39;] = &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can correctly compute filtered statistics&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">      expected[&quot;metadata&quot;][&quot;total&quot;] = 2</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">      result = DataMagic.search({city: &quot;Springfield&quot;}, command: &#39;stats&#39;, fields: [&quot;age&quot;, &quot;height&quot;, &quot;address&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">                                metrics: [&#39;max&#39;, &#39;avg&#39;])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">      result[&quot;results&quot;] = result[&quot;results&quot;].sort_by { |k| k[&quot;age&quot;] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">      expected[&quot;results&quot;] = []</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">      expected[&quot;aggregations&quot;] = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">        &quot;age&quot; =&gt; { &quot;max&quot; =&gt; 70.0, &quot;avg&quot; =&gt; 42.0},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">        &quot;height&quot; =&gt; {&quot;max&quot;=&gt;142.0, &quot;avg&quot;=&gt;72.0}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="169">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can correctly compute unfiltered statistics&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">      expected[&quot;metadata&quot;][&quot;total&quot;] = 2</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">      result = DataMagic.search({city: &quot;Springfield&quot;}, command: &#39;stats&#39;, fields: [&quot;age&quot;, &quot;height&quot;, &quot;address&quot;])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="172">
          <span class="hits">1</span>
          
          <code class="ruby">      result[&quot;results&quot;] = result[&quot;results&quot;].sort_by { |k| k[&quot;age&quot;] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="174">
          <span class="hits">1</span>
          
          <code class="ruby">      expected[&quot;results&quot;] = []</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby">      expected[&quot;aggregations&quot;] = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">        &quot;age&quot;=&gt;{</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">          &quot;count&quot;=&gt;2, &quot;min&quot;=&gt;14.0, &quot;max&quot;=&gt;70.0, &quot;avg&quot;=&gt;42.0, &quot;sum&quot;=&gt;84.0, &quot;sum_of_squares&quot;=&gt;5096.0, &quot;variance&quot;=&gt;784.0, &quot;std_deviation&quot;=&gt;28.0, &quot;std_deviation_bounds&quot;=&gt;{&quot;upper&quot;=&gt;98.0, &quot;lower&quot;=&gt;-14.0}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">        &quot;height&quot;=&gt;{</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">          &quot;count&quot;=&gt;2, &quot;min&quot;=&gt;2.0, &quot;max&quot;=&gt;142.0, &quot;avg&quot;=&gt;72.0, &quot;sum&quot;=&gt;144.0, &quot;sum_of_squares&quot;=&gt;20168.0, &quot;variance&quot;=&gt;4900.0, &quot;std_deviation&quot;=&gt;70.0, &quot;std_deviation_bounds&quot;=&gt;{&quot;upper&quot;=&gt;212.0, &quot;lower&quot;=&gt;-68.0}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="183">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result[&quot;age&quot;]).to eq(expected[&quot;age&quot;])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="184">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result[&quot;height&quot;]).to eq(expected[&quot;height&quot;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="188">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;with geolocation&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="189">
          <span class="hits">1</span>
          
          <code class="ruby">    before (:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/geo_no_files&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.init(load_now: false)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;ALLOW_MISSING_YML&#39;] = &#39;allow&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">      options = {}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="194">
          <span class="hits">1</span>
          
          <code class="ruby">      options[:fields] = {lat: &#39;location.lat&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">                          lon: &#39;location.lon&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">                          city: &#39;city&#39;}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="197">
          <span class="hits">1</span>
          
          <code class="ruby">      num_rows, fields = DataMagic.import_csv(geo_data, options)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">    after(:all) do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="200">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="201">
          <span class="hits">1</span>
          
          <code class="ruby">      ENV[&#39;ALLOW_MISSING_YML&#39;] = &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="204">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;#search can find an attribute&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="205">
          <span class="hits">1</span>
          
          <code class="ruby">      sfo_location = { lat: 37.615223, lon: -122.389977 }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="206">
          <span class="hits">1</span>
          
          <code class="ruby">      DataMagic.logger.debug &quot;sfo_location[:lat] #{sfo_location[:lat].class} #{sfo_location[:lat].inspect}&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="207">
          <span class="hits">1</span>
          
          <code class="ruby">      search_options = { distance: &quot;100mi&quot;, zip: &quot;94102&quot; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="208">
          <span class="hits">1</span>
          
          <code class="ruby">      result = DataMagic.search({}, search_options)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="209">
          <span class="hits">3</span>
          
          <code class="ruby">      result[&quot;results&quot;] = result[&quot;results&quot;].sort_by { |k| k[&quot;city&quot;] }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="210">
          <span class="hits">1</span>
          
          <code class="ruby">      expected[&quot;results&quot;] = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">        { &quot;city&quot; =&gt; &quot;San Francisco&quot;, &quot;location&quot; =&gt; { &quot;lat&quot; =&gt; 37.727239, &quot;lon&quot; =&gt; -123.032229 } },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">        { &quot;city&quot; =&gt; &quot;San Jose&quot;,      &quot;location&quot; =&gt; { &quot;lat&quot; =&gt; 37.296867, &quot;lon&quot; =&gt; -121.819306 } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">      ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="214">
          <span class="hits">1</span>
          
          <code class="ruby">      expected[&#39;metadata&#39;][&quot;total&quot;] = expected[&quot;results&quot;].length</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="215">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">    describe &quot;with dictionary&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="219">
          <span class="hits">1</span>
          
          <code class="ruby">      before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="220">
          <span class="hits">1</span>
          
          <code class="ruby">        DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="221">
          <span class="hits">1</span>
          
          <code class="ruby">        ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/import_with_dictionary&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="222">
          <span class="hits">1</span>
          
          <code class="ruby">        DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="225">
          <span class="hits">1</span>
          
          <code class="ruby">      it &quot;#search with a fields filter can return location.lat and location.lon values&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="226">
          <span class="hits">1</span>
          
          <code class="ruby">        chicago_location = { latitude: &quot;41.837551&quot;, longitude: &quot;-87.681844&quot; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="227">
          <span class="hits">1</span>
          
          <code class="ruby">        DataMagic.logger.debug &quot;sfo_location[:latitude] #{chicago_location[:latitude].class} #{chicago_location[:latitude].inspect}&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">        response = DataMagic.search({name: &quot;Chicago&quot;}, {:fields =&gt; [&quot;latitude&quot;, &quot;longitude&quot;]})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="229">
          <span class="hits">1</span>
          
          <code class="ruby">        result = response[&quot;results&quot;][0]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="230">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result.keys.length).to eq(2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="231">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result).to include(&quot;latitude&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="232">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result).to include(&quot;latitude&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result[&quot;latitude&quot;]).to eq chicago_location[:latitude]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="234">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result[&quot;longitude&quot;]).to eq chicago_location[:longitude]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="239">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;with sample-data&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="240">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="241">
          <span class="hits">2</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;./sample-data&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="242">
          <span class="hits">2</span>
          
          <code class="ruby">      DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="244">
          <span class="hits">1</span>
          
          <code class="ruby">    after do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="245">
          <span class="hits">2</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="248">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can sort&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="249">
          <span class="hits">1</span>
          
          <code class="ruby">      response = DataMagic.search({}, sort: &quot;population:asc&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="250">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(response[&quot;results&quot;][0][&#39;name&#39;]).to eq(&quot;Rochester&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="253">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can match a field on several given integer values&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="254">
          <span class="hits">1</span>
          
          <code class="ruby">      response = DataMagic.search({population: &quot;8175133,3792621,2695598,&quot;}, sort: &quot;population:desc&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="255">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(response[&quot;results&quot;].length).to eq(3)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="256">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(response[&quot;results&quot;][0][&#39;name&#39;]).to eq(&quot;New York&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="257">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(response[&quot;results&quot;][1][&#39;name&#39;]).to eq(&quot;Los Angeles&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="258">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(response[&quot;results&quot;][2][&#39;name&#39;]).to eq(&quot;Chicago&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="262">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;with null fields in the data&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="263">
          <span class="hits">1</span>
          
          <code class="ruby">    before :example do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="264">
          <span class="hits">3</span>
          
          <code class="ruby">      ENV[&#39;DATA_PATH&#39;] = &#39;./spec/fixtures/nested_files&#39;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="265">
          <span class="hits">3</span>
          
          <code class="ruby">      DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="268">
          <span class="hits">1</span>
          
          <code class="ruby">    after :example do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="269">
          <span class="hits">3</span>
          
          <code class="ruby">      DataMagic.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="272">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;with a fields filter containing NULL fields&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="273">
          <span class="hits">1</span>
          
          <code class="ruby">      it &quot;should include the NULL fields&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="274">
          <span class="hits">1</span>
          
          <code class="ruby">        response = DataMagic.search({id: &quot;11&quot;}, {:fields =&gt; [&quot;name&quot;, &quot;state&quot;]})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="275">
          <span class="hits">1</span>
          
          <code class="ruby">        result = response[&quot;results&quot;][0]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="276">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result.keys.length).to eq(2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="277">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result).to include(&quot;state&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="278">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result[&quot;state&quot;]).to be_nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="281">
          <span class="hits">1</span>
          
          <code class="ruby">      it &quot;should include nested NULL fields&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="282">
          <span class="hits">1</span>
          
          <code class="ruby">        response = DataMagic.search({id: &quot;11&quot;}, {:fields =&gt; [&quot;2012.sat_average&quot;]})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="283">
          <span class="hits">1</span>
          
          <code class="ruby">        result = response[&quot;results&quot;][0]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="284">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result.keys.length).to eq(1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="285">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result).to include(&quot;2012.sat_average&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="286">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result[&quot;2012.sat_average&quot;]).to be_nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="290">
          <span class="hits">1</span>
          
          <code class="ruby">    context &quot;without a fields filter&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="291">
          <span class="hits">1</span>
          
          <code class="ruby">      it &quot;should include NULL fields&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="292">
          <span class="hits">1</span>
          
          <code class="ruby">        response = DataMagic.search({id: &quot;11&quot;})</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="293">
          <span class="hits">1</span>
          
          <code class="ruby">        result = response[&quot;results&quot;][0]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="294">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result).to include(&quot;state&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="295">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(result[&quot;2012&quot;]).to include(&quot;sat_average&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9a2af29fc7ecc6b7cc1103c8fd5a206317049547">
  <div class="header">
    <h3>spec/lib/data_magic_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>14</b> relevant lines. 
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;spec_helper&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;data_magic&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fixtures/data.rb&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">describe DataMagic do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;cleans up after itself&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    DataMagic.init(load_now: true)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    DataMagic.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    DataMagic.logger.info &quot;just destroyed&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    #expect(DataMagic.client.indices.get(index: &#39;_all&#39;)).to be_empty</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &#39;.es_field_types&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    it &#39;returns the given fields with their specified type&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(described_class.es_field_types({ &#39;state&#39; =&gt; &#39;string&#39;, land_area: &#39;string&#39; }))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      .to eq(&quot;state&quot; =&gt; { :type =&gt; &quot;string&quot; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">          :land_area =&gt; { :type =&gt; &quot;string&quot; })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    context &#39;with custom type &quot;literal&quot;&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      it &#39;returns string type with :index of &quot;not_analyzed&quot;&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">        expect(described_class.es_field_types({ &#39;state&#39; =&gt; &#39;string&#39;, &#39;name&#39; =&gt; &#39;literal&#39; }))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">        .to eq({&quot;state&quot;=&gt;{:type=&gt;&quot;string&quot;}, &quot;name&quot;=&gt;{:type=&gt;&quot;string&quot;, :index=&gt;&quot;not_analyzed&quot;}})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a20fab4f62864089502396cef26d4dbeae03e175">
  <div class="header">
    <h3>spec/lib/expression/eval_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>20</b> relevant lines. 
      <span class="green"><b>20</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;expression/parser&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;expression/eval&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">describe Expression::Eval do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="6">
          <span class="hits">7</span>
          
          <code class="ruby">  let(:parser) { Expression::Parser.new }</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="7">
          <span class="hits">7</span>
          
          <code class="ruby">  let(:eval) { Expression::Eval.new }</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="8">
          <span class="hits">7</span>
          
          <code class="ruby">  let(:values) {{ &#39;f&#39; =&gt; 0, &#39;t&#39; =&gt; 1 }}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;simple &#39;or&#39;&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      eval.apply(parser.parse(&#39;t or f&#39;), variables: values)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    ).to eq(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;simple &#39;and&#39;&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;true and false&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        eval.apply(parser.parse(&#39;t and f&#39;), variables: values)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      ).to eq(0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;false and true&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        eval.apply(parser.parse(&#39;f and t&#39;), variables: values)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      ).to eq(0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;multiple operands&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      eval.apply(parser.parse(&#39;f or f or t&#39;), variables: values)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    ).to eq(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;parens&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;nested &#39;or&#39;&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        eval.apply(parser.parse(&#39;(f or t) and t&#39;), variables: values)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      ).to eq(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;nested &#39;and&#39;&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">        eval.apply(parser.parse(&#39;(f and t) or f&#39;), variables: values)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      ).to eq(0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="bac0faaf696059efcc5db4def53696ba509044dc">
  <div class="header">
    <h3>spec/lib/expression/parser_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>19</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;expression/parser&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">describe Expression::Parser do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="5">
          <span class="hits">8</span>
          
          <code class="ruby">  let(:parser) { Expression::Parser.new }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &#39;vars&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;parses one&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(parser.parse(&#39;one&#39;)).to eq(var: &#39;one&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;preserves case &quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(parser.parse(&#39;ONe&#39;)).to eq(var: &#39;ONe&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;consumes trailing white space&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(parser.parse(&#39;one    &#39;)).to eq(var: &#39;one&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;parses or expression&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(parser.parse(&#39;apples or oranges&#39;)).to eq(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      {or: {left: {var: &quot;apples&quot;}, right: {var: &quot;oranges&quot;}}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;parses and expression&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(parser.parse(&#39;apples and oranges&#39;)).to eq(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      {and: {left: {var: &quot;apples&quot;}, right: {var: &quot;oranges&quot;}}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &quot;parens&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;nested &#39;or&#39;&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(parser.parse(&#39;(apples or cranberries) and nuts&#39;)).to eq(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        {:and =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">          :left=&gt;{:or=&gt;{:left=&gt;{:var=&gt;&quot;apples&quot;}, :right=&gt;{:var=&gt;&quot;cranberries&quot;}}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">          :right=&gt;{:var=&gt;&quot;nuts&quot;}}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;nested &#39;and&#39;&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(parser.parse(&#39;(nuts and cranberries) or apples&#39;)).to eq(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">        { or: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">          left: { and: { left: {var: &quot;nuts&quot;}, right: {var:&quot;cranberries&quot;}}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">          right: { var: &quot;apples&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="4d2e47f79f36647cf03c56ffd1ff8d6ade65ae18">
  <div class="header">
    <h3>spec/lib/expression/variables_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>11</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;expression/parser&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;expression/variables&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">describe Expression::Variables do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="6">
          <span class="hits">4</span>
          
          <code class="ruby">  let(:parser) { Expression::Parser.new }</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="7">
          <span class="hits">4</span>
          
          <code class="ruby">  let(:variables) { Expression::Variables.new }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;gets one variable name&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(variables.apply(parser.parse(&#39;one&#39;))).to eq([&#39;one&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;preserves case &quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(variables.apply(parser.parse(&#39;ONe&#39;))).to eq([&#39;ONe&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;multiple variables&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(variables.apply(parser.parse(&#39;fox or cow or goat&#39;))).to eq(%w[fox cow goat])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="fb15b53c804ff9c793ff43bf6053e35ec1f833b4">
  <div class="header">
    <h3>spec/lib/expression_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>38</b> relevant lines. 
      <span class="green"><b>38</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;expression/expression&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">describe Expression do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;simple or expression&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can find variables&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">      expr = &quot;ONE or TWO&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(Expression.new(expr).variables).to eq(%w(ONE TWO))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;evaluates: 0 OR 1 to be 1&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">      expr = &quot;f or t&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">      values = {f:0, t:1}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(Expression.new(expr).evaluate(values)).to eq(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;evaluates: 1 OR 0 to be 1&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      expr = &quot;t or f&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      values = {f:0, t:1}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(Expression.new(expr).evaluate(values)).to eq(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;evaluates: 0 OR 0 to be 0&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">      expr = &quot;f1 or f2&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">      values = {f1:0, f2:0}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(Expression.new(expr).evaluate(values)).to eq(0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;evaluates: 1 OR 1 to be 1&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">      expr = &quot;t1 or t2&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">      values = {t1:1, t2:1}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(Expression.new(expr).evaluate(values)).to eq(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;evaluates: 1 OR nil to be 1&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">      expr = &quot;t1 or t2&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">      values = {t1:1, t2:nil}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(Expression.new(expr).evaluate(values)).to eq(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;evaluates: 0 OR nil to be nil&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      expr = &quot;t1 or t2&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">      values = {t1:0, t2:nil}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(Expression.new(expr).evaluate(values)).to eq(nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;evaluates: nil OR 0 to be 0&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">      expr = &quot;t1 or t2&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">      values = {t1:nil, t2:0}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(Expression.new(expr).evaluate(values)).to eq(0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;evaluates: nil OR nil to be nil&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">      expr = &quot;t1 or t2&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">      values = {t1:nil, t2:nil}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(Expression.new(expr).evaluate(values)).to eq(nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d01aed90f68fb150de92ef19e4ff4c654089e26f">
  <div class="header">
    <h3>spec/lib/nested_hash_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>34</b> relevant lines. 
      <span class="green"><b>34</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;nested_hash&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">describe NestedHash do</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="4">
          <span class="hits">7</span>
          
          <code class="ruby">  let(:input) { {&quot;loc.x&quot; =&gt; 1, &quot;loc.y&quot; =&gt; 2, &quot;foo.a&quot; =&gt; 10, &quot;foo.b&quot; =&gt; 20, &quot;foo.c.baz&quot; =&gt; 3,}}</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="5">
          <span class="hits">4</span>
          
          <code class="ruby">  let(:expected) {{&quot;loc&quot; =&gt; {&quot;x&quot; =&gt; 1, &quot;y&quot; =&gt; 2}, &quot;foo&quot; =&gt; {&quot;a&quot; =&gt; 10, &quot;b&quot; =&gt; 20, &quot;c&quot; =&gt; { &quot;baz&quot; =&gt; 3}}}}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="6">
          <span class="hits">2</span>
          
          <code class="ruby">  let(:expected_updated) {{&quot;loc&quot; =&gt; {&quot;x&quot; =&gt; 1, &quot;y&quot; =&gt; 2}, &quot;foo&quot; =&gt; {&quot;a&quot; =&gt; 10, &quot;b&quot; =&gt; 20, &quot;c&quot; =&gt; { &quot;baz&quot; =&gt; &quot;buzz&quot;}}}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="8">
          <span class="hits">2</span>
          
          <code class="ruby">  let(:symbol_keys) { {x:1, y:2}}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="9">
          <span class="hits">2</span>
          
          <code class="ruby">  let(:symbol_keys_result) { {&#39;x&#39; =&gt; 1, &#39;y&#39; =&gt; 2}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;.add created nested hash elements for string keys with &#39;.&#39;&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    result = NestedHash.new.add(input)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(result).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;does no harm when initialized with an already nested hash&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(NestedHash.new(expected)).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;methods&quot; do</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="22">
          <span class="hits">6</span>
          
          <code class="ruby">    let (:result) { NestedHash.new(input) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can initialize with another Hash&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can generate dotkeys&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result.dotkeys.sort).to eq(input.keys.sort)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;withdotkeys generates keys with &#39;.&#39;&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result.withdotkeys).to eq(input)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;dotkeys and withdotkeys have same order&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result.withdotkeys.keys).to eq(result.dotkeys)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;can set a nested key&#39;s value by a dotted-string&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">      result.dotkey_set(&#39;foo.c.baz&#39;, &#39;buzz&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result).to eq(expected_updated)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;turns symbol keys into simple strings&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    result = NestedHash.new.add(symbol_keys)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(result).to eq(symbol_keys_result)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  context &quot;deeply nested&quot; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="52">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:input) { {&quot;info.loc.x&quot; =&gt; 0.11, &quot;info.loc.y&quot; =&gt; 0.222, &quot;foo.a&quot; =&gt; 10, &quot;foo.b&quot; =&gt; 20}}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="53">
          <span class="hits">2</span>
          
          <code class="ruby">    let(:expected) { {&quot;info&quot; =&gt; {&quot;loc&quot; =&gt; {&quot;x&quot; =&gt; 0.11, &quot;y&quot; =&gt; 0.222}}, &quot;foo&quot; =&gt; {&quot;a&quot; =&gt; 10, &quot;b&quot; =&gt; 20}}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;creates nested hash elements for string keys with &#39;.&#39;&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">      result = NestedHash.new.add(input)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(result).to eq(expected)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="538c359bded5e883c1e33bcac0d099d02800ad1c">
  <div class="header">
    <h3>spec/lib/zipcode_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>13</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;zipcode/zipcode&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">describe Zipcode do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;gives a location based on zipcode&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    location = Zipcode.latlon(&#39;94132&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(location).to eq(lat: 37.7211, lon: -122.4754)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  it &quot;supports zipcode given as a number&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    location = Zipcode.latlon(94132)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    expect(location).to eq(lat: 37.7211, lon: -122.4754)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  describe &#39;#valid&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;returns true if the zipcode is valid&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(Zipcode.valid? 94132).to eq(true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    it &quot;returns false if the zipcode is invalid&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      expect(Zipcode.valid? 00002).to eq(false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
      </div>
    </div>
  </body>
</html>
